<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Queensgate Bouldering • Financial Model</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    color-scheme: light dark;
    --gold:#fce38b;
    --salmon:#df7d6e;
    --blue:#6ba0cc;
    --ink:#101418;
    --paper:#f8fafc;
  }
  @media (prefers-color-scheme:dark){
    :root{ --paper:#0b0b0c; --ink:#e6e6e6; }
  }

  html,body{
    margin:0; background:var(--paper); color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  }

  /* Sticky header from Code A */
  header{
    position:sticky;
    top:0;
    z-index:10;
    background:rgba(255,255,255,.97);
    border-bottom:2px solid var(--gold);
    backdrop-filter:saturate(1.1) blur(6px);
  }
  @media(prefers-color-scheme:dark){
    header{ background:rgba(16,16,16,.97); }
  }

  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:26px;font-weight:900}

  .toggle-row{
    display:flex;gap:12px;align-items:center;
    flex-wrap:wrap;margin-top:8px
  }

  .switch{display:flex;align-items:center;gap:8px;font-weight:800}
  .switch input{
    appearance:none;width:46px;height:26px;border-radius:999px;
    background:#cbd5e1;position:relative;cursor:pointer;
    border:2px solid #93a3b8
  }
  .switch input:checked{
    background:var(--gold);border-color:var(--gold)
  }
  .switch input::after{
    content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;
    border-radius:50%;background:#fff;transition:left .18s ease
  }
  .switch input:checked::after{left:24px}

  .card{
    background:#fff;border:2px solid #e5e7eb;
    border-radius:16px;padding:18px;margin-top:16px;
  }
  @media(prefers-color-scheme:dark){
    .card{background:#121416;border-color:#222}
  }

  .row{display:grid;gap:12px}
  @media(min-width:900px){
    .row.cols-3{grid-template-columns:repeat(3,1fr)}
  }

  .kpi{font-size:30px;font-weight:900}
  .mono{font-variant-numeric:tabular-nums}

  .drivers input{
    width:100%;padding:8px;
    border-radius:10px;border:2px solid var(--blue);
    background:#fff;font-weight:800;
  }

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th{text-align:left;font-size:12px;opacity:.7;padding:6px 0}
  td{padding:8px 0;border-top:1px solid #e5e7eb}
  @media(prefers-color-scheme:dark){
    td{border-color:#222}
  }
</style>
</head>

<body>

<header>
  <div class="wrap">
    <h1>Queensgate Bouldering • Financial Model</h1>
    <div class="toggle-row">
      <label class="switch">
        <input type="checkbox" id="yearToggle">
        <span>Use Year 1</span>
      </label>
    </div>
  </div>
</header>

<main class="wrap" style="padding-bottom:40px">

  <!-- KPIs -->
  <section class="row cols-3">
    <div class="card">
      <div class="kpi mono" id="kpiEbitda">£0</div>
      <div>EBITDA</div>
    </div>
    <div class="card">
      <div class="kpi mono" id="kpiDebt">£0</div>
      <div>Annual debt service</div>
    </div>
    <div class="card">
      <div class="kpi mono" id="kpiDscr">n/a</div>
      <div>Cover ratio</div>
    </div>
  </section>

  <!-- Revenue Drivers -->
  <section class="card">
    <h2>Revenue drivers</h2>
    <div class="row cols-3 drivers" style="margin-top:12px">
      <div>
        <label>Members per month</label>
        <input id="drvMembers" type="number">
      </div>
      <div>
        <label>Member price</label>
        <input id="drvMemberPrice" type="number">
      </div>
      <div>
        <label>Day passes</label>
        <input id="drvDayPasses" type="number">
      </div>
      <div>
        <label>Day pass price</label>
        <input id="drvDayPrice" type="number">
      </div>
      <div>
        <label>Other revenue</label>
        <input id="drvOther" type="number">
      </div>
    </div>
  </section>

  <!-- Loan -->
  <section class="card">
    <h2>Loan</h2>
    <div class="row cols-3">
      <div>
        <label>Loan amount</label>
        <input id="loanAmount" type="number" value="350000">
      </div>
      <div>
        <label>Interest rate percent</label>
        <input id="loanRate" type="number" value="7">
      </div>
      <div>
        <label>Term years</label>
        <input id="loanYears" type="number" value="7">
      </div>
    </div>
  </section>

  <!-- Detailed Table -->
  <section class="card">
    <h2>Detailed view</h2>
    <div id="tableContainer"></div>
  </section>

</main>


<script>
let rows = [];
let bySection = {};
let useYear1 = false;

const money = n => "£" + Number(n).toLocaleString("en-GB",{maximumFractionDigits:0});
const num = v => parseFloat(String(v).replace(/[£,]/g,"")) || 0;

function group(){
  bySection = {};
  rows.forEach(r=>{
    const sec = r["SECTION TITLE"] || "Other";
    if (!bySection[sec]) bySection[sec] = [];
    bySection[sec].push(r);
  });
}

function value(row){
  return useYear1 ? num(row["Year 1"]) : num(row["Year 2"]);
}

function sectionTotal(sec){
  return (bySection[sec]||[]).reduce((a,r)=>a + value(r),0);
}

function readRevenue(){
  const revSec = bySection["Revenue"] || bySection["REVENUE"] || [];
  const find = name => {
    const row = revSec.find(r => r["DESCRIPTION"]?.toUpperCase()===name);
    return row ? value(row) : 0;
  };

  return {
    members: find("MEMBERS"),
    memberPrice: find("MEMBER PRICE"),
    dayPasses: find("DAY PASSES"),
    dayPrice: find("DAY PASS PRICE"),
    other: find("OTHER")
  };
}

function computeRevenue(drivers){
  return (drivers.members*drivers.memberPrice + drivers.dayPasses*drivers.dayPrice + drivers.other) * 12;
}

function annualDebtService(P, rate, years){
  const r = rate/100/12;
  const n = years*12;
  if (r===0) return P/years;
  const m = P * r / (1 - Math.pow(1+r, -n));
  return m*12;
}

function render(){
  const revCsv = readRevenue();

  const drivers = {
    members: num(document.getElementById("drvMembers").value || revCsv.members),
    memberPrice: num(document.getElementById("drvMemberPrice").value || revCsv.memberPrice),
    dayPasses: num(document.getElementById("drvDayPasses").value || revCsv.dayPasses),
    dayPrice: num(document.getElementById("drvDayPrice").value || revCsv.dayPrice),
    other: num(document.getElementById("drvOther").value || revCsv.other),
  };

  const revenue = computeRevenue(drivers);

  const operating = Object.keys(bySection)
    .filter(s => s.toUpperCase()!=="REVENUE" && !s.toUpperCase().includes("CAPEX"))
    .reduce((a,s)=>a + sectionTotal(s),0);

  const ebitda = revenue - operating;

  const capex = Object.keys(bySection)
    .filter(s => s.toUpperCase().includes("CAPEX"))
    .reduce((a,s)=>a + sectionTotal(s),0);

  const loan = num(document.getElementById("loanAmount").value);
  const rate = num(document.getElementById("loanRate").value);
  const years = num(document.getElementById("loanYears").value);

  const debt = annualDebtService(loan, rate, years);
  const dscr = debt>0 ? ebitda/debt : NaN;

  document.getElementById("kpiEbitda").textContent = money(ebitda);
  document.getElementById("kpiDebt").textContent = money(debt);
  document.getElementById("kpiDscr").textContent = isFinite(dscr) ? dscr.toFixed(2) : "n/a";

  /* Table */
  let html = `<table><thead>
    <tr><th>Item</th><th>Value</th></tr>
  </thead><tbody>`;

  Object.keys(bySection).forEach(sec=>{
    html += `<tr><td colspan="2" style="font-weight:900;padding-top:14px">${sec}</td></tr>`;
    bySection[sec].forEach(r=>{
      html += `<tr>
        <td>${r["DESCRIPTION"]}</td>
        <td class="mono">${money(value(r))}</td>
      </tr>`;
    });
  });

  html += `</tbody></table>`;
  document.getElementById("tableContainer").innerHTML = html;
}

document.getElementById("yearToggle").addEventListener("change", e=>{
  useYear1 = e.target.checked;
  render();
});

["drvMembers","drvMemberPrice","drvDayPasses","drvDayPrice","drvOther",
 "loanAmount","loanRate","loanYears"]
.forEach(id=>{
  document.getElementById(id).addEventListener("input", render);
});

Papa.parse("./queensgate_bouldering_model.csv",{
  download:true,
  header:true,
  complete:res=>{
    rows = res.data;
    group();
    render();
  }
});
</script>

</body>
</html>
