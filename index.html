<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Queensgate Bouldering Centre â€” Financial Model</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:#f5f7fa;color:#2c3e50;padding:20px}
  .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);overflow:hidden}
  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px}
  .header h1{font-size:2em;margin-bottom:8px}
  .header p{opacity:.95}

  /* Scenario toggles and alerts */
  .content{padding:28px}
  .scenario-buttons{display:flex;gap:10px;margin:16px 0 22px;flex-wrap:wrap}
  .scenario-btn{padding:10px 20px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:8px;cursor:pointer;font-weight:600;min-height:44px}
  .scenario-btn.active,.scenario-btn[aria-pressed="true"]{background:#667eea;color:#fff;box-shadow:0 0 0 2px #667eea22 inset}
  .note{font-size:.9em;color:#666;margin:8px 0 0}

  /* Key metrics */
  .key-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin:10px 0 26px;padding:18px;background:#f8f9fa;border-radius:10px}
  .metric{text-align:center}
  .metric-value{font-size:1.6em;font-weight:700;color:#667eea}
  .metric-label{font-size:.9em;color:#666;margin-top:5px}
  .positive{color:#27ae60}
  .negative{color:#e74c3c}

  /* Assumptions block */
  .assumptions{background:#fff9e6;border:1px solid #ffeb3b;border-radius:12px;padding:18px 18px 6px;margin:6px 0 24px}
  .assumptions h3{color:#f39c12;margin:0 0 10px}
  .assumption-columns{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  .assumption-group{background:#fff;border:1px solid #f1e4b5;border-radius:10px;overflow:hidden}
  .assumption-group-header{background:#fff4cc;padding:10px 14px;border-bottom:1px solid #f1e4b5;font-weight:700}
  .assumption-grid{display:grid;grid-template-columns:1fr;gap:10px;padding:14px}
  .assumption-item{display:flex;flex-direction:column;gap:6px}
  .assumption-item label{font-size:.9em;color:#555;text-align:left}
  .assumption-item small{color:#999}
  .assumption-item input,.assumption-item select{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:16px;text-align:right}

  /* Summary table (kept) */
  .summary-table{background:#f8f9fa;border-radius:10px;padding:20px;margin-top:8px}
  .summary-table h3{margin-bottom:12px}
  .summary-row{display:grid;grid-template-columns:1fr 220px;gap:20px;padding:12px 0;border-bottom:1px solid #e0e0e0}
  .summary-row:last-child{border-bottom:none;font-weight:700;font-size:1.05em}

  /* Sources, methods and validation */
  .talking-points{background:#eef7ff;border:1px solid #b6d7ff;border-radius:12px;padding:18px;margin:22px 0 4px}
  .talking-points h3{color:#214c8f;margin:0 0 10px}
  .method{background:#fff;border:1px solid #dfe8f7;border-radius:10px;padding:14px;margin-top:10px}
  .method h4{margin:0 0 8px;color:#214c8f}
  .refs{margin-top:10px}
  .refs .row{display:grid;grid-template-columns:240px 1fr;gap:12px;align-items:center;padding:8px 0;border-bottom:1px dashed #e5eefc}
  .refs .row:last-child{border-bottom:none}
  .refs input{padding:8px;border:1px solid #d0dcf0;border-radius:6px;font-size:14px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.95em}

  /* Grey vs black rules */
  .static-gray{color:#888 !important}
  .dynamic-black{color:#111 !important}

  @media(max-width:1024px){.assumption-columns{grid-template-columns:1fr}}
  @media(max-width:768px){
    .content{padding:16px}
    .summary-row{grid-template-columns:1fr;gap:6px}
    .key-metrics{grid-template-columns:repeat(2,1fr)}
    .scenario-btn{flex:1 1 calc(50% - 8px)}
    .refs .row{grid-template-columns:1fr}
  }
  @media(max-width:400px){.key-metrics{grid-template-columns:1fr}.scenario-btn{flex:1 1 100%}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ðŸ§— Queensgate Bouldering Centre â€” Financial Model</h1>
    <p><strong>Purpose:</strong> investor-ready summary with realistic, conservative, and optimistic scenarios. Realistic reads from your CSV.</p>
  </div>

  <div class="content">
    <div class="scenario-buttons" role="group" aria-label="Scenario">
      <button class="scenario-btn" data-scenario="conservative" aria-pressed="false">Conservative</button>
      <button class="scenario-btn" data-scenario="realistic" aria-pressed="true">Realistic</button>
      <button class="scenario-btn" data-scenario="optimistic" aria-pressed="false">Optimistic</button>
    </div>
    <div class="note">Grey fields never change across scenarios. Black fields change with the toggle.</div>

    <!-- Key metrics -->
    <div class="key-metrics">
      <div class="metric"><div class="metric-value" id="capex-exvat">Â£0</div><div class="metric-label">CAPEX ex VAT</div></div>
      <div class="metric"><div class="metric-value" id="capex-incvat">Â£0</div><div class="metric-label">CAPEX incl VAT</div></div>
      <div class="metric"><div class="metric-value" id="annual-revenue">Â£0</div><div class="metric-label">Annual Revenue</div></div>
      <div class="metric"><div class="metric-value" id="annual-profit">Â£0</div><div class="metric-label">Annual Profit (EBITDA)</div></div>
      <div class="metric"><div class="metric-value" id="roi">0%</div><div class="metric-label">ROI</div></div>
      <div class="metric"><div class="metric-value" id="payback-period">0 years</div><div class="metric-label">Payback Period</div></div>
    </div>

    <!-- Key Assumptions & Configuration -->
    <div class="assumptions">
      <h3>ðŸ”‘ Key Assumptions & Configuration</h3>
      <div class="assumption-columns">
        <!-- CAPEX -->
        <div class="assumption-group">
          <div class="assumption-group-header">Setup costs (CAPEX)</div>
          <div class="assumption-grid">
            <div class="assumption-item">
              <label>Climbing Construction (Â£) <small>Walls, matting, equipment, holds</small></label>
              <input type="text" id="capex-climbing" value="300,000" onchange="calculateAll()">
            </div>
            <div class="assumption-item">
              <label>General Construction (Â£) <small>Cafe, bar, reception areas</small></label>
              <input type="text" id="capex-general" value="150,000" onchange="calculateAll()">
            </div>
            <div class="assumption-item">
              <label>Facilities Construction (Â£) <small>Dry changing rooms, toilets</small></label>
              <input type="text" id="capex-facilities" value="30,000" onchange="calculateAll()">
            </div>
            <div class="assumption-item">
              <label>Software, Licences, Permits (Â£)</label>
              <input type="text" id="capex-software" value="8,000" onchange="calculateAll()">
            </div>
            <div class="assumption-item">
              <label>Branding & Launch (Â£)</label>
              <input type="text" id="capex-branding" value="20,000" onchange="calculateAll()">
            </div>
            <div class="assumption-item">
              <label>VAT Rate (%)</label>
              <input type="text" id="vat-rate" value="20" onchange="calculateAll()">
            </div>
            <div class="assumption-item">
              <label>VAT Reclaimable?</label>
              <select id="vat-reclaimable" onchange="calculateAll()">
                <option value="yes" selected>Yes</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>
        </div>

        <!-- OPEX -->
        <div class="assumption-group">
          <div class="assumption-group-header">Operating costs (OPEX)</div>
          <div class="assumption-grid">
            <div class="assumption-item"><label>Annual Rent (Â£)</label><input type="text" id="annual-rent" value="56,000" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Business Rates (Â£)</label><input type="text" id="business-rates" value="35,000" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Centre Manager (Â£)</label><input type="text" id="manager-salary" value="36,000" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Route Setting (Â£)</label><input type="text" id="route-setter-salary" value="26,000" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Other Staff (Â£)</label><input type="text" id="other-staff" value="50,000" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Utilities (Â£)</label><input type="text" id="utilities" value="24,000" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Insurance (Â£)</label><input type="text" id="insurance" value="3,000" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Marketing (Â£)</label><input type="text" id="marketing-annual" value="12,000" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Maintenance & Holds Refresh (Â£)</label><input type="text" id="maintenance" value="10,000" onchange="calculateAll()"></div>
          </div>
        </div>

        <!-- Revenue -->
        <div class="assumption-group">
          <div class="assumption-group-header">Revenue</div>
          <div class="assumption-grid">
            <div class="assumption-item"><label>Monthly Membership (Â£)</label><input type="text" id="membership-price" value="70" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Total Members</label><input type="text" id="members-count" value="450" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Day Pass Price (Â£)</label><input type="text" id="day-pass-price" value="14" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Day Passes / Month</label><input type="text" id="day-passes-monthly" value="600" onchange="calculateAll()"></div>

            <details>
              <summary style="text-align:left;cursor:pointer;color:#555">Advanced revenue inputs</summary>
              <div class="assumption-grid" style="margin-top:10px">
                <div class="assumption-item"><label>Coaching sessions / month</label><input type="text" id="coaching-sessions" value="40" onchange="calculateAll()"></div>
                <div class="assumption-item"><label>Coaching price (Â£)</label><input type="text" id="coaching-price" value="55" onchange="calculateAll()"></div>
                <div class="assumption-item"><label>Parties per month</label><input type="text" id="parties-monthly" value="12" onchange="calculateAll()"></div>
                <div class="assumption-item"><label>Party revenue (Â£)</label><input type="text" id="party-revenue" value="150" onchange="calculateAll()"></div>
                <div class="assumption-item"><label>Equipment rental net (Â£/mo)</label><input type="text" id="rental-monthly" value="800" onchange="calculateAll()"></div>
                <div class="assumption-item"><label>Retail net (Â£/mo)</label><input type="text" id="retail-monthly" value="1,200" onchange="calculateAll()"></div>
                <div class="assumption-item"><label>Cafe GMV (Â£/mo)</label><input type="text" id="cafe-monthly" value="4,000" onchange="calculateAll()"></div>
                <div class="assumption-item"><label>Cafe net margin (%)</label><input type="text" id="cafe-margin" value="8" onchange="calculateAll()"></div>
              </div>
            </details>
          </div>
        </div>
      </div>

      <div class="scenario-buttons" role="group" aria-label="Scenario bottom">
        <button class="scenario-btn" data-scenario="conservative" aria-pressed="false">Conservative</button>
        <button class="scenario-btn" data-scenario="realistic" aria-pressed="true">Realistic</button>
        <button class="scenario-btn" data-scenario="optimistic" aria-pressed="false">Optimistic</button>
      </div>
      <div class="note">Scenario math and sources explained below.</div>
    </div>

    <!-- Financial Summary -->
    <div class="summary-table">
      <h3>ðŸ“Š Annual Financial Performance</h3>
      <div class="summary-row"><div>Total Annual Revenue</div><div id="annual-revenue-summary">Â£0</div></div>
      <div class="summary-row"><div>Total Annual Expenses</div><div id="annual-expenses-summary">Â£0</div></div>
      <div class="summary-row"><div>Annual Profit (EBITDA)</div><div id="annual-ebitda" class="negative">Â£0</div></div>
      <div class="summary-row"><div>Profit Margin</div><div id="annual-margin">0%</div></div>
      <div class="summary-row"><div>ROI (basis shown)</div><div id="roi-summary">0%</div></div>
      <div class="summary-row"><div>Payback Period</div><div id="payback-summary">0 years</div></div>
    </div>

    <!-- Sources & Methodology -->
    <div class="talking-points">
      <h3>ðŸ“š Sources, Methods & Validation</h3>

      <div class="method">
        <h4>Formulas</h4>
        <div class="mono">
          CAPEX ex-VAT = sum(CAPEX groups)<br/>
          CAPEX incl VAT = CAPEX ex-VAT Ã— (1 + VAT%)<br/>
          ROI basis = VAT reclaimable ? CAPEX ex-VAT : CAPEX incl VAT<br/>
          Membership revenue = Members Ã— Membership Â£ Ã— 12<br/>
          Day pass revenue = Day passes / mo Ã— Day pass Â£ Ã— 12<br/>
          Coaching revenue = Sessions / mo Ã— Â£ Ã— 12<br/>
          Parties revenue = Events / mo Ã— Â£ Ã— 12<br/>
          Rental net = Â£/mo Ã— 12; Retail net = Â£/mo Ã— 12<br/>
          Cafe net = round(Cafe GMV Ã— Margin%) Ã— 12<br/>
          Total revenue = sum(all above)<br/>
          OPEX = Rent + Business rates + Manager + Route setting + Other staff + Utilities + Insurance + Marketing + Maintenance<br/>
          EBITDA = Total revenue âˆ’ OPEX<br/>
          ROI% = round(EBITDA Ã· ROI basis Ã— 100)<br/>
          Payback (yrs) = ROI basis Ã· EBITDA
        </div>
      </div>

      <div class="method">
        <h4>Scenario methodology</h4>
        <p class="mono">
          Explicit scenario values:<br/>
          â€¢ Day pass price: 13 / 14 / 15<br/>
          â€¢ Other staff: 46,000 / 50,000 / 60,000<br/>
          â€¢ Route setting: 24,000 / 26,000 / 30,000<br/>
          â€¢ Centre manager: 34,000 / 36,000 / 38,000<br/><br/>
          Relative nudges (selected examples):<br/>
          Conservative â†’ Members Ã—0.85, Membership Â£ Ã—0.98, Day passes Ã—0.80;<br/>
          Optimistic â†’ Members Ã—1.20, Membership Â£ Ã—1.03, Day passes Ã—1.25;<br/>
          Utilities, marketing, maintenance adjusted Â± as shown in code.
        </p>
      </div>

      <div class="method">
        <h4>References & links</h4>
        <div class="refs">
          <div class="row"><div>Supplier quotes (walls, matting, mezzanine, holds)</div><input type="text" placeholder="https://drive.../walls-quote.pdf"></div>
          <div class="row"><div>General construction fitout</div><input type="text" placeholder="https://drive.../fitout-quote.pdf"></div>
          <div class="row"><div>Facilities fitout</div><input type="text" placeholder="https://drive.../facilities-quote.pdf"></div>
          <div class="row"><div>Software, POS, licences</div><input type="text" placeholder="https://.../pos-and-licences.pdf"></div>
          <div class="row"><div>Branding & launch</div><input type="text" placeholder="https://.../branding-launch.pdf"></div>
          <div class="row"><div>VAT rate (UK Gov)</div><input type="text" value="https://www.gov.uk/vat-rates"></div>
          <div class="row"><div>Business rates explainer</div><input type="text" value="https://www.gov.uk/introduction-to-business-rates"></div>
          <div class="row"><div>Benchmarks: membership/day pass pricing</div><input type="text" placeholder="Add 2â€“3 competitor links here"></div>
          <div class="row"><div>Energy/utilities basis</div><input type="text" placeholder="Add supplier/contract link or model note"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lib for CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  /* ---------- formatting ---------- */
  function toInt(raw){
    const cleaned = String(raw).replace(/[, ]+/g,'').trim();
    const x = Math.floor(Number(cleaned));
    return isFinite(x) ? x : 0;
  }
  function money(v){ const f = toInt(v); return (f < 0 ? '-Â£' : 'Â£') + Math.abs(f).toLocaleString('en-GB'); }
  function pctInt(v){ const p = Math.round(Number(v)); return isFinite(p) ? p + '%' : '0%'; }
  function formatCommas(v){ return toInt(v).toLocaleString('en-GB'); }
  function stripCommas(v){ return String(v).replace(/,/g,''); }
  function valInt(id, fallback){ const el = document.getElementById(id); return el ? toInt(el.value) : toInt(fallback); }

  /* ---------- IDs we consider in scenarios ---------- */
  const FIELD_IDS = [
    // CAPEX
    'capex-climbing','capex-general','capex-facilities','capex-software','capex-branding','vat-rate','vat-reclaimable',
    // OPEX
    'annual-rent','business-rates','manager-salary','route-setter-salary','other-staff','utilities','insurance','marketing-annual','maintenance',
    // Revenue
    'membership-price','members-count','day-pass-price','day-passes-monthly',
    'coaching-sessions','coaching-price','parties-monthly','party-revenue','rental-monthly','retail-monthly','cafe-monthly','cafe-margin'
  ];

  /* ---------- Scenario configs ---------- */
  const BASELINE = {}; // set from CSV then defaults

  // Four explicit fields must always change across scenarios
  const SCENARIO_VALUE_OVERRIDES = {
    conservative: { 'day-pass-price':13, 'other-staff':46000, 'route-setter-salary':24000, 'manager-salary':34000 },
    realistic:    { 'day-pass-price':14, 'other-staff':50000, 'route-setter-salary':26000, 'manager-salary':36000 },
    optimistic:   { 'day-pass-price':15, 'other-staff':60000, 'route-setter-salary':30000, 'manager-salary':38000 }
  };
  const SCENARIO_RELATIVE = {
    conservative: {
      'members-count': v => Math.max(0, Math.round(v*0.85)),
      'membership-price': v => Math.round(v*0.98),
      'day-passes-monthly': v => Math.max(0, Math.round(v*0.80)),
      'coaching-sessions': v => 30, 'coaching-price': v => 50,
      'parties-monthly': v => 9, 'party-revenue': v => 140,
      'rental-monthly': v => 700, 'retail-monthly': v => 1000,
      'cafe-monthly': v => 3500, 'cafe-margin': v => 8,
      'utilities': v => Math.round(v*0.96),
      'marketing-annual': v => Math.round(v*0.85),
      'maintenance': v => Math.round(v*0.90)
    },
    optimistic: {
      'members-count': v => Math.round(v*1.20),
      'membership-price': v => Math.round(v*1.03),
      'day-passes-monthly': v => Math.round(v*1.25),
      'coaching-sessions': v => 60, 'coaching-price': v => 60,
      'parties-monthly': v => 16, 'party-revenue': v => 160,
      'rental-monthly': v => 1200, 'retail-monthly': v => 1800,
      'cafe-monthly': v => 7000, 'cafe-margin': v => 9,
      'utilities': v => Math.round(v*1.10),
      'marketing-annual': v => Math.round(v*1.15),
      'maintenance': v => Math.round(v*1.15)
    }
  };

  /* ---------- Comma-friendly inputs ---------- */
  function enableCommaFormatting(){
    const sels = FIELD_IDS.map(id => '#'+id).join(',');
    document.querySelectorAll(sels).forEach(el=>{
      try{ el.type='text'; }catch(_){}
      el.value = formatCommas(el.value);
      el.addEventListener('focus',()=>{ el.value = stripCommas(el.value); el.select?.(); });
      el.addEventListener('input',()=>{ el.value = el.value.replace(/[^\d,]/g,''); });
      el.addEventListener('blur',()=>{
        el.value = stripCommas(el.value);
        el.value = String(toInt(el.value));
        el.value = formatCommas(el.value);
        calculateAll();
      });
    });
  }
  function prettifyAllInputs(){
    const sels = FIELD_IDS.map(id => '#'+id).join(',');
    document.querySelectorAll(sels).forEach(el=>{ el.value = formatCommas(el.value); });
  }

  /* ---------- Scenario invariance labelling (grey vs black) ---------- */
  function simulateScenarioValue(id, scenarioName){
    const base = BASELINE[id] != null ? BASELINE[id] : toInt(document.getElementById(id)?.value);
    const explicit = SCENARIO_VALUE_OVERRIDES[scenarioName] || {};
    if(explicit[id] != null) return toInt(explicit[id]);
    const rel = SCENARIO_RELATIVE[scenarioName] || {};
    if(typeof rel[id] === 'function') return toInt(rel[id](base));
    return toInt(base); // unchanged in that scenario
  }
  function applyStaticDynamicClasses(){
    FIELD_IDS.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const vCons = simulateScenarioValue(id,'conservative');
      const vReal = simulateScenarioValue(id,'realistic');
      const vOpt  = simulateScenarioValue(id,'optimistic');
      const invariant = (vCons === vReal) && (vReal === vOpt);
      el.classList.remove('static-gray','dynamic-black');
      el.classList.add(invariant ? 'static-gray' : 'dynamic-black');
    });
  }

  /* ---------- Maths ---------- */
  function calculateAll(){
    // CAPEX
    const capClimb = valInt('capex-climbing', 300000);
    const capGen = valInt('capex-general', 150000);
    const capFac = valInt('capex-facilities', 30000);
    const capSoft = valInt('capex-software', 8000);
    const capBrand = valInt('capex-branding', 20000);
    const capexExVat = capClimb + capGen + capFac + capSoft + capBrand;

    const vatRate = valInt('vat-rate', 20) / 100;
    const vatReclaim = String(document.getElementById('vat-reclaimable').value || '').toLowerCase()==='yes';
    const capexIncVat = Math.round(capexExVat * (1 + vatRate));
    const capexBasis = vatReclaim ? capexExVat : capexIncVat;

    document.getElementById('capex-exvat').textContent = money(capexExVat);
    document.getElementById('capex-incvat').textContent = money(capexIncVat);

    // Revenue
    const memberPrice = valInt('membership-price', 70);
    const members = valInt('members-count', 450);
    const dayPassPrice = valInt('day-pass-price', 14);
    const dayPassesPerMonth = valInt('day-passes-monthly', 600);

    const coachSessions = valInt('coaching-sessions', 40);
    const coachPrice = valInt('coaching-price', 55);
    const partiesM = valInt('parties-monthly', 12);
    const partyPrice = valInt('party-revenue', 150);
    const rentalMonthly = valInt('rental-monthly', 800);
    const retailMonthly = valInt('retail-monthly', 1200);
    const cafeMonthly = valInt('cafe-monthly', 4000);
    const cafeMargin = valInt('cafe-margin', 8) / 100;

    const membershipRevenue = members * memberPrice * 12;
    const dayPassRevenue = dayPassesPerMonth * dayPassPrice * 12;
    const coachingRevenue = coachSessions * coachPrice * 12;
    const youthRevenue = partiesM * partyPrice * 12;
    const rentalRevenue = rentalMonthly * 12;
    const retailRevenue = retailMonthly * 12;
    const cafeNetRevenue = Math.round(cafeMonthly * cafeMargin) * 12;

    const totalRevenue = membershipRevenue + dayPassRevenue + coachingRevenue + youthRevenue + rentalRevenue + retailRevenue + cafeNetRevenue;

    // OPEX
    const rent = valInt('annual-rent', 56000);
    const rates = valInt('business-rates', 35000);
    const mgr = valInt('manager-salary', 36000);
    const rs = valInt('route-setter-salary', 26000);
    const staffOther = valInt('other-staff', 50000);
    const utils = valInt('utilities', 24000);
    const ins = valInt('insurance', 3000);
    const mkt = valInt('marketing-annual', 12000);
    const maint = valInt('maintenance', 10000);

    const totalExpenses = rent + rates + mgr + rs + staffOther + utils + ins + mkt + maint;

    // EBITDA / ROI / Payback
    const ebitda = totalRevenue - totalExpenses;
    const roiPct = capexBasis > 0 ? Math.round((ebitda / capexBasis) * 100) : 0;
    const paybackYears = ebitda > 0 ? (capexBasis / ebitda) : 0;

    document.getElementById('annual-revenue').textContent = money(totalRevenue);
    document.getElementById('annual-revenue-summary').textContent = money(totalRevenue);
    document.getElementById('annual-expenses-summary').textContent = money(totalExpenses);

    document.getElementById('annual-profit').textContent = money(ebitda);
    document.getElementById('annual-profit').className = 'metric-value ' + (ebitda > 0 ? 'positive' : 'negative');
    document.getElementById('annual-ebitda').textContent = money(ebitda);
    document.getElementById('annual-ebitda').className = ebitda > 0 ? 'positive' : 'negative';
    document.getElementById('annual-margin').textContent = pctInt((ebitda / Math.max(totalRevenue,1)) * 100);
    document.getElementById('roi').textContent = pctInt(roiPct);
    document.getElementById('roi-summary').textContent = pctInt(roiPct);
    document.getElementById('payback-period').textContent = ebitda > 0 ? (Math.round(paybackYears*10)/10) + ' years' : 'N/A';
    document.getElementById('payback-summary').textContent = ebitda > 0 ? (Math.round(paybackYears*10)/10) + ' years' : 'N/A';

    prettifyAllInputs();
  }

  /* ---------- CSV load ---------- */
  async function loadRealisticFromCSVIntoBaseline(){
    // defaults as fallback
    const defaults = {
      'membership-price':70,'members-count':450,'day-pass-price':14,'day-passes-monthly':600,
      'annual-rent':56000,'business-rates':35000,'manager-salary':36000,'route-setter-salary':26000,
      'other-staff':50000,'utilities':24000,'insurance':3000,'marketing-annual':12000,'maintenance':10000,
      'capex-climbing':300000,'capex-general':150000,'capex-facilities':30000,'capex-software':8000,'capex-branding':20000,
      'vat-rate':20
    };
    Object.assign(BASELINE, defaults);

    try{
      const res = await fetch('queensgate_bouldering_provenance.csv',{cache:'no-store'});
      if(!res.ok){ applyBaseline(); return; }
      const text = await res.text();
      const parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
      const rows = parsed.data || [];
      const map = {};
      rows.forEach(r=>{
        const k = String(r['Variable']||'').trim();
        const v = String(r['Value']||'').trim();
        if(k) map[k]=v;
      });

      // Map likely CSV keys into our baseline IDs if present
      if(map.MEMBERSHIP_PRICE) BASELINE['membership-price']=toInt(map.MEMBERSHIP_PRICE);
      if(map.MEMBERS_COUNT) BASELINE['members-count']=toInt(map.MEMBERS_COUNT);
      if(map.DAY_PASS_PRICE) BASELINE['day-pass-price']=toInt(map.DAY_PASS_PRICE);
      if(map.DAY_PASSES_MONTHLY) BASELINE['day-passes-monthly']=toInt(map.DAY_PASSES_MONTHLY);

      if(map.RENT) BASELINE['annual-rent']=toInt(map.RENT);
      if(map.BUSINESS_RATES) BASELINE['business-rates']=toInt(map.BUSINESS_RATES);
      if(map.MANAGER_SALARY) BASELINE['manager-salary']=toInt(map.MANAGER_SALARY);
      if(map.ROUTE_SETTER_SALARY) BASELINE['route-setter-salary']=toInt(map.ROUTE_SETTER_SALARY);
      if(map.OTHER_STAFF) BASELINE['other-staff']=toInt(map.OTHER_STAFF);
      if(map.UTILITIES) BASELINE['utilities']=toInt(map.UTILITIES);
      if(map.INSURANCE) BASELINE['insurance']=toInt(map.INSURANCE);
      if(map.MARKETING) BASELINE['marketing-annual']=toInt(map.MARKETING);
      if(map.MAINTENANCE) BASELINE['maintenance']=toInt(map.MAINTENANCE);

      // CAPEX grouping from granular CSV if available
      const climbSum = toInt(map.CAPEX_WALLS)+toInt(map.CAPEX_MATTING)+toInt(map.MEZZANINE_COST)+toInt(map.HOLDS_BUDGET)+toInt(map.GYM_EQUIPMENT);
      if(climbSum>0) BASELINE['capex-climbing']=climbSum;
      if(map.CAPEX_GENERAL_CONSTRUCTION) BASELINE['capex-general']=toInt(map.CAPEX_GENERAL_CONSTRUCTION);
      if(map.CAPEX_FACILITIES) BASELINE['capex-facilities']=toInt(map.CAPEX_FACILITIES);
      const softSum = toInt(map.SOFTWARE_POS)+toInt(map.LICENSES_PERMITS);
      if(softSum>0) BASELINE['capex-software']=softSum;
      if(map.BRANDING_MARKETING) BASELINE['capex-branding']=toInt(map.BRANDING_MARKETING);
      if(map.VAT_RATE) BASELINE['vat-rate']=toInt(map.VAT_RATE);

      applyBaseline();
    }catch(e){
      console.error(e);
      applyBaseline();
    }
  }

  function applyBaseline(){
    // write baseline into inputs
    FIELD_IDS.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const v = BASELINE[id];
      if(v!=null){
        el.value = formatCommas(v);
      }
    });
    // Default VAT reclaimable to yes
    const vsel = document.getElementById('vat-reclaimable');
    if(vsel && !vsel.value) vsel.value = 'yes';
  }

  /* ---------- Scenario switching ---------- */
  function applyScenario(name){
    // Start from baseline values visually
    applyBaseline();

    // Apply explicit values
    const explicit = SCENARIO_VALUE_OVERRIDES[name] || {};
    Object.keys(explicit).forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.value = formatCommas(explicit[id]);
    });

    // Apply relative nudges
    const rel = SCENARIO_RELATIVE[name] || {};
    Object.keys(rel).forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const baseVal = BASELINE[id] != null ? BASELINE[id] : toInt(el.value);
      el.value = formatCommas(rel[id](baseVal));
    });

    updateScenarioButtons(name);
    // classes are static per field based on scenario differences, not per current toggle
    calculateAll();
  }

  function updateScenarioButtons(active){
    document.querySelectorAll('.scenario-btn').forEach(btn=>{
      const isActive = btn.dataset.scenario === active;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
  }

  function attachScenarioListeners(){
    document.querySelectorAll('.scenario-btn').forEach(btn=>{
      if(btn.__attached) return;
      btn.addEventListener('click', ()=> applyScenario(btn.dataset.scenario), {passive:true});
      btn.__attached = true;
    });
  }

  /* ---------- Init ---------- */
  window.addEventListener('load', async ()=>{
    enableCommaFormatting();
    attachScenarioListeners();
    await loadRealisticFromCSVIntoBaseline();
    // Determine static vs dynamic once, based on how scenarios would affect each field
    applyStaticDynamicClasses();
    // Default scenario
    updateScenarioButtons('realistic');
    applyScenario('realistic');
  });
</script>
</body>
</html>
