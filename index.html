<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Queensgate Bouldering • Financial Model</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{color-scheme:light dark;}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#f7fafc;color:#0f172a}
  @media (prefers-color-scheme:dark){body{background:#0b0b0c;color:#e6e6e6}}

  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:10;background:rgba(247,250,252,.9);backdrop-filter:saturate(1.1) blur(6px);border-bottom:1px solid rgba(0,0,0,.06)}
  @media (prefers-color-scheme:dark){header{background:rgba(11,11,12,.9);border-bottom:1px solid rgba(255,255,255,.1)}}
  h1{margin:.25rem 0 0;font-weight:900;font-size:clamp(22px,3vw,30px)}
  p.muted{margin:.25rem 0 0;color:rgba(0,0,0,.6)}
  @media (prefers-color-scheme:dark){p.muted{color:rgba(255,255,255,.6)}}

  .row{display:grid;gap:12px}
  @media(min-width:900px){.row.cols-4{grid-template-columns:repeat(4,1fr)}.row.cols-3{grid-template-columns:repeat(3,1fr)}}

  .card{background:rgba(255,255,255,.75);backdrop-filter:blur(6px) saturate(1.1);border:1px solid rgba(0,0,0,.06);border-radius:16px;padding:18px}
  @media (prefers-color-scheme:dark){.card{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.1)}}

  .kpi{font-weight:900;font-size:clamp(22px,3vw,32px);line-height:1}
  .kpi-sub{font-size:13px;color:rgba(0,0,0,.6)}
  @media (prefers-color-scheme:dark){.kpi-sub{color:rgba(255,255,255,.6)}}
  .mono{font-variant-numeric:tabular-nums}

  .btnbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:transparent;font-weight:700;cursor:pointer}
  .btn[aria-selected="true"]{background:#000;color:#fff}
  @media (prefers-color-scheme:dark){
    .btn{border-color:rgba(255,255,255,.15)}
    .btn[aria-selected="true"]{background:#fff;color:#000}
  }

  /* Chart height is locked to avoid infinite growth */
  .chart-wrap{position:relative;height:280px;width:100%}
  .chart-wrap>canvas{display:block;width:100% !important;height:100% !important}

  .table{width:100%;border-collapse:collapse}
  .table th{font-size:12px;text-transform:uppercase;letter-spacing:.06em;text-align:left;color:rgba(0,0,0,.6);padding:8px 0}
  .table td{padding:8px 0;border-top:1px solid rgba(0,0,0,.06);vertical-align:top}
  @media (prefers-color-scheme:dark){
    .table th{color:rgba(255,255,255,.6)}
    .table td{border-top-color:rgba(255,255,255,.12)}
  }
  .muted{color:rgba(0,0,0,.6)}
  @media (prefers-color-scheme:dark){.muted{color:rgba(255,255,255,.6)}}

  .pill{display:inline-block;background:#d1fae5;color:#065f46;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
  @media (prefers-color-scheme:dark){.pill{background:rgba(16,185,129,.15);color:#a7f3d0}}

  .tooltip{position:relative;cursor:help}
  .tooltip .tip{position:absolute;left:0;bottom:125%;visibility:hidden;opacity:0;transition:opacity .15s ease;width:min(320px,75vw);background:#000;color:#fff;font-size:12px;padding:10px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.35)}
  .tooltip:hover .tip{visibility:visible;opacity:1}
</style>
</head>
<body>

<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
    <div>
      <h1>Queensgate Bouldering • Financial Model</h1>
      <p class="muted">Interactive view for banks and investors. Source: CSV in this folder.</p>
    </div>
    <div class="btnbar" id="scenarioButtons" role="tablist" aria-label="Scenarios">
      <button class="btn" data-scenario="Conservative" role="tab" aria-selected="true">Conservative</button>
      <button class="btn" data-scenario="Realistic" role="tab" aria-selected="false">Realistic</button>
      <button class="btn" data-scenario="Optimistic" role="tab" aria-selected="false">Optimistic</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:16px;padding-bottom:40px">

  <!-- KPIs -->
  <section class="row cols-4">
    <div class="card">
      <div class="kpi mono" id="kpiRevenue">£0</div>
      <div class="kpi-sub">Annual revenue</div>
    </div>
    <div class="card">
      <div class="kpi mono" id="kpiCosts">£0</div>
      <div class="kpi-sub">Annual operating costs</div>
    </div>
    <div class="card">
      <div class="kpi mono" id="kpiEbitda">£0</div>
      <div class="kpi-sub"><span id="kpiMargin">0%</span> EBITDA margin</div>
    </div>
    <div class="card">
      <div class="kpi mono" id="kpiCapex">£0</div>
      <div class="kpi-sub">Startup capex</div>
    </div>
  </section>

  <!-- Drivers + Chart -->
  <section class="row cols-3" style="margin-top:12px">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:18px;font-weight:800">Monthly break even</h2>
        <span class="pill" id="scenarioTag">Conservative</span>
      </div>
      <p class="muted" style="margin:.5rem 0 0">Based on monthly drivers in the CSV for the chosen scenario.</p>
      <div style="margin-top:10px">
        <div style="display:flex;justify-content:space-between"><span class="muted">Monthly cost to cover</span><span class="mono" id="beCost">£0</span></div>
        <div style="display:flex;justify-content:space-between"><span class="muted">Revenue from day passes and other</span><span class="mono" id="beOtherRev">£0</span></div>
        <div style="display:flex;justify-content:space-between;align-items:baseline"><span class="muted">Members required</span><span class="mono" style="font-size:22px;font-weight:900" id="membersReq">0</span></div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px;font-size:18px;font-weight:800">Revenue drivers</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:14px">
        <div><div class="muted">Members per month</div><div class="mono" style="font-weight:800;font-size:20px" id="drvMembers">0</div></div>
        <div><div class="muted">Member price</div><div class="mono" style="font-weight:800;font-size:20px" id="drvMemberPrice">£0</div></div>
        <div><div class="muted">Day passes per month</div><div class="mono" style="font-weight:800;font-size:20px" id="drvDayPasses">0</div></div>
        <div><div class="muted">Day pass price</div><div class="mono" style="font-weight:800;font-size:20px" id="drvDayPassPrice">£0</div></div>
        <div style="grid-column:1 / span 2"><div class="muted">Other revenue per month</div><div class="mono" style="font-weight:800;font-size:20px" id="drvOther">£0</div></div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px;font-size:18px;font-weight:800">Revenue vs costs</h2>
      <div class="chart-wrap">
        <canvas id="revCostChart" aria-label="Revenue vs Costs chart"></canvas>
      </div>
    </div>
  </section>

  <!-- Table -->
  <section class="card" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px">
      <h2 style="margin:0;font-size:18px;font-weight:800">Detailed view</h2>
      <div class="muted" style="font-size:13px">Values reflect the selected scenario. Capex is one time.</div>
    </div>
    <div id="tableContainer" style="overflow-x:auto"></div>
  </section>

  <section class="card" style="margin-top:12px">
    <h2 style="margin:0 0 6px;font-size:18px;font-weight:800">Notes from CSV</h2>
    <p class="muted" style="margin:0">Hover the “i” markers in the table to read line notes. All figures are taken directly from the CSV file.</p>
  </section>

</main>

<script>
  // Path to your CSV next to this HTML
  const CSV_PATH = "./adjusted_queensgate_bouldering_model_v3.csv";

  // Helpers
  const money = n => !isFinite(n) ? "£0" : "£"+ Number(n).toLocaleString("en-GB", {maximumFractionDigits:0});
  const num = v => {
    if (v === null || v === undefined) return 0;
    if (typeof v === "number") return v;
    const clean = String(v).replace(/[£,\s]/g,"");
    const parsed = parseFloat(clean);
    return isNaN(parsed) ? 0 : parsed;
  };

  let rows = [];
  let bySection = {};
  let currentScenario = "Conservative";
  let chartInstance = null;

  function groupRows() {
    bySection = {};
    rows.forEach(r=>{
      const s = (r["SECTION TITLE"] || r["Section"] || "Other") + "";
      if (!bySection[s]) bySection[s] = [];
      bySection[s].push(r);
    });
  }

  // Revenue driver extraction from "REVENUE" section
  function getRevenuePieces(scn){
    const revRows = (bySection["REVENUE"] || bySection["Revenue"] || []);
    const lookup = (nameCandidates) => {
      const cand = nameCandidates.map(x => x.toUpperCase());
      const row = revRows.find(r => cand.includes(String(r["DESCRIPTION"]||"").toUpperCase()));
      return row ? num(row[scn]) : 0;
    };
    const membersPerMonth = lookup(["MEMBERS_ MONTHLY","MEMBERS_MONTHLY","MEMBERS PER MONTH","MEMBERS"]);
    const memberPrice     = lookup(["MEMBERS_PRICE","MEMBER PRICE","MEMBERSHIP PRICE"]);
    const dayPassesPerMonth = lookup(["DAY_PASSES_MONTHLY","DAY PASSES MONTHLY","DAY PASSES"]);
    const dayPassPrice    = lookup(["DAY_PASS_PRICE","DAY PASS PRICE"]);
    const otherPerMonth   = lookup(["OTHER_REV_MONTH","OTHER REVENUE MONTH","OTHER"]);

    const monthlyFromMembers = membersPerMonth * memberPrice;
    const monthlyFromDay = dayPassesPerMonth * dayPassPrice;
    const monthlyTotal = monthlyFromMembers + monthlyFromDay + otherPerMonth;
    return {
      membersPerMonth, memberPrice, dayPassesPerMonth, dayPassPrice, otherPerMonth,
      monthlyTotal, annual: monthlyTotal * 12
    };
  }

  function sectionAnnualTotal(secName, scn){
    const arr = bySection[secName] || [];
    const isCapex = secName.toUpperCase().includes("CAPITAL EXPENDITURE");
    if (isCapex) return arr.reduce((a,r)=>a+num(r["Year 1"]),0);
    if (secName.toUpperCase().includes("REVENUE")) return getRevenuePieces(scn).annual;
    return arr.reduce((a,r)=>a+num(r[scn]),0);
  }

  function totalAnnualCosts(scn){
    return Object.keys(bySection).reduce((acc,sec)=>{
      const u = sec.toUpperCase();
      if (u.includes("REVENUE")) return acc;
      if (u.includes("CAPITAL EXPENDITURE")) return acc;
      return acc + sectionAnnualTotal(sec, scn);
    },0);
  }

  function totalCapex(){
    return Object.keys(bySection).reduce((acc,sec)=>{
      if (sec.toUpperCase().includes("CAPITAL EXPENDITURE")){
        acc += (bySection[sec]||[]).reduce((a,r)=>a+num(r["Year 1"]),0);
      }
      return acc;
    },0);
  }

  function renderKPIs(){
    const rev = getRevenuePieces(currentScenario);
    const costs = totalAnnualCosts(currentScenario);
    const ebitda = rev.annual - costs;
    const margin = rev.annual ? (ebitda / rev.annual) * 100 : 0;

    document.getElementById("kpiRevenue").textContent = money(rev.annual);
    document.getElementById("kpiCosts").textContent = money(costs);
    document.getElementById("kpiEbitda").textContent = money(ebitda);
    document.getElementById("kpiMargin").textContent = margin.toFixed(1) + "%";
    document.getElementById("kpiCapex").textContent = money(totalCapex());

    // Drivers
    document.getElementById("drvMembers").textContent = rev.membersPerMonth.toLocaleString("en-GB");
    document.getElementById("drvMemberPrice").textContent = money(rev.memberPrice);
    document.getElementById("drvDayPasses").textContent = rev.dayPassesPerMonth.toLocaleString("en-GB");
    document.getElementById("drvDayPassPrice").textContent = money(rev.dayPassPrice);
    document.getElementById("drvOther").textContent = money(rev.otherPerMonth);

    // Break even
    const monthlyCosts = totalAnnualCosts(currentScenario)/12;
    const monthlyOtherRevenue = (rev.dayPassesPerMonth*rev.dayPassPrice) + rev.otherPerMonth;
    const needed = Math.max(0, Math.ceil((monthlyCosts - monthlyOtherRevenue) / (rev.memberPrice || 1)));
    document.getElementById("beCost").textContent = money(monthlyCosts);
    document.getElementById("beOtherRev").textContent = money(monthlyOtherRevenue);
    document.getElementById("membersReq").textContent = isFinite(needed) ? needed.toLocaleString("en-GB") : "0";

    // Chart
    const ctx = document.getElementById("revCostChart");
    const data = { labels:["Revenue","Costs"], datasets:[{label:"Annual £", data:[rev.annual, costs]}] };
    const opts = {
      responsive:true,
      maintainAspectRatio:false,   // fill .chart-wrap height
      plugins:{ legend:{display:false}, tooltip:{callbacks:{label:(p)=>money(p.raw)}} },
      scales:{ y:{ ticks:{ callback:v => "£" + Number(v).toLocaleString("en-GB") } } }
    };
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx,{type:"bar",data,options:opts});
    document.getElementById("scenarioTag").textContent = currentScenario;
  }

  function renderTable(){
    const container = document.getElementById("tableContainer");
    const secOrder = Object.keys(bySection);
    let html = "";
    secOrder.forEach(sec=>{
      const isCapex = sec.toUpperCase().includes("CAPITAL EXPENDITURE");
      const isRevenue = sec.toUpperCase().includes("REVENUE");
      const sectionTotal = sectionAnnualTotal(sec, currentScenario);
      html += `
        <div style="margin-top:18px">
          <div style="display:flex;justify-content:space-between;align-items:baseline">
            <h3 style="margin:0;font-size:16px;font-weight:800">${sec}</h3>
            <div class="muted" style="font-size:13px">${isRevenue?"Annualised from monthly drivers":isCapex?"One time":"Annual"} total:
              <span class="mono" style="font-weight:800">${money(sectionTotal)}</span>
            </div>
          </div>
          <div style="overflow-x:auto;margin-top:6px">
            <table class="table">
              <thead>
                <tr>
                  <th style="width:40%">Item</th>
                  <th style="width:15%">Unit</th>
                  <th style="width:20%">Value</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
      `;
      (bySection[sec]||[]).forEach(r=>{
        const desc = String(r["DESCRIPTION"]||"");
        const notes = String(r["NOTES"]||"").trim();
        let unit = isRevenue ? "Monthly" : isCapex ? "One time" : "Annual";
        let value = 0;

        if (isRevenue){
          const key = desc.toUpperCase();
          if (["MEMBERS_ MONTHLY","MEMBERS_MONTHLY","MEMBERS PER MONTH","MEMBERS","DAY_PASSES_MONTHLY","DAY PASSES MONTHLY","DAY PASSES","OTHER_REV_MONTH","OTHER","DAY_PASS_PRICE","DAY PASS PRICE","MEMBERS_PRICE","MEMBER PRICE","MEMBERSHIP PRICE"].includes(key)){
            value = num(r[currentScenario]);
          }
        } else if (isCapex){
          value = num(r["Year 1"]);
        } else {
          value = num(r[currentScenario]);
        }

        const isPriceLike = /PRICE|REV/i.test(desc);
        const pretty = isCapex ? money(value) :
                       isRevenue && isPriceLike ? money(value) :
                       isRevenue ? Number(value).toLocaleString("en-GB") :
                       money(value);

        html += `
          <tr>
            <td>
              <div style="display:flex;gap:8px;align-items:flex-start">
                <span class="mono">${desc.replaceAll("_"," ")}</span>
                ${notes ? `<span class="tooltip" aria-label="Notes">ⓘ<span class="tip">${notes.replaceAll("<","&lt;").replaceAll(">","&gt;")}</span></span>` : ""}
              </div>
            </td>
            <td class="muted">${unit}</td>
            <td class="mono" style="font-weight:700">${pretty}</td>
            <td class="muted">${notes || ""}</td>
          </tr>
        `;
      });
      html += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }

  function recalc(){ renderKPIs(); renderTable(); }

  // Scenario buttons
  document.getElementById("scenarioButtons").addEventListener("click", e=>{
    const b = e.target.closest("button[data-scenario]");
    if (!b) return;
    currentScenario = b.dataset.scenario;
    [...document.querySelectorAll("#scenarioButtons .btn")].forEach(x=>x.setAttribute("aria-selected", x===b ? "true":"false"));
    recalc();
  });

  // Load CSV
  function loadCSV(){
    Papa.parse(CSV_PATH,{
      download:true, header:true, dynamicTyping:false, skipEmptyLines:true,
      complete:(res)=>{
        rows = res.data.map(r=>{
          Object.keys(r).forEach(k=>{ if(r[k]==="") r[k]=null; });
          return r;
        });
        groupRows();
        recalc();
      },
      error:(err)=>{
        document.querySelector("main").innerHTML = `
          <div class="card">
            <h2 style="margin:0 0 8px;font-size:18px;font-weight:800">Could not load CSV</h2>
            <p style="color:#dc2626;margin:0 0 8px">Error: ${err?.message || "Unknown error"}</p>
            <p class="muted" style="margin:0">CSV must be next to this HTML and named <b>adjusted_queensgate_bouldering_model_v3.csv</b>.</p>
          </div>`;
        console.error("CSV load error", err);
      }
    });
  }

  loadCSV();
</script>

</body>
</html>
