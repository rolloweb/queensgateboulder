<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  // -------- formatting helpers --------
  function toInt(v){ const x = Math.floor(Number(v)); return isFinite(x) ? x : 0; }
  function money(v){ const f = toInt(v); return (f < 0 ? '-£' : '£') + Math.abs(f).toLocaleString('en-GB'); }
  function pct(v){ const p = Math.round(Number(v)); return isFinite(p) ? p + '%' : '0%'; }
  function setIf(id, val){ if(val==null || val==='') return; const el=document.getElementById(id); if(el) el.value = toInt(val); }
  function toIntSafe(id, fallback){ const el = document.getElementById(id); return el ? toInt(el.value) : toInt(fallback); }

  // -------- baseline from CSV (for "realistic") --------
  const BASELINE = {};         // filled after CSV load
  const WATCH_IDS = [          // fields to check for "unchanged" greying
    'membership-price','members-count','day-pass-price','day-passes-monthly',
    'annual-rent','business-rates','manager-salary','route-setter-salary',
    'other-staff','utilities','insurance','marketing-annual','maintenance',
    'capex-climbing','capex-general','capex-facilities','capex-software','capex-branding'
  ];

  // -------- scenario overlays (integers only) --------
  // Explicit values for the four requested fields so they always change.
  // Day pass price: 13 / 14 / 15
  // Other staff:    46k / 50k / 60k
  // Route setting:  24k / 26k / 30k
  // Centre manager: 34k / 36k / 38k
  const SCENARIO_VALUE_OVERRIDES = {
    conservative: {
      'day-pass-price': 13,
      'other-staff': 46000,
      'route-setter-salary': 24000,
      'manager-salary': 34000
    },
    realistic: {
      'day-pass-price': 14,
      'other-staff': 50000,
      'route-setter-salary': 26000,
      'manager-salary': 36000
    },
    optimistic: {
      'day-pass-price': 15,
      'other-staff': 60000,
      'route-setter-salary': 30000,
      'manager-salary': 38000
    }
  };

  // Relative nudges for other lines to keep scenarios meaningful
  const SCENARIO_RELATIVE = {
    conservative: {
      'members-count': v => Math.max(0, Math.round(v*0.85)),
      'membership-price': v => Math.round(v*0.98),
      'day-passes-monthly': v => Math.max(0, Math.round(v*0.80)),
      'coaching-sessions': v => 30,
      'coaching-price': v => 50,
      'parties-monthly': v => 9,
      'party-revenue': v => 140,
      'rental-monthly': v => 700,
      'retail-monthly': v => 1000,
      'cafe-monthly': v => 3500,
      'cafe-margin': v => 8,
      'utilities': v => Math.round(v*0.96),
      'marketing-annual': v => Math.round(v*0.85),
      'maintenance': v => Math.round(v*0.90)
    },
    optimistic: {
      'members-count': v => Math.round(v*1.20),
      'membership-price': v => Math.round(v*1.03),
      'day-passes-monthly': v => Math.round(v*1.25),
      'coaching-sessions': v => 60,
      'coaching-price': v => 60,
      'parties-monthly': v => 16,
      'party-revenue': v => 160,
      'rental-monthly': v => 1200,
      'retail-monthly': v => 1800,
      'cafe-monthly': v => 7000,
      'cafe-margin': v => 9,
      'utilities': v => Math.round(v*1.10),
      'marketing-annual': v => Math.round(v*1.15),
      'maintenance': v => Math.round(v*1.15)
    }
  };

  // -------- CAPEX breakdown visuals --------
  const CAPEX_BREAKDOWN = {
    climbing: [
      {name:'Walls', share:60},
      {name:'Safety matting', share:15},
      {name:'Equipment', share:15},
      {name:'Initial holds', share:10}
    ],
    general: [
      {name:'Reception area', share:25},
      {name:'Cafe build', share:35},
      {name:'Bar servery', share:20},
      {name:'Storage and back of house', share:10},
      {name:'Office and admin', share:10}
    ],
    facilities: [
      {name:'Dry changing rooms', share:60},
      {name:'Toilets', share:40}
    ],
    software: [
      {name:'Membership software', share:25},
      {name:'POS system and terminals', share:25},
      {name:'Licences and permits', share:50}
    ],
    branding: [
      {name:'Brand identity and signage', share:60},
      {name:'Launch campaign', share:40}
    ]
  };

  function renderCapexSection(){
    const wrap = document.getElementById('capex-breakdown');
    const groups = [
      {id:'capex-climbing', label:'Climbing Construction', key:'climbing'},
      {id:'capex-general', label:'General Construction', key:'general'},
      {id:'capex-facilities', label:'Facilities Construction', key:'facilities'},
      {id:'capex-software', label:'Software, Licences, Permits', key:'software'},
      {id:'capex-branding', label:'Branding and Launch', key:'branding'}
    ];

    function rowsForGroup(total, items){
      const t = toInt(total);
      let allocated = 0;
      return items.map((it, idx) => {
        let val = Math.round(t * it.share / 100);
        allocated += val;
        if(idx === items.length - 1){ val += (t - allocated); }
        return {name: it.name, value: val, share: it.share};
      });
    }

    wrap.innerHTML = '';
    groups.forEach(g => {
      const total = toIntSafe(g.id, 0);
      const rows = rowsForGroup(total, CAPEX_BREAKDOWN[g.key]);

      const groupHeader = document.createElement('div');
      groupHeader.className = 'line-item';
      groupHeader.innerHTML = `
        <div>
          <div class="line-item-name"><strong>${g.label}</strong></div>
          <div class="line-item-desc">Allocated by item percentages</div>
        </div>
        <input type="text" value="Editable above" readonly style="background:#f5f5f5;text-align:left">
        <div class="line-item-total">${money(total)}</div>
      `;
      wrap.appendChild(groupHeader);

      rows.forEach(r=>{
        const row = document.createElement('div');
        row.className = 'line-item';
        row.innerHTML = `
          <div><div class="line-item-name">${r.name}</div></div>
          <input type="text" value="${pct(r.share)}" readonly style="background:#f5f5f5;text-align:left">
          <div class="line-item-total">${money(r.value)}</div>
        `;
        wrap.appendChild(row);
      });

      const divider = document.createElement('div');
      divider.style.borderBottom = '1px solid #eee';
      wrap.appendChild(divider);
    });
  }

  // -------- calculators --------
  function calculateAll(){
    // CAPEX
    const capClimb = toIntSafe('capex-climbing', 300000);
    const capGen = toIntSafe('capex-general', 150000);
    const capFac = toIntSafe('capex-facilities', 30000);
    const capSoft = toIntSafe('capex-software', 8000);
    const capBrand = toIntSafe('capex-branding', 20000);
    const capexExVat = capClimb + capGen + capFac + capSoft + capBrand;

    const vatRate = toIntSafe('vat-rate', 20) / 100;
    const vatReclaim = String(document.getElementById('vat-reclaimable').value || '').toLowerCase() === 'yes';
    const capexIncVat = capexExVat * (1 + vatRate);
    const capexBasis = vatReclaim ? capexExVat : capexIncVat;

    document.getElementById('capex-exvat').textContent = money(capexExVat);
    document.getElementById('capex-incvat').textContent = money(capexIncVat);
    document.getElementById('capex-total').textContent = money(capexBasis);

    // Demand and pricing
    const memberPrice = toIntSafe('membership-price', 70);
    const members = toIntSafe('members-count', 450);
    const dayPassPrice = toIntSafe('day-pass-price', 14);
    const dayPassesPerMonth = toIntSafe('day-passes-monthly', 600);

    // Revenue detail
    const coachSessions = toIntSafe('coaching-sessions', 40);
    const coachPrice = toIntSafe('coaching-price', 55);
    const partiesM = toIntSafe('parties-monthly', 12);
    const partyPrice = toIntSafe('party-revenue', 150);
    const rentalMonthly = toIntSafe('rental-monthly', 800);
    const retailMonthly = toIntSafe('retail-monthly', 1200);
    const cafeMonthly = toIntSafe('cafe-monthly', 4000);
    const cafeMargin = toIntSafe('cafe-margin', 8) / 100;

    const membershipRevenue = members * memberPrice * 12;
    const dayPassRevenue = dayPassesPerMonth * dayPassPrice * 12;
    const coachingRevenue = coachSessions * coachPrice * 12;
    const youthRevenue = partiesM * partyPrice * 12;
    const rentalRevenue = rentalMonthly * 12;
    const retailRevenue = retailMonthly * 12;
    const cafeNetRevenue = Math.round(cafeMonthly * cafeMargin) * 12;

    const totalRevenue = membershipRevenue + dayPassRevenue + coachingRevenue + youthRevenue + rentalRevenue + retailRevenue + cafeNetRevenue;

    document.getElementById('membership-revenue-total').textContent = money(membershipRevenue);
    document.getElementById('day-pass-revenue-total').textContent = money(dayPassRevenue);
    document.getElementById('coaching-revenue-total').textContent = money(coachingRevenue);
    document.getElementById('youth-revenue-total').textContent = money(youthRevenue);
    document.getElementById('rental-revenue-total').textContent = money(rentalRevenue);
    document.getElementById('retail-revenue-total').textContent = money(retailRevenue);
    document.getElementById('cafe-revenue-total').textContent = money(cafeNetRevenue);
    document.getElementById('revenue-total').textContent = money(totalRevenue);
    document.getElementById('annual-revenue').textContent = money(totalRevenue);
    document.getElementById('annual-revenue-summary').textContent = money(totalRevenue);

    // OPEX
    const rent = toIntSafe('annual-rent', 56000);
    const rates = toIntSafe('business-rates', 35000);
    const mgr = toIntSafe('manager-salary', 36000);
    const rs = toIntSafe('route-setter-salary', 26000);
    const staffOther = toIntSafe('other-staff', 50000);
    const utils = toIntSafe('utilities', 24000);
    const ins = toIntSafe('insurance', 3000);
    const mkt = toIntSafe('marketing-annual', 12000);
    const maint = toIntSafe('maintenance', 10000);

    const totalExpenses = rent + rates + mgr + rs + staffOther + utils + ins + mkt + maint;

    document.getElementById('rent-cost-total').textContent = money(rent);
    document.getElementById('business-rates-total').textContent = money(rates);
    document.getElementById('manager-salary-total').textContent = money(mgr);
    document.getElementById('route-setter-salary-total').textContent = money(rs);
    document.getElementById('other-staff-total').textContent = money(staffOther);
    document.getElementById('utilities-total').textContent = money(utils);
    document.getElementById('insurance-total').textContent = money(ins);
    document.getElementById('marketing-annual-total').textContent = money(mkt);
    document.getElementById('maintenance-total').textContent = money(maint);
    document.getElementById('expenses-total').textContent = money(totalExpenses);
    document.getElementById('annual-expenses-summary').textContent = money(totalExpenses);

    // EBITDA / ROI / Payback
    const ebitda = totalRevenue - totalExpenses;
    const roiPct = capexBasis > 0 ? Math.round((ebitda / capexBasis) * 100) : 0;
    const paybackYears = ebitda > 0 ? (capexBasis / ebitda) : 0;

    document.getElementById('annual-profit').textContent = money(ebitda);
    document.getElementById('annual-profit').className = 'metric-value ' + (ebitda > 0 ? 'positive':'negative');
    document.getElementById('annual-ebitda').textContent = money(ebitda);
    document.getElementById('annual-ebitda').className = ebitda > 0 ? 'positive':'negative';
    document.getElementById('annual-margin').textContent = pct(Math.round((ebitda / Math.max(totalRevenue,1)) * 100));
    document.getElementById('roi').textContent = pct(roiPct);
    document.getElementById('roi-summary').textContent = pct(roiPct);
    document.getElementById('payback-period').textContent = ebitda > 0 ? (Math.round(paybackYears * 10)/10) + ' years' : 'N/A';
    document.getElementById('payback-summary').textContent = ebitda > 0 ? (Math.round(paybackYears * 10)/10) + ' years' : 'N/A';

    renderCapexSection();
  }

  // -------- CSV hydrate realistic baseline --------
  async function loadRealisticFromCSVIntoBaseline(){
    // defaults first
    const defaults = {
      'membership-price':70,'members-count':450,'day-pass-price':14,'day-passes-monthly':600,
      'annual-rent':56000,'business-rates':35000,'manager-salary':36000,'route-setter-salary':26000,
      'other-staff':50000,'utilities':24000,'insurance':3000,'marketing-annual':12000,'maintenance':10000,
      'capex-climbing':300000,'capex-general':150000,'capex-facilities':30000,'capex-software':8000,'capex-branding':20000,
      'vat-rate':20
    };
    Object.assign(BASELINE, defaults);

    try{
      const res = await fetch('queensgate_bouldering_provenance.csv',{cache:'no-store'});
      if(!res.ok){ applyBaseline(); calculateAll(); return; }
      const text = await res.text();
      const parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
      const rows = parsed.data || [];
      const map = {};
      rows.forEach(r=>{
        const k = String(r['Variable']||'').trim();
        const v = String(r['Value']||'').trim();
        if(k) map[k]=v;
      });

      // inject into BASELINE when present
      if(map.MEMBERSHIP_PRICE) BASELINE['membership-price']=toInt(map.MEMBERSHIP_PRICE);
      if(map.MEMBERS_COUNT) BASELINE['members-count']=toInt(map.MEMBERS_COUNT);
      if(map.DAY_PASS_PRICE) BASELINE['day-pass-price']=toInt(map.DAY_PASS_PRICE);
      if(map.DAY_PASSES_MONTHLY) BASELINE['day-passes-monthly']=toInt(map.DAY_PASSES_MONTHLY);
      if(map.RENT) BASELINE['annual-rent']=toInt(map.RENT);
      if(map.BUSINESS_RATES) BASELINE['business-rates']=toInt(map.BUSINESS_RATES);
      if(map.MANAGER_SALARY) BASELINE['manager-salary']=toInt(map.MANAGER_SALARY);
      if(map.ROUTE_SETTER_SALARY) BASELINE['route-setter-salary']=toInt(map.ROUTE_SETTER_SALARY);
      if(map.OTHER_STAFF) BASELINE['other-staff']=toInt(map.OTHER_STAFF);
      if(map.UTILITIES) BASELINE['utilities']=toInt(map.UTILITIES);
      if(map.INSURANCE) BASELINE['insurance']=toInt(map.INSURANCE);
      if(map.MARKETING) BASELINE['marketing-annual']=toInt(map.MARKETING);
      if(map.MAINTENANCE) BASELINE['maintenance']=toInt(map.MAINTENANCE);

      // CAPEX grouping from granular CSV where available
      const climbSum = (toInt(map.CAPEX_WALLS)+toInt(map.CAPEX_MATTING)+toInt(map.MEZZANINE_COST)+toInt(map.HOLDS_BUDGET)+toInt(map.GYM_EQUIPMENT));
      if(climbSum>0) BASELINE['capex-climbing']=climbSum;
      if(map.CAPEX_GENERAL_CONSTRUCTION) BASELINE['capex-general']=toInt(map.CAPEX_GENERAL_CONSTRUCTION);
      if(map.CAPEX_FACILITIES) BASELINE['capex-facilities']=toInt(map.CAPEX_FACILITIES);
      const softSum = toInt(map.SOFTWARE_POS)+toInt(map.LICENSES_PERMITS);
      if(softSum>0) BASELINE['capex-software']=softSum;
      if(map.BRANDING_MARKETING) BASELINE['capex-branding']=toInt(map.BRANDING_MARKETING);
      if(map.VAT_RATE) BASELINE['vat-rate']=toInt(map.VAT_RATE);

      applyBaseline();
      calculateAll();
    }catch(e){
      console.error(e);
      applyBaseline();
      calculateAll();
    }
  }

  function applyBaseline(){
    // write baseline values into inputs
    Object.keys(BASELINE).forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.value = BASELINE[id];
    });
    // reset VAT reclaim to yes by default unless user changes
    const vsel = document.getElementById('vat-reclaimable');
    if(vsel && !vsel.value) vsel.value = 'yes';
  }

  // -------- scenario application + greying unchanged --------
  function applyScenario(name){
    // start from baseline each time to ensure consistent deltas
    applyBaseline();

    // explicit overrides first for the four requested fields
    const explicit = SCENARIO_VALUE_OVERRIDES[name] || {};
    Object.keys(explicit).forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.value = toInt(explicit[id]);
    });

    // relative adjustments for other fields
    const rel = SCENARIO_RELATIVE[name] || {};
    Object.keys(rel).forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const baseVal = BASELINE[id] != null ? BASELINE[id] : toInt(el.value);
      el.value = toInt(rel[id](baseVal));
    });

    updateScenarioButtons(name);
    markUnchangedInputs(name);
    calculateAll();
  }

  function markUnchangedInputs(scenarioName){
    // Grey if same as baseline realistic values after scenario application
    WATCH_IDS.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const base = BASELINE[id];
      const cur = toInt(el.value);
      if(base === cur){
        el.classList.add('unchanged');
      }else{
        el.classList.remove('unchanged');
      }
    });
  }

  function updateScenarioButtons(active){
    document.querySelectorAll('.scenario-btn').forEach(btn=>{
      const isActive = btn.dataset.scenario === active;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
  }

  function attachScenarioListeners(){
    document.querySelectorAll('.scenario-btn').forEach(btn=>{
      if(btn.__attached) return;
      btn.addEventListener('click', ()=> applyScenario(btn.dataset.scenario), {passive:true});
      btn.__attached = true;
    });
  }

  // -------- init --------
  window.addEventListener('load', async ()=>{
    attachScenarioListeners();
    await loadRealisticFromCSVIntoBaseline();
    updateScenarioButtons('realistic');
    markUnchangedInputs('realistic'); // initial state
  });
</script>
