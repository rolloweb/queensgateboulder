<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Queensgate Bouldering • Financial Model</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    color-scheme: light dark;
    --gold:#fce38b;
    --blue:#6ba0cc;
    --ink:#101418;
    --paper:#f8fafc;
  }
  @media(prefers-color-scheme:dark){
    :root{--paper:#0b0b0c;--ink:#e6e6e6}
  }

  html,body{
    margin:0;
    background:var(--paper);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  }

  /* Sticky header */
  header{
    position:sticky;
    top:0;
    z-index:10;
    background:rgba(255,255,255,.97);
    border-bottom:2px solid var(--gold);
    backdrop-filter:saturate(1.1) blur(6px);
  }
  @media(prefers-color-scheme:dark){
    header{background:rgba(16,16,16,.97)}
  }

  .wrap{max-width:1100px;margin:0 auto;padding:16px}

  .row{display:grid;gap:12px}
  @media(min-width:900px){
    .row.cols-2{grid-template-columns:repeat(2,1fr)}
  }

  .card{
    background:#fff;
    border:2px solid #e5e7eb;
    border-radius:16px;
    padding:18px;
    margin-top:20px;
  }
  @media(prefers-color-scheme:dark){
    .card{background:#121416;border-color:#222}
  }

  .kpi{
    font-size:30px;
    font-weight:900;
  }
  .mono{
    font-variant-numeric:tabular-nums;
  }

  input{
    width:100%;
    padding:8px;
    border-radius:10px;
    border:2px solid var(--blue);
    background:#fff;
    font-weight:800;
    box-sizing:border-box;
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
  }
  th{
    text-align:left;
    font-size:12px;
    opacity:.7;
    padding:6px 0;
  }
  td{
    padding:8px 0;
    border-top:1px solid #e5e7eb;
  }
  @media(prefers-color-scheme:dark){
    td{border-color:#222}
  }
</style>
</head>

<body>

<header>
  <div class="wrap">
    <h1>Queensgate Bouldering • Financial Model</h1>

    <label style="display:flex;align-items:center;gap:8px;margin-top:10px;font-weight:700">
      <input type="checkbox" id="yearToggle" checked>
      Use Year 1
    </label>
  </div>
</header>

<main class="wrap" style="padding-bottom:40px">

  <!-- KPI summary -->
  <section class="row cols-2">
    <div class="card">
      <div class="kpi mono" id="kpiEbitda">£0</div>
      <div>EBITDA</div>
    </div>
    <div class="card">
      <div class="kpi mono" id="kpiCapex">£0</div>
      <div>CAPEX</div>
    </div>
  </section>

  <!-- Revenue drivers -->
  <section class="card">
    <h2>Revenue drivers</h2>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
      <div>
        <label>Members per month</label>
        <input id="drvMembers" type="number">
      </div>
      <div>
        <label>Member price</label>
        <input id="drvMemberPrice" type="number">
      </div>
      <div>
        <label>Day passes</label>
        <input id="drvDayPasses" type="number">
      </div>
      <div>
        <label>Day pass price</label>
        <input id="drvDayPrice" type="number">
      </div>
      <div style="grid-column:1 / span 2">
        <label>Other revenue</label>
        <input id="drvOther" type="number">
      </div>
    </div>
  </section>

  <!-- Loan -->
  <section class="card">
    <h2>Loan</h2>

    <div class="row cols-2">
      <div>
        <label>Loan amount</label>
        <input id="loanAmount" type="number" value="350000">
      </div>
      <div>
        <label>Interest rate percent</label>
        <input id="loanRate" type="number" value="7">
      </div>
      <div>
        <label>Loan term (months)</label>
        <input id="loanMonths" type="number" value="84">
      </div>
    </div>
  </section>

  <!-- Detailed table -->
  <section class="card">
    <h2>Detailed view</h2>
    <div id="tableContainer"></div>
  </section>

</main>

<script>
let rows = [];
let bySection = {};
let useYear1 = true;

const money = n => "£" + Number(n).toLocaleString("en-GB",{maximumFractionDigits:0});
const num = v => {
  if (v === null || v === undefined) return 0;
  const clean = String(v).replace(/[£,\s]/g,"");
  const p = parseFloat(clean);
  return isNaN(p) ? 0 : p;
};

function groupSections(){
  bySection = {};
  rows.forEach(r=>{
    const sec = r["SECTION TITLE"] || "Other";
    if (!bySection[sec]) bySection[sec] = [];
    bySection[sec].push(r);
  });
}

function currentValue(row){
  return useYear1 ? num(row["Year 1"]) : num(row["Year 2"]);
}

function isRevenueSection(name){
  return name.toUpperCase().includes("REVENUE");
}
function isCapexSection(name){
  const u = name.toUpperCase();
  return u.includes("CAPITAL EXPENDITURE") || u.includes("CAPEX") || u.includes("FIT OUT");
}

function sectionTotal(name){
  const arr = bySection[name] || [];
  return arr.reduce((a,r)=>a + currentValue(r),0);
}

// Map your actual revenue driver rows
function readRevenueFromCsv(){
  const secName = Object.keys(bySection).find(s => isRevenueSection(s)) || null;
  const revRows = secName ? bySection[secName] : [];

  const getByDesc = key => {
    const target = String(key).toUpperCase();
    const row = revRows.find(r => String(r["DESCRIPTION"]||"").toUpperCase() === target);
    return row ? currentValue(row) : 0;
  };

  return {
    members:     getByDesc("MEMBERS_ MONTHLY"),
    memberPrice: getByDesc("MEMBERS_PRICE"),
    dayPasses:   getByDesc("DAY_PASSES_MONTHLY"),
    dayPrice:    getByDesc("DAY_PASS_PRICE"),
    other:       getByDesc("OTHER_REV_MONTH")
  };
}

function populateDriverInputs(){
  const rev = readRevenueFromCsv();
  document.getElementById("drvMembers").value      = rev.members;
  document.getElementById("drvMemberPrice").value  = rev.memberPrice;
  document.getElementById("drvDayPasses").value    = rev.dayPasses;
  document.getElementById("drvDayPrice").value     = rev.dayPrice;
  document.getElementById("drvOther").value        = rev.other;
}

function computeAnnualRevenue(drivers){
  const m = drivers.members * drivers.memberPrice;
  const d = drivers.dayPasses * drivers.dayPrice;
  return (m + d + drivers.other) * 12;
}

function render(){
  const defaults = readRevenueFromCsv();

  const drv = {
    members:     num(document.getElementById("drvMembers").value)      || defaults.members,
    memberPrice: num(document.getElementById("drvMemberPrice").value)  || defaults.memberPrice,
    dayPasses:   num(document.getElementById("drvDayPasses").value)    || defaults.dayPasses,
    dayPrice:    num(document.getElementById("drvDayPrice").value)     || defaults.dayPrice,
    other:       num(document.getElementById("drvOther").value)        || defaults.other
  };

  const revenue = computeAnnualRevenue(drv);

  const sections = Object.keys(bySection);

  const operating = sections
    .filter(s => !isRevenueSection(s) && !isCapexSection(s))
    .reduce((acc,s)=>acc + sectionTotal(s),0);

  const ebitda = revenue - operating;

  const capex = sections
    .filter(s => isCapexSection(s))
    .reduce((acc,s)=>acc + sectionTotal(s),0);

  document.getElementById("kpiEbitda").textContent = money(ebitda);
  document.getElementById("kpiCapex").textContent  = money(capex);

  renderTable();
}

function renderTable(){
  const sections = Object.keys(bySection);
  let html = `
    <table>
      <thead>
        <tr>
          <th style="width:60%">Item</th>
          <th style="width:40%">Value</th>
        </tr>
      </thead>
      <tbody>
  `;

  sections.forEach(sec=>{
    html += `<tr><td colspan="2" style="font-weight:900;padding-top:14px">${sec}</td></tr>`;
    (bySection[sec] || []).forEach(r=>{
      html += `
        <tr>
          <td>${r["DESCRIPTION"]}</td>
          <td class="mono">${money(currentValue(r))}</td>
        </tr>
      `;
    });
  });

  html += `
      </tbody>
    </table>
  `;
  document.getElementById("tableContainer").innerHTML = html;
}

/* Events */
document.getElementById("yearToggle").addEventListener("change", e=>{
  useYear1 = e.target.checked;
  populateDriverInputs();
  render();
});

[
  "drvMembers","drvMemberPrice","drvDayPasses","drvDayPrice","drvOther",
  "loanAmount","loanRate","loanMonths"
].forEach(id=>{
  document.getElementById(id).addEventListener("input", render);
});

/* Load CSV */
Papa.parse("./queensgate_bouldering_model.csv",{
  download:true,
  header:true,
  dynamicTyping:false,
  skipEmptyLines:true,
  complete: res =>{
    rows = res.data;
    groupSections();
    populateDriverInputs();
    render();
  }
});
</script>

</body>
</html>
