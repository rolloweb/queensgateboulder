<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Queensgate Bouldering Centre ‚Äì Financial Model</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<!-- CSV parser -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    background:#f5f7fa;color:#1f2933;padding:20px;
  }
  .container{
    max-width:1200px;margin:0 auto;background:#fff;border-radius:12px;
    box-shadow:0 2px 12px rgba(15,23,42,0.12);overflow:hidden;
  }

  /* Header */
  .header{
    display:flex;align-items:center;gap:18px;
    padding:24px 28px;
    background:linear-gradient(120deg,#667eea 0%,#764ba2 40%,#a855f7 100%);
    color:#fff;
  }
  .header-icon{
    width:42px;height:42px;border-radius:10px;overflow:hidden;
    background:#fff1;border:2px solid #ffffff55;display:flex;align-items:center;justify-content:center;
    font-size:28px;
  }
  .header h1{
    font-size:clamp(1.6rem,2.4vw,2.1rem);
    font-weight:800;
  }
  .header p{
    margin-top:6px;font-size:.95rem;opacity:.96;
  }

  .content{padding:24px 26px 30px;}

  /* Top metrics */
  .key-metrics{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:16px;margin-bottom:24px;padding:16px 18px;background:#f8fafc;border-radius:12px;
  }
  .metric{text-align:left}
  .metric-label{font-size:.8rem;color:#6b7280;text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px;}
  .metric-value{
    font-size:1.6rem;font-weight:800;
  }
  .metric-value.revenue{color:#4f46e5;}
  .metric-value.ebitda{color:#16a34a;}
  .metric-value.capex{color:#ea580c;}

  /* Year toggle */
  .toolbar{
    display:flex;justify-content:space-between;align-items:center;
    margin-bottom:18px;flex-wrap:wrap;gap:10px;
  }
  .year-toggle{display:inline-flex;border-radius:999px;background:#e5e7eb;padding:3px;}
  .year-btn{
    border:none;background:transparent;padding:6px 14px;border-radius:999px;
    font-size:.9rem;font-weight:600;color:#4b5563;cursor:pointer;
  }
  .year-btn.active{
    background:#fff;color:#111827;box-shadow:0 1px 4px rgba(0,0,0,.15);
  }
  .toolbar-note{font-size:.9rem;color:#4b5563;}

  /* Sections */
  .section{
    border:1px solid #e5e7eb;border-radius:12px;margin-bottom:18px;overflow:hidden;
  }
  .section-header{
    background:#f9fafb;padding:12px 16px;border-bottom:1px solid #e5e7eb;
    display:flex;justify-content:space-between;align-items:center;gap:8px;
  }
  .section-title{font-weight:700;font-size:1.05rem;color:#111827;}
  .section-header .section-total{font-weight:700;font-size:1rem;color:#4f46e5;}
  .section-body{padding:16px;}

  /* Revenue drivers form */
  .rev-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:14px;
    margin-top:14px;
  }
  .field{display:flex;flex-direction:column;gap:4px;}
  .field label{font-size:.9rem;color:#4b5563;}
  .field input{
    padding:9px 10px;border-radius:8px;border:1px solid #cbd5e1;
    text-align:right;font-size:1rem;
  }
  .field input:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 1px #6366f177;}
  .help-text{font-size:.85rem;color:#6b7280;}

  /* Loan */
  .loan-grid{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:10px;
  }
  .loan-metrics{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:12px;
  }
  .pill{
    font-size:.85rem;font-weight:600;padding:6px 10px;border-radius:999px;
    background:#eef2ff;color:#3730a3;display:inline-block;
  }

  /* Table */
  .table-wrap{overflow-x:auto;}
  table{width:100%;border-collapse:collapse;font-size:.9rem;}
  th,td{padding:8px 6px;border-bottom:1px solid #e5e7eb;text-align:left;}
  th{font-size:.75rem;text-transform:uppercase;letter-spacing:.07em;color:#6b7280;}
  .sec-row th{background:#f9fafb;border-top:2px solid #e5e7eb;}
  .mono{font-variant-numeric:tabular-nums;}
  .num{text-align:right;}

  @media(max-width:640px){
    .content{padding:18px 16px 24px;}
  }
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="header-icon">üßó‚Äç‚ôÇÔ∏è</div>
    <div>
      <h1>Queensgate Bouldering Centre ‚Äì Financial Model</h1>
      <p><strong>Purpose:</strong> Robust, source-backed projections aligned to supplier quotes for a two-level bouldering gym in Queensgate.</p>
    </div>
  </header>

  <div class="content">
    <!-- Metrics -->
    <section class="key-metrics">
      <div class="metric">
        <div class="metric-label">Annual revenue</div>
        <div class="metric-value revenue mono" id="kmRevenue">¬£0</div>
      </div>
      <div class="metric">
        <div class="metric-label">Annual profit (EBITDA)</div>
        <div class="metric-value ebitda mono" id="kmEbitda">¬£0</div>
      </div>
      <div class="metric">
        <div class="metric-label">Total capex</div>
        <div class="metric-value capex mono" id="kmCapex">¬£0</div>
      </div>
    </section>

    <div class="toolbar">
      <div class="year-toggle" id="yearToggle">
        <button class="year-btn active" data-year="1" type="button">Year 1</button>
        <button class="year-btn" data-year="2" type="button">Year 2</button>
      </div>
      <div class="toolbar-note">Figures update from CSV for the selected year. Adjust revenue drivers to explore upside or downside.</div>
    </div>

    <!-- Revenue drivers -->
    <section class="section">
      <div class="section-header">
        <div class="section-title">Revenue drivers</div>
        <div class="section-total mono" id="revTotalLabel">Annual revenue ¬£0</div>
      </div>
      <div class="section-body">
        <p class="help-text">Defaults come from the CSV for the selected year. Adjust any field to explore upside or downside.</p>
        <div class="rev-grid">
          <div class="field">
            <label for="inMembersPerMonth">Members per month</label>
            <input id="inMembersPerMonth" type="number" min="0" step="1" inputmode="numeric">
          </div>
          <div class="field">
            <label for="inMemberPrice">Member price (¬£)</label>
            <input id="inMemberPrice" type="number" min="0" step="0.1" inputmode="decimal">
          </div>
          <div class="field">
            <label for="inDayPassesPerMonth">Day passes per month</label>
            <input id="inDayPassesPerMonth" type="number" min="0" step="1" inputmode="numeric">
          </div>
          <div class="field">
            <label for="inDayPassPrice">Day pass price (¬£)</label>
            <input id="inDayPassPrice" type="number" min="0" step="0.1" inputmode="decimal">
          </div>
          <div class="field" style="grid-column:1/-1">
            <label for="inOtherRevenuePerMonth">Other revenue per month (¬£)</label>
            <input id="inOtherRevenuePerMonth" type="number" min="0" step="1" inputmode="numeric">
          </div>
        </div>
      </div>
    </section>

    <!-- Loan -->
    <section class="section">
      <div class="section-header">
        <div class="section-title">Loan</div>
        <div class="section-total mono" id="loanTag">Annual debt service ¬£0</div>
      </div>
      <div class="section-body">
        <div class="loan-grid">
          <div class="field">
            <label for="loanAmount">Loan amount (¬£)</label>
            <input id="loanAmount" type="number" min="0" step="1000" value="350000">
          </div>
          <div class="field">
            <label for="loanRate">Interest rate percent (APR)</label>
            <input id="loanRate" type="number" min="0" step="0.1" value="7.0">
          </div>
          <div class="field">
            <label for="loanMonths">Loan term (months)</label>
            <input id="loanMonths" type="number" min="1" step="1" value="84">
          </div>
        </div>

        <div class="loan-metrics">
          <div><span class="pill mono" id="loanAnnualDebt">Annual debt service ¬£0</span></div>
          <div><span class="pill mono" id="loanFreeCash">EBITDA after debt ¬£0</span></div>
          <div><span class="pill mono" id="loanPayback">Debt payback N/A</span></div>
        </div>
      </div>
    </section>

    <!-- Detail table -->
    <section class="section">
      <div class="section-header">
        <div class="section-title">Detailed breakdown from CSV</div>
        <div class="section-total mono" id="detailYearLabel">Year 1</div>
      </div>
      <div class="section-body table-wrap">
        <table id="detailTable">
          <thead>
            <tr>
              <th>Section</th>
              <th>Item</th>
              <th class="num">Value</th>
            </tr>
          </thead>
          <tbody>
          <!-- filled by JS -->
          </tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<script>
  // Path to your CSV in the repo
  const CSV_PATH = "./queensgate_bouldering_model.csv";

  // Helpers
  const money = v => {
    const n = Number(v);
    if (!isFinite(n)) return "¬£0";
    const sign = n < 0 ? "-" : "";
    return sign + "¬£" + Math.abs(Math.round(n)).toLocaleString("en-GB");
  };
  const num = v => {
    if (v === null || v === undefined) return 0;
    if (typeof v === "number") return v;
    const clean = String(v).replace(/[¬£,\s]/g,"");
    const n = parseFloat(clean);
    return isNaN(n) ? 0 : n;
  };

  // State
  let rows = [];
  let bySection = {};
  let currentYear = 1;

  const driverOverrides = {
    membersPerMonth:null,
    memberPrice:null,
    dayPassesPerMonth:null,
    dayPassPrice:null,
    otherPerMonth:null
  };

  // Map CSV DESCRIPTION to logical revenue driver keys
  const revenueDescriptionMap = {
    "MEMBERS_MONTHLY":"membersPerMonth",
    "MEMBERS_ MONTHLY":"membersPerMonth",       // handle stray space
    "MEMBERS_PRICE":"memberPrice",
    "DAY_PASSES_MONTHLY":"dayPassesPerMonth",
    "DAY_PASS_PRICE":"dayPassPrice",
    "OTHER_REV_MONTH":"otherPerMonth"
  };

  function groupRows(){
    bySection = {};
    rows.forEach(r=>{
      const sec = String(r["SECTION TITLE"] || r["Section"] || "").trim() || "Other";
      if (!bySection[sec]) bySection[sec] = [];
      bySection[sec].push(r);
    });
  }

  function valueFor(row){
  const sec = String(row["SECTION TITLE"] || "").toUpperCase();

  // All CAPEX is Year 1 ONLY
  if (sec.includes("CAPITAL") || sec.includes("EXPENDITURE") || sec.includes("CAPEX")) {
    return num(row["Year 1"]); 
  }

  // Everything else respects selected year
  const col = currentYear === 1 ? "Year 1" : "Year 2";
  return num(row[col]);
}

  function getCsvRevenueDrivers(){
    const out = {
      membersPerMonth:0,
      memberPrice:0,
      dayPassesPerMonth:0,
      dayPassPrice:0,
      otherPerMonth:0
    };
    const revRows = Object.keys(bySection)
      .filter(sec => String(sec).toUpperCase().includes("REVENUE"))
      .flatMap(sec => bySection[sec]);

    revRows.forEach(r=>{
      const raw = String(r["DESCRIPTION"] || "").trim().toUpperCase();
      const key = revenueDescriptionMap[raw];
      if (!key) return;
      out[key] = valueFor(r);
    });
    return out;
  }

  function getRevenueDrivers(){
    const csvVals = getCsvRevenueDrivers();
    return {
      membersPerMonth: driverOverrides.membersPerMonth ?? csvVals.membersPerMonth,
      memberPrice: driverOverrides.memberPrice ?? csvVals.memberPrice,
      dayPassesPerMonth: driverOverrides.dayPassesPerMonth ?? csvVals.dayPassesPerMonth,
      dayPassPrice: driverOverrides.dayPassPrice ?? csvVals.dayPassPrice,
      otherPerMonth: driverOverrides.otherPerMonth ?? csvVals.otherPerMonth
    };
  }

  function totalCapex(){
    let total = 0;
    Object.keys(bySection).forEach(sec=>{
      const up = sec.toUpperCase();
      if (up.includes("CAPEX") || up.includes("CAPITAL") || up.includes("FIT OUT")){
        bySection[sec].forEach(r=>{
          total += num(r["Year 1"]); // capex assumed one-off, based on Year 1
        });
      }
    });
    return total;
  }

  function totalOperatingCosts(){
    let total = 0;
    Object.keys(bySection).forEach(sec=>{
      const up = sec.toUpperCase();
      if (up.includes("REVENUE")) return;
      if (up.includes("CAPEX") || up.includes("CAPITAL") || up.includes("FIT OUT")) return;
      bySection[sec].forEach(r=>{
        total += valueFor(r);
      });
    });
    return total;
  }

  function setRevenueInputsFromCsv(){
    const rev = getCsvRevenueDrivers();
    document.getElementById("inMembersPerMonth").value = rev.membersPerMonth || "";
    document.getElementById("inMemberPrice").value = rev.memberPrice || "";
    document.getElementById("inDayPassesPerMonth").value = rev.dayPassesPerMonth || "";
    document.getElementById("inDayPassPrice").value = rev.dayPassPrice || "";
    document.getElementById("inOtherRevenuePerMonth").value = rev.otherPerMonth || "";
  }

  function readRevenueInputsToOverrides(){
    driverOverrides.membersPerMonth = parseFloat(document.getElementById("inMembersPerMonth").value);
    driverOverrides.memberPrice = parseFloat(document.getElementById("inMemberPrice").value);
    driverOverrides.dayPassesPerMonth = parseFloat(document.getElementById("inDayPassesPerMonth").value);
    driverOverrides.dayPassPrice = parseFloat(document.getElementById("inDayPassPrice").value);
    driverOverrides.otherPerMonth = parseFloat(document.getElementById("inOtherRevenuePerMonth").value);
  }

  function computeLoanMetrics(ebitda){
    const loan = num(document.getElementById("loanAmount").value);
    const ratePct = num(document.getElementById("loanRate").value);
    const months = Math.max(1, num(document.getElementById("loanMonths").value));
    const rMonthly = ratePct / 100 / 12;

    let mPayment;
    if (ratePct === 0){
      mPayment = loan / months;
    } else {
      mPayment = loan * rMonthly / (1 - Math.pow(1 + rMonthly, -months));
    }
    const annualDebt = mPayment * 12;
    const freeAfterDebt = ebitda - annualDebt;
    const debtPaybackYears = freeAfterDebt > 0 ? loan / freeAfterDebt : NaN;

    document.getElementById("loanAnnualDebt").textContent = "Annual debt service " + money(annualDebt);
    document.getElementById("loanTag").textContent = "Annual debt service " + money(annualDebt);
    document.getElementById("loanFreeCash").textContent = "EBITDA after debt " + money(freeAfterDebt);
    document.getElementById("loanPayback").textContent = isFinite(debtPaybackYears)
      ? "Debt payback " + debtPaybackYears.toFixed(1) + " years"
      : "Debt payback N/A";
  }

  function renderDetailTable(){
    const tbody = document.querySelector("#detailTable tbody");
    tbody.innerHTML = "";
    const yearLabel = currentYear === 1 ? "Year 1" : "Year 2";
    document.getElementById("detailYearLabel").textContent = yearLabel;

    const secNames = Object.keys(bySection);
    secNames.forEach(sec=>{
      const trHead = document.createElement("tr");
      trHead.className = "sec-row";
      const th1 = document.createElement("th");
      th1.colSpan = 3;
      th1.textContent = sec;
      trHead.appendChild(th1);
      tbody.appendChild(trHead);

      bySection[sec].forEach(r=>{
        const tr = document.createElement("tr");
        const tdSec = document.createElement("td");
        tdSec.textContent = "";
        const tdItem = document.createElement("td");
        tdItem.textContent = String(r["DESCRIPTION"] || "");
        const tdVal = document.createElement("td");
        tdVal.className = "num mono";
let displayValue = valueFor(r);

// If this is a CAPEX line and year 2 is selected, force it to zero
if (currentYear === 2) {
  const sec = (r["SECTION TITLE"] || "").toUpperCase();
  if (sec.includes("CAPEX") || sec.includes("CAPITAL") || sec.includes("FIT OUT")) {
    displayValue = 0;
  }
}

tdVal.textContent = money(displayValue);
        tr.appendChild(tdSec);
        tr.appendChild(tdItem);
        tr.appendChild(tdVal);
        tbody.appendChild(tr);
      });
    });
  }

  function recalc(){
    readRevenueInputsToOverrides();
    const rev = getRevenueDrivers();
    const annualRevenue = (rev.membersPerMonth * rev.memberPrice * 12)
      + (rev.dayPassesPerMonth * rev.dayPassPrice * 12)
      + (rev.otherPerMonth * 12);

let baseOperating = totalOperatingCosts();

// Remove CAPEX from Year 2 operating cost calculations
if (currentYear === 2) {
  Object.keys(bySection).forEach(sec=>{
    const up = sec.toUpperCase();
    if (up.includes("CAPEX") || up.includes("CAPITAL") || up.includes("FIT OUT")) {
      bySection[sec].forEach(r=>{
        baseOperating -= valueFor(r); // removes Yr2 capex if present
      });
    }
  });
}
    const ebitda = annualRevenue - baseOperating;
    const capex = totalCapex();

    // Update metrics
    document.getElementById("kmRevenue").textContent = money(annualRevenue);
    document.getElementById("kmEbitda").textContent = money(ebitda);
    document.getElementById("kmCapex").textContent = money(capex);
    document.getElementById("revTotalLabel").textContent = "Annual revenue " + money(annualRevenue);

    computeLoanMetrics(ebitda);
    renderDetailTable();
  }

  function attachListeners(){
    ["inMembersPerMonth","inMemberPrice","inDayPassesPerMonth","inDayPassPrice","inOtherRevenuePerMonth",
     "loanAmount","loanRate","loanMonths"
    ].forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("input", recalc);
    });

    document.getElementById("yearToggle").addEventListener("click", e=>{
      const btn = e.target.closest(".year-btn");
      if (!btn) return;
      const year = Number(btn.dataset.year) || 1;
      if (year === currentYear) return;
      currentYear = year;

      // visual state
      document.querySelectorAll(".year-btn").forEach(b=>{
        b.classList.toggle("active", b === btn);
      });

      // reset overrides and repopulate from CSV for new year
      Object.keys(driverOverrides).forEach(k=> driverOverrides[k] = null);
      setRevenueInputsFromCsv();
      recalc();
    });
  }

  function loadCsv(){
    Papa.parse(CSV_PATH,{
      download:true,
      header:true,
      skipEmptyLines:true,
      complete: res => {
        rows = res.data.map(r=>{
          Object.keys(r).forEach(k=>{
            if (r[k] === "") r[k] = null;
          });
          return r;
        });
        groupRows();
        setRevenueInputsFromCsv();
        recalc();
      },
      error: err => {
        console.error("CSV load error", err);
        alert("Could not load queensgate_bouldering_model.csv");
      }
    });
  }

  window.addEventListener("load", ()=>{
    attachListeners();
    loadCsv();
  });
</script>
</body>
</html>
