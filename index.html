<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Queensgate Bouldering • Financial Model</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    color-scheme: light dark;
    --gold:#fce38b;
    --blue:#6ba0cc;
    --ink:#101418;
    --paper:#f8fafc;
  }
  @media(prefers-color-scheme:dark){
    :root{--paper:#0b0b0c;--ink:#e6e6e6}
  }
  html,body{margin:0;background:var(--paper);color:var(--ink);font-family:system-ui}

  header{
    position:sticky;top:0;z-index:10;
    background:rgba(255,255,255,.97);
    border-bottom:2px solid var(--gold);
    backdrop-filter:saturate(1.1) blur(6px);
  }
  @media(prefers-color-scheme:dark){
    header{background:rgba(16,16,16,.97)}
  }

  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:grid;gap:12px}
  @media(min-width:900px){.row.cols-2{grid-template-columns:repeat(2,1fr)}}

  .card{
    background:#fff;padding:18px;border-radius:16px;
    border:2px solid #e5e7eb;margin-top:18px
  }
  @media(prefers-color-scheme:dark){
    .card{background:#121416;border-color:#222}
  }

  .kpi{font-size:30px;font-weight:900}
  .mono{font-variant-numeric:tabular-nums}

  input{
    width:100%;padding:8px;
    border-radius:10px;border:2px solid var(--blue);
    background:#fff;font-weight:800
  }

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th{text-align:left;font-size:12px;opacity:.7;padding:6px 0}
  td{padding:8px 0;border-top:1px solid #e5e7eb}
  @media(prefers-color-scheme:dark){
    td{border-color:#222}
  }
</style>
</head>

<body>

<header>
  <div class="wrap">
    <h1>Queensgate Bouldering • Financial Model</h1>
    <label style="display:flex;align-items:center;gap:8px;margin-top:10px;font-weight:700">
      <input type="checkbox" id="yearToggle">
      Use Year 1
    </label>
  </div>
</header>

<main class="wrap" style="padding-bottom:40px">

  <section class="row cols-2">
    <div class="card">
      <div class="kpi mono" id="kpiEbitda">£0</div>
      <div>EBITDA</div>
    </div>
    <div class="card">
      <div class="kpi mono" id="kpiCapex">£0</div>
      <div>CAPEX</div>
    </div>
  </section>

  <section class="card">
    <h2>Revenue drivers</h2>
    <div class="row cols-2" style="margin-top:12px">
      <div><label>Members per month</label><input id="drvMembers"></div>
      <div><label>Member price</label><input id="drvMemberPrice"></div>
      <div><label>Day passes</label><input id="drvDayPasses"></div>
      <div><label>Day pass price</label><input id="drvDayPrice"></div>
      <div><label>Other revenue</label><input id="drvOther"></div>
    </div>
  </section>

  <section class="card">
    <h2>Loan</h2>
    <div class="row cols-2">
      <div><label>Loan amount</label><input id="loanAmount" value="350000"></div>
      <div><label>Interest rate percent</label><input id="loanRate" value="7"></div>
      <div><label>Loan term (months)</label><input id="loanMonths" value="84"></div>
    </div>
  </section>

  <section class="card">
    <h2>Detailed view</h2>
    <div id="tableContainer"></div>
  </section>

</main>

<script>
let rows = [];
let bySection = {};
let useYear1 = false;

const money = n => "£" + Number(n).toLocaleString("en-GB",{maximumFractionDigits:0});
const num = v => parseFloat(String(v).replace(/[£,]/g,"")) || 0;

function group(){
  bySection = {};
  rows.forEach(r=>{
    const sec = r["SECTION TITLE"] || "Other";
    if(!bySection[sec]) bySection[sec] = [];
    bySection[sec].push(r);
  });
}

function val(row){
  return useYear1 ? num(row["Year 1"]) : num(row["Year 2"]);
}

function sectionTotal(sec){
  return (bySection[sec]||[]).reduce((a,r)=>a+val(r),0);
}

function normalise(s){
  return String(s||"").toUpperCase().replace(/[\s_]/g,"");
}

function readRevenue(){
  const rev = bySection["Revenue"] || bySection["REVENUE"] || [];
  const get = key => {
    const k = normalise(key);
    const row = rev.find(r => normalise(r["DESCRIPTION"])===k);
    return row ? val(row) : 0;
  };
  return {
    members: get("MEMBERSPERMONTH"),
    memberPrice: get("MEMBERPRICE"),
    dayPasses: get("DAYPASSES"),
    dayPrice: get("DAYPASSPRICE"),
    other: get("OTHERREVENUE")
  };
}

function computeRevenue(d){
  return (d.members*d.memberPrice + d.dayPasses*d.dayPrice + d.other) * 12;
}

function render(){
  const csvRev = readRevenue();

  const drv = {
    members: num(document.getElementById("drvMembers").value || csvRev.members),
    memberPrice: num(document.getElementById("drvMemberPrice").value || csvRev.memberPrice),
    dayPasses: num(document.getElementById("drvDayPasses").value || csvRev.dayPasses),
    dayPrice: num(document.getElementById("drvDayPrice").value || csvRev.dayPrice),
    other: num(document.getElementById("drvOther").value || csvRev.other),
  };

  const revenue = computeRevenue(drv);

  const operating = Object.keys(bySection)
    .filter(s => s.toUpperCase()!=="REVENUE" && !s.toUpperCase().includes("CAPEX"))
    .reduce((a,s)=>a + sectionTotal(s),0);

  const ebitda = revenue - operating;

  const capex = Object.keys(bySection)
    .filter(s => s.toUpperCase().includes("CAPEX"))
    .reduce((a,s)=>a + sectionTotal(s),0);

  document.getElementById("kpiEbitda").textContent = money(ebitda);
  document.getElementById("kpiCapex").textContent = money(capex);

  /* Table */
  let html = `<table><thead>
    <tr><th>Item</th><th>Value</th></tr>
  </thead><tbody>`;

  Object.keys(bySection).forEach(sec=>{
    html += `<tr><td colspan="2" style="font-weight:900;padding-top:14px">${sec}</td></tr>`;
    bySection[sec].forEach(r=>{
      html += `<tr>
        <td>${r["DESCRIPTION"]}</td>
        <td class="mono">${money(val(r))}</td>
      </tr>`;
    });
  });

  html += `</tbody></table>`;
  document.getElementById("tableContainer").innerHTML = html;
}

document.getElementById("yearToggle").addEventListener("change", e=>{
  useYear1 = e.target.checked;
  render();
});

["drvMembers","drvMemberPrice","drvDayPasses","drvDayPrice","drvOther",
 "loanAmount","loanRate","loanMonths"]
.forEach(id=>{
  document.getElementById(id).addEventListener("input", render);
});

Papa.parse("./queensgate_bouldering_model.csv",{
  download:true,
  header:true,
  complete:res=>{
    rows = res.data;
    group();
    render();
  }
});
</script>

</body>
</html>
