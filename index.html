<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Queensgate Bouldering Centre - Financial Model</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:#f5f7fa;color:#2c3e50;padding:20px}
  .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);overflow:hidden}
  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px}
  .header h1{font-size:2em;margin-bottom:10px}
  .content{padding:30px}
  .alert{display:none;background:#fdecea;color:#b71c1c;border:1px solid #ffcdd2;border-left:4px solid #b71c1c;padding:10px 12px;border-radius:8px;margin:12px 0}

  /* Assumptions */
  .assumptions{background:#fff9e6;border:1px solid #ffeb3b;border-radius:12px;padding:20px;margin-bottom:30px}
  .assumptions h3{color:#f39c12;margin-bottom:15px}
  .assumption-columns{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
  .assumption-group{background:#fff;border:1px solid #f1e4b5;border-radius:10px;overflow:hidden}
  .assumption-group-header{background:#fff4cc;padding:10px 14px;border-bottom:1px solid #f1e4b5;font-weight:700}
  .assumption-grid{display:grid;grid-template-columns:1fr;gap:10px;padding:14px}
  .assumption-item{display:flex;flex-direction:column;gap:6px}
  .assumption-item label{font-size:.9em;color:#555;text-align:left}
  .assumption-item small{color:#999}
  .assumption-item input,.assumption-item select{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:16px;text-align:right}

  .scenario-buttons{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
  .scenario-btn{padding:10px 20px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:8px;cursor:pointer;font-weight:600;min-height:44px}
  .scenario-btn.active,.scenario-btn[aria-pressed="true"]{background:#667eea;color:#fff;box-shadow:0 0 0 2px #667eea22 inset}

  /* Key metrics */
  .key-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;padding:20px;background:#f8f9fa;border-radius:10px}
  .metric{text-align:center}
  .metric-value{font-size:1.6em;font-weight:700;color:#667eea}
  .metric-label{font-size:.9em;color:#666;margin-top:5px}
  .positive{color:#27ae60}.negative{color:#e74c3c}

  /* Sections */
  .section{margin-bottom:30px;border:1px solid #e0e0e0;border-radius:10px;overflow:hidden}
  .section-header{background:#f8f9fa;padding:15px 20px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center}
  .section-title{font-size:1.2em;font-weight:600}
  .section-total{font-size:1.1em;font-weight:700;color:#667eea}
  .section-content{padding:20px}
  .line-item{display:grid;grid-template-columns:1fr 170px 170px;gap:20px;padding:12px 0;border-bottom:1px solid #f0f0f0;align-items:center}
  .line-item:last-child{border-bottom:none}
  .line-item-name{font-size:.95em}
  .line-item-desc{font-size:.85em;color:#666;margin-top:2px}
  .line-item input{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:16px;text-align:right}
  .line-item-total{text-align:right;font-weight:600}

  .summary-table{background:#f8f9fa;border-radius:10px;padding:20px;margin-top:30px}
  .summary-table h3{margin-bottom:12px}
  .summary-row{display:grid;grid-template-columns:1fr 220px;gap:20px;padding:12px 0;border-bottom:1px solid #e0e0e0}
  .summary-row:last-child{border-bottom:none;font-weight:700;font-size:1.05em}

  @media(max-width:1024px){.assumption-columns{grid-template-columns:1fr}}
  @media(max-width:768px){
    .content{padding:14px}
    .line-item{grid-template-columns:1fr;gap:10px}
    .line-item-total{text-align:left}
    .summary-row{grid-template-columns:1fr;gap:6px}
    .key-metrics{grid-template-columns:repeat(2,1fr);gap:12px;padding:14px}
    .scenario-btn{flex:1 1 calc(50% - 8px)}
  }
  @media(max-width:400px){.key-metrics{grid-template-columns:1fr}.scenario-btn{flex:1 1 100%}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ðŸ§— Queensgate Bouldering Centre - Financial Model</h1>
    <p><strong>Purpose:</strong> Source-backed projections with scenario toggles. Realistic uses your CSV. Conservative and Optimistic apply sensible integer adjustments.</p>
  </div>

  <div class="content">
    <div id="alert" class="alert"></div>

    <!-- Key Assumptions & Configuration -->
    <div class="assumptions">
      <h3>ðŸ”‘ Key Assumptions & Configuration</h3>

      <div class="assumption-columns">
        <!-- Setup costs (CAPEX) -->
        <div class="assumption-group">
          <div class="assumption-group-header">Setup costs (CAPEX)</div>
          <div class="assumption-grid">
            <div class="assumption-item">
              <label>Climbing Construction (Â£) <small>Walls, matting, equipment, holds</small></label>
              <input type="number" id="capex-climbing" value="300000" min="0" step="1" onchange="calculateAll()">
            </div>
            <div class="assumption-item">
              <label>General Construction (Â£) <small>Cafe, bar, reception areas</small></label>
              <input type="number" id="capex-general" value="150000" min="0" step="1" onchange="calculateAll()">
            </div>
            <div class="assumption-item">
              <label>Facilities Construction (Â£) <small>Dry changing rooms, toilets</small></label>
              <input type="number" id="capex-facilities" value="30000" min="0" step="1" onchange="calculateAll()">
            </div>
            <div class="assumption-item">
              <label>Software, Licences, Permits (Â£)</label>
              <input type="number" id="capex-software" value="8000" min="0" step="1" onchange="calculateAll()">
            </div>
            <div class="assumption-item">
              <label>Branding & Launch (Â£)</label>
              <input type="number" id="capex-branding" value="20000" min="0" step="1" onchange="calculateAll()">
            </div>
            <div class="assumption-item">
              <label>VAT Rate (%)</label>
              <input type="number" id="vat-rate" value="20" min="0" step="1" onchange="calculateAll()">
            </div>
            <div class="assumption-item">
              <label>VAT Reclaimable?</label>
              <select id="vat-reclaimable" onchange="calculateAll()">
                <option value="yes" selected>Yes</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Operating costs (OPEX) -->
        <div class="assumption-group">
          <div class="assumption-group-header">Operating costs (OPEX)</div>
          <div class="assumption-grid">
            <div class="assumption-item"><label>Annual Rent (Â£)</label><input type="number" id="annual-rent" value="56000" min="0" step="1" onchange="calculateAll()" title="Use effective rent or year figure"></div>
            <div class="assumption-item"><label>Business Rates (Â£)</label><input type="number" id="business-rates" value="35000" min="0" step="1" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Centre Manager (Â£)</label><input type="number" id="manager-salary" value="36000" min="0" step="1" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Route Setting (Â£)</label><input type="number" id="route-setter-salary" value="26000" min="0" step="1" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Other Staff (Â£)</label><input type="number" id="other-staff" value="50000" min="0" step="1" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Utilities (Â£)</label><input type="number" id="utilities" value="24000" min="0" step="1" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Insurance (Â£)</label><input type="number" id="insurance" value="3000" min="0" step="1" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Marketing (Â£)</label><input type="number" id="marketing-annual" value="12000" min="0" step="1" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Maintenance & Holds Refresh (Â£)</label><input type="number" id="maintenance" value="10000" min="0" step="1" onchange="calculateAll()"></div>
          </div>
        </div>

        <!-- Revenue -->
        <div class="assumption-group">
          <div class="assumption-group-header">Revenue</div>
          <div class="assumption-grid">
            <div class="assumption-item"><label>Monthly Membership (Â£)</label><input type="number" id="membership-price" value="70" min="0" step="1" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Total Members</label><input type="number" id="members-count" value="450" min="0" step="1" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Day Pass Price (Â£)</label><input type="number" id="day-pass-price" value="14" min="0" step="1" onchange="calculateAll()"></div>
            <div class="assumption-item"><label>Day Passes / Month</label><input type="number" id="day-passes-monthly" value="600" min="0" step="1" onchange="calculateAll()"></div>
            <div class="assumption-item">
              <label style="color:#777">Advanced revenue inputs</label>
              <div style="font-size:.9em;color:#777;text-align:left">Coaching, parties, rental, retail and cafe can be edited in the Revenue section below.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="scenario-buttons" role="group" aria-label="Scenario">
        <button class="scenario-btn" data-scenario="conservative" aria-pressed="false">Conservative</button>
        <button class="scenario-btn" data-scenario="realistic" aria-pressed="true">Realistic</button>
        <button class="scenario-btn" data-scenario="optimistic" aria-pressed="false">Optimistic</button>
      </div>
    </div>

    <!-- Key Metrics -->
    <div class="key-metrics">
      <div class="metric"><div class="metric-value" id="capex-exvat">Â£0</div><div class="metric-label">CAPEX ex VAT</div></div>
      <div class="metric"><div class="metric-value" id="capex-incvat">Â£0</div><div class="metric-label">CAPEX incl VAT</div></div>
      <div class="metric"><div class="metric-value" id="annual-revenue">Â£0</div><div class="metric-label">Annual Revenue</div></div>
      <div class="metric"><div class="metric-value" id="annual-profit">Â£0</div><div class="metric-label">Annual Profit (EBITDA)</div></div>
      <div class="metric"><div class="metric-value" id="roi">0%</div><div class="metric-label">ROI</div></div>
      <div class="metric"><div class="metric-value" id="payback-period">0 years</div><div class="metric-label">Payback Period</div></div>
    </div>

    <!-- CAPEX Section -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">ðŸ’° Capital Expenditure</div>
        <div class="section-total" id="capex-total">Â£0</div>
      </div>
      <div class="section-content" id="capex-breakdown">
        <!-- Built dynamically to mirror the five groups and show sub-lines -->
      </div>
    </div>

    <!-- Revenue -->
    <div class="section">
      <div class="section-header"><div class="section-title">ðŸ“ˆ Annual Revenue Streams</div><div class="section-total" id="revenue-total">Â£0</div></div>
      <div class="section-content">
        <div class="line-item">
          <div><div class="line-item-name">Memberships</div><div class="line-item-desc">= Members Ã— Â£ per month Ã— 12</div></div>
          <input type="text" value="Edit members and price in assumptions" readonly style="background:#f5f5f5;text-align:left">
          <div class="line-item-total" id="membership-revenue-total">Â£0</div>
        </div>
        <div class="line-item">
          <div><div class="line-item-name">Day Passes</div><div class="line-item-desc">= Passes per month Ã— Â£ Ã— 12</div></div>
          <input type="text" value="Edit passes and price in assumptions" readonly style="background:#f5f5f5;text-align:left">
          <div class="line-item-total" id="day-pass-revenue-total">Â£0</div>
        </div>
        <div class="line-item">
          <div><div class="line-item-name">Coaching and Classes</div></div>
          <div><input type="number" id="coaching-sessions" value="40" min="0" step="1" onchange="calculateAll()" title="sessions per month"></div>
          <div><input type="number" id="coaching-price" value="55" min="0" step="1" onchange="calculateAll()" title="Â£ per session"></div>
          <div class="line-item-total" id="coaching-revenue-total">Â£0</div>
        </div>
        <div class="line-item">
          <div><div class="line-item-name">Parties and Youth Clubs</div></div>
          <div><input type="number" id="parties-monthly" value="12" min="0" step="1" onchange="calculateAll()" title="events per month"></div>
          <div><input type="number" id="party-revenue" value="150" min="0" step="1" onchange="calculateAll()" title="Â£ per event"></div>
          <div class="line-item-total" id="youth-revenue-total">Â£0</div>
        </div>
        <div class="line-item">
          <div><div class="line-item-name">Equipment Rental (net)</div></div>
          <div><input type="number" id="rental-monthly" value="800" min="0" step="1" onchange="calculateAll()" title="Â£ per month"></div>
          <input type="text" value="â€”" readonly style="background:#f5f5f5">
          <div class="line-item-total" id="rental-revenue-total">Â£0</div>
        </div>
        <div class="line-item">
          <div><div class="line-item-name">Retail (net)</div></div>
          <div><input type="number" id="retail-monthly" value="1200" min="0" step="1" onchange="calculateAll()" title="Â£ per month"></div>
          <input type="text" value="â€”" readonly style="background:#f5f5f5">
          <div class="line-item-total" id="retail-revenue-total">Â£0</div>
        </div>
        <div class="line-item">
          <div><div class="line-item-name">Cafe (net)</div></div>
          <div><input type="number" id="cafe-monthly" value="4000" min="0" step="1" onchange="calculateAll()" title="GMV Â£ per month"></div>
          <div><input type="number" id="cafe-margin" value="8" min="0" step="1" onchange="calculateAll()" title="Net percent"></div>
          <div class="line-item-total" id="cafe-revenue-total">Â£0</div>
        </div>
      </div>
    </div>

    <!-- OPEX -->
    <div class="section">
      <div class="section-header"><div class="section-title">ðŸ’¸ Annual Operating Expenses</div><div class="section-total" id="expenses-total">Â£0</div></div>
      <div class="section-content">
        <div class="line-item"><div><div class="line-item-name">Annual Rent</div></div><input type="text" value="Use effective or scheduled" readonly style="background:#f5f5f5;text-align:left"><div class="line-item-total" id="rent-cost-total">Â£0</div></div>
        <div class="line-item"><div><div class="line-item-name">Business Rates</div></div><div><input type="number" id="business-rates" value="35000" min="0" step="1" onchange="calculateAll()"></div><div class="line-item-total" id="business-rates-total">Â£0</div></div>
        <div class="line-item"><div><div class="line-item-name">Centre Manager</div></div><div><input type="number" id="manager-salary" value="36000" min="0" step="1" onchange="calculateAll()"></div><div class="line-item-total" id="manager-salary-total">Â£0</div></div>
        <div class="line-item"><div><div class="line-item-name">Route Setting</div></div><div><input type="number" id="route-setter-salary" value="26000" min="0" step="1" onchange="calculateAll()"></div><div class="line-item-total" id="route-setter-salary-total">Â£0</div></div>
        <div class="line-item"><div><div class="line-item-name">Other Staff</div></div><div><input type="number" id="other-staff" value="50000" min="0" step="1" onchange="calculateAll()"></div><div class="line-item-total" id="other-staff-total">Â£0</div></div>
        <div class="line-item"><div><div class="line-item-name">Utilities</div></div><div><input type="number" id="utilities" value="24000" min="0" step="1" onchange="calculateAll()"></div><div class="line-item-total" id="utilities-total">Â£0</div></div>
        <div class="line-item"><div><div class="line-item-name">Insurance</div></div><div><input type="number" id="insurance" value="3000" min="0" step="1" onchange="calculateAll()"></div><div class="line-item-total" id="insurance-total">Â£0</div></div>
        <div class="line-item"><div><div class="line-item-name">Marketing</div></div><div><input type="number" id="marketing-annual" value="12000" min="0" step="1" onchange="calculateAll()"></div><div class="line-item-total" id="marketing-annual-total">Â£0</div></div>
        <div class="line-item"><div><div class="line-item-name">Maintenance and Holds Refresh</div></div><div><input type="number" id="maintenance" value="10000" min="0" step="1" onchange="calculateAll()"></div><div class="line-item-total" id="maintenance-total">Â£0</div></div>
      </div>
    </div>

    <!-- Financial Summary -->
    <div class="summary-table">
      <h3>ðŸ“Š Annual Financial Performance</h3>
      <div class="summary-row"><div>Total Annual Revenue</div><div id="annual-revenue-summary">Â£0</div></div>
      <div class="summary-row"><div>Total Annual Expenses</div><div id="annual-expenses-summary">Â£0</div></div>
      <div class="summary-row"><div>Annual Profit (EBITDA)</div><div id="annual-ebitda" class="negative">Â£0</div></div>
      <div class="summary-row"><div>Profit Margin</div><div id="annual-margin">0%</div></div>
      <div class="summary-row"><div>ROI (basis shown)</div><div id="roi-summary">0%</div></div>
      <div class="summary-row"><div>Payback Period</div><div id="payback-summary">0 years</div></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  // formatting helpers
  function toInt(v){ const x = Math.floor(Number(v)); return isFinite(x) ? x : 0; }
  function money(v){ const f = toInt(v); return (f < 0 ? '-Â£' : 'Â£') + Math.abs(f).toLocaleString('en-GB'); }
  function pct(v){ const p = Math.round(Number(v)); return isFinite(p) ? p + '%' : '0%'; }

  // scenario overlays, integer only
  const SCENARIO_OVERLAYS = {
    conservative: {
      'members-count': v => Math.max(0, Math.round(v*0.85)),
      'membership-price': v => Math.round(v*0.98),
      'day-passes-monthly': v => Math.max(0, Math.round(v*0.80)),
      'day-pass-price': v => Math.round(v*0.98),
      'coaching-sessions': () => 30,
      'coaching-price': () => 50,
      'parties-monthly': () => 9,
      'party-revenue': () => 140,
      'rental-monthly': () => 700,
      'retail-monthly': () => 1000,
      'cafe-monthly': () => 3500,
      'cafe-margin': () => 8,
      'utilities': v => Math.round(v*0.96),
      'marketing-annual': v => Math.round(v*0.85),
      'maintenance': v => Math.round(v*0.90)
    },
    optimistic: {
      'members-count': v => Math.round(v*1.20),
      'membership-price': v => Math.round(v*1.03),
      'day-passes-monthly': v => Math.round(v*1.25),
      'day-pass-price': v => Math.round(v*1.03),
      'coaching-sessions': () => 60,
      'coaching-price': () => 60,
      'parties-monthly': () => 16,
      'party-revenue': () => 160,
      'rental-monthly': () => 1200,
      'retail-monthly': () => 1800,
      'cafe-monthly': () => 7000,
      'cafe-margin': () => 9,
      'utilities': v => Math.round(v*1.10),
      'marketing-annual': v => Math.round(v*1.15),
      'maintenance': v => Math.round(v*1.15)
    }
  };

  // CAPEX group breakdown patterns
  const CAPEX_BREAKDOWN = {
    climbing: [
      {name:'Walls', share:60},
      {name:'Safety matting', share:15},
      {name:'Equipment', share:15},
      {name:'Initial holds', share:10}
    ],
    general: [
      {name:'Reception area', share:25},
      {name:'Cafe build', share:35},
      {name:'Bar servery', share:20},
      {name:'Storage and back of house', share:10},
      {name:'Office and admin', share:10}
    ],
    facilities: [
      {name:'Dry changing rooms', share:60},
      {name:'Toilets', share:40}
    ],
    software: [
      {name:'Membership software', share:25},
      {name:'POS system and terminals', share:25},
      {name:'Licences and permits', share:50}
    ],
    branding: [
      {name:'Brand identity and signage', share:60},
      {name:'Launch campaign', share:40}
    ]
  };

  function renderCapexSection(){
    const wrap = document.getElementById('capex-breakdown');
    const groups = [
      {id:'capex-climbing', label:'Climbing Construction', key:'climbing'},
      {id:'capex-general', label:'General Construction', key:'general'},
      {id:'capex-facilities', label:'Facilities Construction', key:'facilities'},
      {id:'capex-software', label:'Software, Licences, Permits', key:'software'},
      {id:'capex-branding', label:'Branding and Launch', key:'branding'}
    ];

    function rowsForGroup(total, items){
      const t = toInt(total);
      let allocated = 0;
      return items.map((it, idx) => {
        let val = Math.round(t * it.share / 100);
        allocated += val;
        if(idx === items.length - 1){ val += (t - allocated); }
        return {name: it.name, value: val, share: it.share};
      });
    }

    wrap.innerHTML = '';
    groups.forEach(g => {
      const total = toInt(document.getElementById(g.id).value);
      const rows = rowsForGroup(total, CAPEX_BREAKDOWN[g.key]);

      const groupHeader = document.createElement('div');
      groupHeader.className = 'line-item';
      groupHeader.innerHTML = `
        <div>
          <div class="line-item-name"><strong>${g.label}</strong></div>
          <div class="line-item-desc">Allocated by item percentages</div>
        </div>
        <input type="text" value="Editable above" readonly style="background:#f5f5f5;text-align:left">
        <div class="line-item-total">${money(total)}</div>
      `;
      wrap.appendChild(groupHeader);

      rows.forEach(r=>{
        const row = document.createElement('div');
        row.className = 'line-item';
        row.innerHTML = `
          <div><div class="line-item-name">${r.name}</div></div>
          <input type="text" value="${pct(r.share)}" readonly style="background:#f5f5f5;text-align:left">
          <div class="line-item-total">${money(r.value)}</div>
        `;
        wrap.appendChild(row);
      });

      const divider = document.createElement('div');
      divider.style.borderBottom = '1px solid #eee';
      wrap.appendChild(divider);
    });
  }

  function toIntSafe(id, fallback){ const el = document.getElementById(id); return el ? toInt(el.value) : toInt(fallback); }

  function calculateAll(){
    // CAPEX
    const capClimb = toIntSafe('capex-climbing', 300000);
    const capGen = toIntSafe('capex-general', 150000);
    const capFac = toIntSafe('capex-facilities', 30000);
    const capSoft = toIntSafe('capex-software', 8000);
    const capBrand = toIntSafe('capex-branding', 20000);
    const capexExVat = capClimb + capGen + capFac + capSoft + capBrand;

    const vatRate = toIntSafe('vat-rate', 20) / 100;
    const vatReclaim = String(document.getElementById('vat-reclaimable').value || '').toLowerCase() === 'yes';
    const capexIncVat = capexExVat * (1 + vatRate);
    const capexBasis = vatReclaim ? capexExVat : capexIncVat;

    document.getElementById('capex-exvat').textContent = money(capexExVat);
    document.getElementById('capex-incvat').textContent = money(capexIncVat);
    document.getElementById('capex-total').textContent = money(capexBasis);

    // Demand and pricing
    const memberPrice = toIntSafe('membership-price', 70);
    const members = toIntSafe('members-count', 450);
    const dayPassPrice = toIntSafe('day-pass-price', 14);
    const dayPassesPerMonth = toIntSafe('day-passes-monthly', 600);

    // Revenue detail
    const coachSessions = toIntSafe('coaching-sessions', 40);
    const coachPrice = toIntSafe('coaching-price', 55);
    const partiesM = toIntSafe('parties-monthly', 12);
    const partyPrice = toIntSafe('party-revenue', 150);
    const rentalMonthly = toIntSafe('rental-monthly', 800);
    const retailMonthly = toIntSafe('retail-monthly', 1200);
    const cafeMonthly = toIntSafe('cafe-monthly', 4000);
    const cafeMargin = toIntSafe('cafe-margin', 8) / 100;

    const membershipRevenue = members * memberPrice * 12;
    const dayPassRevenue = dayPassesPerMonth * dayPassPrice * 12;
    const coachingRevenue = coachSessions * coachPrice * 12;
    const youthRevenue = partiesM * partyPrice * 12;
    const rentalRevenue = rentalMonthly * 12;
    const retailRevenue = retailMonthly * 12;
    const cafeNetRevenue = Math.round(cafeMonthly * cafeMargin) * 12;

    const totalRevenue = membershipRevenue + dayPassRevenue + coachingRevenue + youthRevenue + rentalRevenue + retailRevenue + cafeNetRevenue;

    document.getElementById('membership-revenue-total').textContent = money(membershipRevenue);
    document.getElementById('day-pass-revenue-total').textContent = money(dayPassRevenue);
    document.getElementById('coaching-revenue-total').textContent = money(coachingRevenue);
    document.getElementById('youth-revenue-total').textContent = money(youthRevenue);
    document.getElementById('rental-revenue-total').textContent = money(rentalRevenue);
    document.getElementById('retail-revenue-total').textContent = money(retailRevenue);
    document.getElementById('cafe-revenue-total').textContent = money(cafeNetRevenue);
    document.getElementById('revenue-total').textContent = money(totalRevenue);
    document.getElementById('annual-revenue').textContent = money(totalRevenue);
    document.getElementById('annual-revenue-summary').textContent = money(totalRevenue);

    // OPEX
    const rent = toIntSafe('annual-rent', 56000);
    const rates = toIntSafe('business-rates', 35000);
    const mgr = toIntSafe('manager-salary', 36000);
    const rs = toIntSafe('route-setter-salary', 26000);
    const staffOther = toIntSafe('other-staff', 50000);
    const utils = toIntSafe('utilities', 24000);
    const ins = toIntSafe('insurance', 3000);
    const mkt = toIntSafe('marketing-annual', 12000);
    const maint = toIntSafe('maintenance', 10000);

    const totalExpenses = rent + rates + mgr + rs + staffOther + utils + ins + mkt + maint;

    document.getElementById('rent-cost-total').textContent = money(rent);
    document.getElementById('business-rates-total').textContent = money(rates);
    document.getElementById('manager-salary-total').textContent = money(mgr);
    document.getElementById('route-setter-salary-total').textContent = money(rs);
    document.getElementById('other-staff-total').textContent = money(staffOther);
    document.getElementById('utilities-total').textContent = money(utils);
    document.getElementById('insurance-total').textContent = money(ins);
    document.getElementById('marketing-annual-total').textContent = money(mkt);
    document.getElementById('maintenance-total').textContent = money(maint);
    document.getElementById('expenses-total').textContent = money(totalExpenses);
    document.getElementById('annual-expenses-summary').textContent = money(totalExpenses);

    // EBITDA / ROI / Payback
    const ebitda = totalRevenue - totalExpenses;
    const roiPct = capexBasis > 0 ? Math.round((ebitda / capexBasis) * 100) : 0;
    const paybackYears = ebitda > 0 ? (capexBasis / ebitda) : 0;

    document.getElementById('annual-profit').textContent = money(ebitda);
    document.getElementById('annual-profit').className = 'metric-value ' + (ebitda > 0 ? 'positive':'negative');
    document.getElementById('annual-ebitda').textContent = money(ebitda);
    document.getElementById('annual-ebitda').className = ebitda > 0 ? 'positive':'negative';
    document.getElementById('annual-margin').textContent = pct(Math.round((ebitda / Math.max(totalRevenue,1)) * 100));
    document.getElementById('roi').textContent = pct(roiPct);
    document.getElementById('roi-summary').textContent = pct(roiPct);
    document.getElementById('payback-period').textContent = ebitda > 0 ? (Math.round(paybackYears * 10)/10) + ' years' : 'N/A';
    document.getElementById('payback-summary').textContent = ebitda > 0 ? (Math.round(paybackYears * 10)/10) + ' years' : 'N/A';

    renderCapexSection();
  }

  // CSV hydrate
  async function loadRealisticFromCSV(){
    try{
      const res = await fetch('queensgate_bouldering_provenance.csv',{cache:'no-store'});
      if(!res.ok){ showAlert('CSV not found next to index.html. Using defaults.'); calculateAll(); return; }
      const text = await res.text();
      const parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
      const rows = parsed.data || [];
      const map = {};
      rows.forEach(r=>{
        const k = String(r['Variable']||'').trim();
        const v = String(r['Value']||'').trim();
        if(k) map[k]=v;
      });

      // Demand and pricing
      setIf('members-count', map.MEMBERS_COUNT);
      setIf('membership-price', map.MEMBERSHIP_PRICE);
      setIf('day-passes-monthly', map.DAY_PASSES_MONTHLY);
      setIf('day-pass-price', map.DAY_PASS_PRICE);

      // Opex
      setIf('annual-rent', map.RENT);
      setIf('business-rates', map.BUSINESS_RATES);
      if(map.MANAGER_SALARY) setIf('manager-salary', map.MANAGER_SALARY);
      if(map.ROUTE_SETTER_SALARY) setIf('route-setter-salary', map.ROUTE_SETTER_SALARY);
      if(map.OTHER_STAFF) setIf('other-staff', map.OTHER_STAFF);
      if(map.SALARIES && !map.OTHER_STAFF && !map.MANAGER_SALARY && !map.ROUTE_SETTER_SALARY){
        setIf('other-staff', map.SALARIES);
      }
      setIf('utilities', map.UTILITIES);
      setIf('insurance', map.INSURANCE);
      setIf('marketing-annual', map.MARKETING);
      setIf('maintenance', map.MAINTENANCE);

      // VAT
      if(map.VAT_RATE) setIf('vat-rate', map.VAT_RATE);
      if(map.VAT_RECLAIMABLE) document.getElementById('vat-reclaimable').value = String(map.VAT_RECLAIMABLE).toLowerCase().startsWith('y') ? 'yes' : 'no';

      // CAPEX grouping from granular CSV where available
      const climbSum = sumKeys(map, ['CAPEX_WALLS','CAPEX_MATTING','MEZZANINE_COST','HOLDS_BUDGET','GYM_EQUIPMENT']);
      if(climbSum>0) setIf('capex-climbing', climbSum);

      if(map.CAPEX_GENERAL_CONSTRUCTION) setIf('capex-general', map.CAPEX_GENERAL_CONSTRUCTION);
      if(map.CAPEX_FACILITIES) setIf('capex-facilities', map.CAPEX_FACILITIES);

      const softSum = sumKeys(map, ['SOFTWARE_POS','LICENSES_PERMITS']);
      if(softSum>0) setIf('capex-software', softSum);

      if(map.BRANDING_MARKETING) setIf('capex-branding', map.BRANDING_MARKETING);

      calculateAll();
    }catch(e){
      console.error(e);
      showAlert('Problem reading CSV. Using defaults.');
      calculateAll();
    }
  }

  function setIf(id, val){
    if(val==null || val==='') return;
    const el = document.getElementById(id);
    if(!el) return;
    el.value = toInt(val);
  }

  function sumKeys(map, keys){
    return keys.reduce((s,k)=> s + (map[k] ? toInt(map[k]) : 0), 0);
  }

  function showAlert(msg){
    const el = document.getElementById('alert');
    el.textContent = msg;
    el.style.display = 'block';
  }

  function updateScenarioButtons(active){
    document.querySelectorAll('.scenario-btn').forEach(btn=>{
      const isActive = btn.dataset.scenario === active;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
  }

  function applyScenario(name){
    loadRealisticFromCSV().then(()=>{
      if(name === 'realistic'){ updateScenarioButtons('realistic'); return; }
      const overlay = SCENARIO_OVERLAYS[name] || {};
      Object.keys(overlay).forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const current = toInt(el.value);
        el.value = overlay[id](current);
      });
      updateScenarioButtons(name);
      calculateAll();
    });
  }

  function attachScenarioListeners(){
    document.querySelectorAll('.scenario-btn').forEach(btn=>{
      if(btn.__attached) return;
      btn.addEventListener('click', ()=> applyScenario(btn.dataset.scenario), {passive:true});
      btn.__attached = true;
    });
  }

  window.addEventListener('load', ()=>{
    attachScenarioListeners();
    loadRealisticFromCSV();
    updateScenarioButtons('realistic');
  });
</script>
</body>
</html>
