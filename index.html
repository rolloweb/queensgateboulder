<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Queensgate Bouldering • Financial Model</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { color-scheme: light dark; }
    .card { @apply bg-white/70 dark:bg-white/5 backdrop-blur rounded-2xl shadow p-5; }
    .pill { @apply px-3 py-1 rounded-full text-sm font-semibold; }
    .btn { @apply px-4 py-2 rounded-xl font-semibold border border-black/10 dark:border-white/10; }
    .btn.active { @apply bg-black text-white dark:bg-white dark:text-black; }
    .kpi { @apply text-3xl md:text-4xl font-extrabold; }
    .kpi-sub { @apply text-sm text-black/60 dark:text-white/60; }
    .mono { font-variant-numeric: tabular-nums; }
    .table thead th { @apply text-left text-xs md:text-sm uppercase tracking-wide text-black/60 dark:text-white/60; }
    .table td, .table th { @apply py-2 align-top; }
    .sticky-top { position: sticky; top: 0; z-index: 20; }
    .tooltip { position: relative; cursor: help; }
    .tooltip .tip {
      visibility: hidden; opacity: 0; transition: opacity .15s ease;
      position: absolute; left: 0; bottom: 120%; width: 20rem; max-width: 70vw;
      @apply bg-black text-white text-xs p-3 rounded-xl shadow;
    }
    .tooltip:hover .tip { visibility: visible; opacity: 1; }
  </style>
</head>
<body class="bg-slate-50 dark:bg-neutral-900 text-slate-900 dark:text-slate-100 min-h-screen">
  <header class="sticky-top bg-slate-50/80 dark:bg-neutral-900/80 backdrop-blur border-b border-black/5 dark:border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-2xl md:text-3xl font-black">Queensgate Bouldering • Financial Model</h1>
        <p class="text-sm text-black/60 dark:text-white/60">Interactive view for banks and investors. Data source: CSV in this folder.</p>
      </div>
      <div class="flex items-center gap-2" id="scenarioButtons" role="tablist" aria-label="Scenarios">
        <button class="btn active" data-scenario="Conservative" role="tab" aria-selected="true">Conservative</button>
        <button class="btn" data-scenario="Realistic" role="tab" aria-selected="false">Realistic</button>
        <button class="btn" data-scenario="Optimistic" role="tab" aria-selected="false">Optimistic</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- KPI Row -->
    <section class="grid md:grid-cols-4 gap-4">
      <div class="card">
        <div class="kpi mono" id="kpiRevenue">£0</div>
        <div class="kpi-sub">Annual revenue</div>
      </div>
      <div class="card">
        <div class="kpi mono" id="kpiCosts">£0</div>
        <div class="kpi-sub">Annual operating costs</div>
      </div>
      <div class="card">
        <div class="kpi mono" id="kpiEbitda">£0</div>
        <div class="kpi-sub">EBITDA</div>
        <div class="text-xs text-black/60 dark:text-white/60 mono" id="kpiMargin">0%</div>
      </div>
      <div class="card">
        <div class="kpi mono" id="kpiCapex">£0</div>
        <div class="kpi-sub">Startup capex</div>
      </div>
    </section>

    <!-- Break even and drivers -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="card">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-bold">Monthly break even</h2>
          <span class="pill bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-200" id="scenarioTag">Conservative</span>
        </div>
        <p class="text-sm text-black/60 dark:text-white/60 mt-2">Based on current month volumes in the CSV for the chosen scenario.</p>
        <div class="mt-3 space-y-1">
          <div class="flex items-baseline justify-between">
            <span class="text-sm">Monthly cost to cover</span>
            <span class="mono" id="beCost">£0</span>
          </div>
          <div class="flex items-baseline justify-between">
            <span class="text-sm">Revenue from day passes and other</span>
            <span class="mono" id="beOtherRev">£0</span>
          </div>
          <div class="flex items-baseline justify-between">
            <span class="text-sm">Members required</span>
            <span class="mono text-xl font-black" id="membersReq">0</span>
          </div>
          <p class="text-xs text-black/60 dark:text-white/60 mt-2">If this number is below the current member count, you are above break even on the given mix.</p>
        </div>
      </div>
      <div class="card">
        <h2 class="text-lg font-bold">Revenue drivers</h2>
        <div class="grid grid-cols-2 gap-3 mt-3 text-sm">
          <div><div class="text-black/60 dark:text-white/60">Members per month</div><div class="mono text-xl font-bold" id="drvMembers">0</div></div>
          <div><div class="text-black/60 dark:text-white/60">Member price</div><div class="mono text-xl font-bold" id="drvMemberPrice">£0</div></div>
          <div><div class="text-black/60 dark:text-white/60">Day passes per month</div><div class="mono text-xl font-bold" id="drvDayPasses">0</div></div>
          <div><div class="text-black/60 dark:text-white/60">Day pass price</div><div class="mono text-xl font-bold" id="drvDayPassPrice">£0</div></div>
          <div class="col-span-2"><div class="text-black/60 dark:text-white/60">Other revenue per month</div><div class="mono text-xl font-bold" id="drvOther">£0</div></div>
        </div>
      </div>
      <div class="card">
        <h2 class="text-lg font-bold">Revenue vs costs</h2>
        <canvas id="revCostChart" aria-label="Revenue vs Costs chart"></canvas>
      </div>
    </section>

    <!-- Detailed Table -->
    <section class="card">
      <div class="flex items-baseline justify-between mb-2">
        <h2 class="text-lg font-bold">Detailed view</h2>
        <div class="text-sm text-black/60 dark:text-white/60">Values reflect the selected scenario. Capex is one time.</div>
      </div>
      <div id="tableContainer" class="overflow-x-auto">
        <!-- Filled by JS -->
      </div>
    </section>

    <!-- Sources -->
    <section class="card">
      <h2 class="text-lg font-bold">Notes from CSV</h2>
      <p class="text-sm text-black/60 dark:text-white/60">Hover the “i” markers in the table to read line notes. All figures are taken directly from the CSV file and used as provided.</p>
    </section>
  </main>

  <script>
    // ---------- Helpers ----------
    const money = n => {
      if (!isFinite(n)) return "£0";
      return "£" + n.toLocaleString("en-GB", { maximumFractionDigits: 0 });
    };
    const num = v => {
      if (v === null || v === undefined) return 0;
      if (typeof v === "number") return v;
      // remove commas, spaces, currency signs
      const clean = String(v).replace(/[£,\s]/g, "");
      const parsed = parseFloat(clean);
      return isNaN(parsed) ? 0 : parsed;
    };
    const sum = arr => arr.reduce((a,b)=>a+num(b), 0);

    // ---------- Data model ----------
    const CSV_PATH = "./adjusted_queensgate_bouldering_model.csv";

    let rows = [];           // raw rows
    let bySection = {};      // { section: [rows...] }
    let scenarios = ["Conservative", "Realistic", "Optimistic"];
    let currentScenario = "Conservative";
    let chartInstance = null;

    function groupRows() {
      bySection = {};
      rows.forEach(r => {
        const sec = r["SECTION TITLE"] || "Other";
        if (!bySection[sec]) bySection[sec] = [];
        bySection[sec].push(r);
      });
    }

    function getRevenuePieces(scn) {
      const getVal = key => {
        const r = rows.find(x => (x["SECTION TITLE"] || "").toUpperCase() === "REVENUE" && (x["DESCRIPTION"] || "").toUpperCase() === key);
        return r ? num(r[scn]) : 0;
      };
      const membersPerMonth = getVal("MEMBERS_ MONTHLY");
      const memberPrice = getVal("MEMBERS_PRICE");
      const dayPassesPerMonth = getVal("DAY_PASSES_MONTHLY");
      const dayPassPrice = getVal("DAY_PASS_PRICE");
      const otherPerMonth = getVal("OTHER_REV_MONTH");
      const monthlyFromMembers = membersPerMonth * memberPrice;
      const monthlyFromDay = dayPassesPerMonth * dayPassPrice;
      const monthlyTotal = monthlyFromMembers + monthlyFromDay + otherPerMonth;
      const annual = monthlyTotal * 12;
      return {
        membersPerMonth,
        memberPrice,
        dayPassesPerMonth,
        dayPassPrice,
        otherPerMonth,
        monthlyTotal,
        annual
      };
    }

    function sectionAnnualTotal(secName, scn) {
      if (!bySection[secName]) return 0;
      // Capex is not annual, we still total it for display, but exclude from annual costs
      if (secName.toUpperCase().includes("CAPITAL EXPENDITURE")) {
        return bySection[secName].reduce((acc, r) => acc + num(r["Year 1"]), 0);
      }
      return bySection[secName].reduce((acc, r) => acc + num(r[scn]), 0);
    }

    function totalAnnualCosts(scn) {
      let total = 0;
      Object.keys(bySection).forEach(sec => {
        const upper = sec.toUpperCase();
        if (upper.includes("REVENUE")) return; // skip
        if (upper.includes("CAPITAL EXPENDITURE")) return; // one time
        total += sectionAnnualTotal(sec, scn);
      });
      return total;
    }

    function totalCapex() {
      let capex = 0;
      Object.keys(bySection).forEach(sec => {
        const upper = sec.toUpperCase();
        if (upper.includes("CAPITAL EXPENDITURE")) {
          capex += bySection[sec].reduce((acc, r) => acc + num(r["Year 1"]), 0);
        }
      });
      return capex;
    }

    function renderKPIs() {
      const rev = getRevenuePieces(currentScenario);
      const costs = totalAnnualCosts(currentScenario);
      const ebitda = rev.annual - costs;
      const margin = rev.annual > 0 ? (ebitda / rev.annual) * 100 : 0;

      document.getElementById("kpiRevenue").textContent = money(rev.annual);
      document.getElementById("kpiCosts").textContent = money(costs);
      document.getElementById("kpiEbitda").textContent = money(ebitda);
      document.getElementById("kpiMargin").textContent = `${margin.toFixed(1)}% margin`;
      document.getElementById("kpiCapex").textContent = money(totalCapex());

      // Drivers
      document.getElementById("drvMembers").textContent = rev.membersPerMonth.toLocaleString("en-GB");
      document.getElementById("drvMemberPrice").textContent = money(rev.memberPrice);
      document.getElementById("drvDayPasses").textContent = rev.dayPassesPerMonth.toLocaleString("en-GB");
      document.getElementById("drvDayPassPrice").textContent = money(rev.dayPassPrice);
      document.getElementById("drvOther").textContent = money(rev.otherPerMonth);

      // Break even calc
      const monthlyCosts = totalAnnualCosts(currentScenario) / 12;
      const monthlyOtherRevenue = (rev.dayPassesPerMonth * rev.dayPassPrice) + rev.otherPerMonth;
      const needed = Math.max(0, Math.ceil((monthlyCosts - monthlyOtherRevenue) / (rev.memberPrice || 1)));
      document.getElementById("beCost").textContent = money(monthlyCosts);
      document.getElementById("beOtherRev").textContent = money(monthlyOtherRevenue);
      document.getElementById("membersReq").textContent = isFinite(needed) ? needed.toLocaleString("en-GB") : "0";

      // Chart
      const ctx = document.getElementById("revCostChart");
      const data = {
        labels: ["Revenue", "Costs"],
        datasets: [{
          label: "Annual £",
          data: [rev.annual, costs]
        }]
      };
      const opts = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: {
            label: ctx => money(ctx.raw)
          } }
        },
        scales: {
          y: { ticks: { callback: v => "£" + Number(v).toLocaleString("en-GB") } }
        }
      };
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, { type: "bar", data, options: opts });
      document.getElementById("scenarioTag").textContent = currentScenario;
    }

    function renderTable() {
      const container = document.getElementById("tableContainer");
      const secOrder = Object.keys(bySection);

      let html = "";
      secOrder.forEach(sec => {
        const isCapex = sec.toUpperCase().includes("CAPITAL EXPENDITURE");
        const isRevenue = sec.toUpperCase().includes("REVENUE");
        const sectionTotal = isRevenue
          ? getRevenuePieces(currentScenario).annual
          : isCapex
            ? bySection[sec].reduce((a,r)=>a+num(r["Year 1"]),0)
            : sectionAnnualTotal(sec, currentScenario);

        html += `
          <div class="mt-6">
            <div class="flex items-baseline justify-between">
              <h3 class="text-base md:text-lg font-bold">${sec}</h3>
              <div class="text-sm text-black/60 dark:text-white/60">
                ${isRevenue ? "Annualised from monthly drivers" : isCapex ? "One time" : "Annual"}
                total: <span class="mono font-semibold">${money(sectionTotal)}</span>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="table w-full mt-2">
                <thead>
                  <tr>
                    <th class="w-44">Item</th>
                    <th class="w-24">Unit</th>
                    <th class="w-28">Value</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody>
        `;

        bySection[sec].forEach(r => {
          const desc = String(r["DESCRIPTION"] || "");
          const notes = String(r["NOTES"] || "").trim();
          let unit = isRevenue ? "Monthly" : isCapex ? "One time" : "Annual";
          let value = 0;

          if (isRevenue) {
            // Show the raw monthly values for revenue inputs
            const key = desc.toUpperCase();
            if (key === "MEMBERS_ MONTHLY" || key === "DAY_PASSES_MONTHLY" || key === "OTHER_REV_MONTH" || key === "DAY_PASS_PRICE" || key === "MEMBERS_PRICE") {
              value = num(r[currentScenario]);
            }
          } else if (isCapex) {
            value = num(r["Year 1"]);
          } else {
            value = num(r[currentScenario]);
          }

          const prettyValue = (desc.toUpperCase().includes("PRICE") || desc.toUpperCase().includes("REV")) && isRevenue
            ? money(value)
            : isCapex
              ? money(value)
              : isRevenue && !desc.toUpperCase().includes("PRICE") && !desc.toUpperCase().includes("REV")
                ? value.toLocaleString("en-GB")
                : money(value);

          html += `
            <tr class="border-t border-black/5 dark:border-white/10">
              <td class="pr-4">
                <div class="flex items-start gap-2">
                  <span class="mono">${desc.replaceAll("_"," ")}</span>
                  ${notes && notes !== "NaN" ? `
                  <span class="tooltip text-black/40 dark:text-white/40" aria-label="Notes">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="mt-1">
                      <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 15h-2v-2h2Zm0-4h-2V7h2Z"/>
                    </svg>
                    <span class="tip">${notes.replaceAll("<","&lt;").replaceAll(">","&gt;")}</span>
                  </span>` : ``}
                </div>
              </td>
              <td class="text-sm text-black/60 dark:text-white/60">${unit}</td>
              <td class="mono font-semibold">${prettyValue}</td>
              <td class="text-sm text-black/60 dark:text-white/60">${notes && notes !== "NaN" ? notes : ""}</td>
            </tr>
          `;
        });

        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function recalc() {
      renderKPIs();
      renderTable();
    }

    // ---------- Load CSV ----------
    function loadCSV() {
      Papa.parse(CSV_PATH, {
        download: true,
        header: true,
        dynamicTyping: false,
        skipEmptyLines: true,
        complete: (res) => {
          rows = res.data.map(r => {
            // Normalize empty to null
            Object.keys(r).forEach(k => { if (r[k] === "") r[k] = null; });
            return r;
          });
          groupRows();
          recalc();
        },
        error: (err) => {
          const container = document.querySelector("main");
          container.innerHTML = `
            <div class="card">
              <h2 class="text-lg font-bold">Could not load CSV</h2>
              <p class="mt-2 text-sm text-red-600">Error: ${err?.message || "Unknown error"}</p>
              <p class="mt-2 text-sm">Make sure the CSV sits next to this HTML and is named <strong>Queensgate_Bouldering_Financial_ModelV2_ADJUSTED.csv</strong>.</p>
            </div>
          `;
        }
      });
    }

    // ---------- Scenario UI ----------
    document.getElementById("scenarioButtons").addEventListener("click", e => {
      const btn = e.target.closest("button[data-scenario]");
      if (!btn) return;
      currentScenario = btn.dataset.scenario;
      document.querySelectorAll("#scenarioButtons .btn").forEach(b=>{
        b.classList.toggle("active", b === btn);
        b.setAttribute("aria-selected", b === btn ? "true" : "false");
      });
      recalc();
    });

    // ---------- Init ----------
    loadCSV();
  </script>
</body>
</html>
