<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Queensgate Bouldering Centre - Financial Model</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- PapaParse for CSV loading -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:#f5f7fa;
      padding:20px;
      color:#2c3e50;
    }

    .container{
      max-width:1200px;
      margin:0 auto;
      background:#fff;
      border-radius:12px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      overflow:hidden;
    }

    .header{
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;
      padding:24px 30px;
    }
    .header h1{
      font-size:2rem;
      font-weight:800;
      margin-bottom:8px;
    }
    .header p{
      line-height:1.5;
      opacity:.98;
      font-size:1rem;
    }
    .header strong{font-weight:700;}

    .content{padding:24px 30px;}

    /* Year toggle */
    .year-toggle-wrap{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:20px;
    }
    .year-label{
      font-size:.95rem;
      color:#555;
    }
    .scenario-buttons{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .scenario-btn{
      padding:8px 18px;
      border:2px solid #667eea;
      background:#fff;
      color:#667eea;
      border-radius:999px;
      cursor:pointer;
      font-weight:600;
      font-size:.95rem;
      transition:all .18s;
      min-height:40px;
    }
    .scenario-btn:hover{
      background:#667eea;
      color:#fff;
    }
    .scenario-btn.active,
    .scenario-btn[aria-pressed="true"]{
      background:#667eea;
      color:#fff;
      box-shadow:0 0 0 2px #667eea22 inset;
    }

    /* Metrics */
    .key-metrics{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:18px;
      margin-bottom:26px;
      padding:18px 20px;
      background:#f8f9fa;
      border-radius:10px;
    }
    .metric{text-align:center;}
    .metric-value{
      font-size:1.7rem;
      font-weight:700;
      color:#667eea;
    }
    .metric-label{
      font-size:.9rem;
      color:#666;
      margin-top:4px;
    }
    .positive{color:#27ae60;}
    .negative{color:#e74c3c;}

    /* Sections */
    .section{
      margin-bottom:24px;
      border:1px solid #e0e0e0;
      border-radius:10px;
      overflow:hidden;
    }
    .section-header{
      background:#f8f9fa;
      padding:12px 18px;
      border-bottom:1px solid #e0e0e0;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .section-title{
      font-size:1.1rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .section-total{
      font-size:1rem;
      font-weight:700;
      color:#667eea;
    }
    .section-content{
      padding:18px;
    }

    /* Form grid */
    .assumption-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
      gap:14px;
    }
    .assumption-item{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .assumption-item label{
      font-size:.9rem;
      color:#666;
      text-align:left;
    }
    .assumption-item input{
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:6px;
      font-size:1rem;
      text-align:right;
    }
    .assumption-item input:focus{
      outline:none;
      border-color:#667eea;
      box-shadow:0 0 0 2px #667eea22;
    }

    /* Summary table */
    .summary-table{
      background:#f8f9fa;
      border-radius:10px;
      padding:18px 20px;
      margin-top:10px;
      margin-bottom:8px;
    }
    .summary-table h3{
      margin-bottom:10px;
      color:#2c3e50;
      font-size:1.05rem;
    }
    .summary-row{
      display:grid;
      grid-template-columns:1fr 220px;
      gap:18px;
      padding:8px 0;
      border-bottom:1px solid #e0e0e0;
      font-size:.95rem;
    }
    .summary-row:last-child{border-bottom:none;}

    /* Small notes */
    .talking-points{
      background:#e3f2fd;
      border:1px solid #2196f3;
      border-radius:10px;
      padding:16px 18px;
      margin-top:18px;
      margin-bottom:4px;
      font-size:.9rem;
      line-height:1.6;
    }
    .talking-points h3{
      color:#1565c0;
      margin-bottom:8px;
      font-size:1rem;
    }

    /* Mobile tweaks */
    @media(max-width:768px){
      .content{padding:18px 16px;}
      .summary-row{grid-template-columns:1fr;gap:6px;}
      .header{padding:20px 18px;}
      .header h1{font-size:1.6rem;}
      body{padding:10px;}
      .container{border-radius:8px;}
    }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>Queensgate Bouldering Centre - Financial Model</h1>
    <p><strong>Purpose:</strong> Robust, source backed projections aligned to supplier quotes for a two level bouldering gym in Queensgate.</p>
  </div>

  <div class="content">

    <!-- Year selector -->
    <div class="year-toggle-wrap">
      <div class="year-label">
        Viewing <strong>Year <span id="currentYearLabel">1</span></strong> values from <code>queensgate_bouldering_model.csv</code>.
      </div>
      <div class="scenario-buttons" role="group" aria-label="Year selector">
        <button class="scenario-btn year-btn active" data-year="1" aria-pressed="true">Year 1</button>
        <button class="scenario-btn year-btn" data-year="2" aria-pressed="false">Year 2</button>
      </div>
    </div>

    <!-- Key metrics -->
    <div class="key-metrics">
      <div class="metric">
        <div class="metric-value" id="km-revenue">£0</div>
        <div class="metric-label">Annual revenue</div>
      </div>
      <div class="metric">
        <div class="metric-value negative" id="km-ebitda">£0</div>
        <div class="metric-label">Annual profit (EBITDA)</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="km-capex">£0</div>
        <div class="metric-label">CAPEX total</div>
      </div>
    </div>

    <!-- Revenue drivers -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">Revenue drivers</div>
        <div class="section-total">Annual revenue <span id="rev-total">£0</span></div>
      </div>
      <div class="section-content">
        <p style="font-size:.9rem;color:#666;margin-bottom:10px;">
          Defaults come from the CSV for the selected year. Adjust any field to explore upside or downside.
        </p>
        <div class="assumption-grid">
          <div class="assumption-item">
            <label>Members per month</label>
            <input id="rev-members" type="number" min="0" step="1" inputmode="numeric">
          </div>
          <div class="assumption-item">
            <label>Member price (£)</label>
            <input id="rev-member-price" type="number" min="0" step="1" inputmode="decimal">
          </div>
          <div class="assumption-item">
            <label>Day passes per month</label>
            <input id="rev-day-passes" type="number" min="0" step="1" inputmode="numeric">
          </div>
          <div class="assumption-item">
            <label>Day pass price (£)</label>
            <input id="rev-day-price" type="number" min="0" step="0.5" inputmode="decimal">
          </div>
          <div class="assumption-item">
            <label>Other revenue per month (£)</label>
            <input id="rev-other" type="number" min="0" step="10" inputmode="decimal">
          </div>
        </div>
      </div>
    </div>

    <!-- Loan -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">Loan</div>
        <div class="section-total">Annual debt service <span id="loan-annual">n/a</span></div>
      </div>
      <div class="section-content">
        <div class="assumption-grid">
          <div class="assumption-item">
            <label>Loan amount (£)</label>
            <input id="loan-amount" type="number" min="0" step="1000" value="350000">
          </div>
          <div class="assumption-item">
            <label>Interest rate percent (APR)</label>
            <input id="loan-rate" type="number" min="0" step="0.1" value="7.0">
          </div>
          <div class="assumption-item">
            <label>Loan term (months)</label>
            <input id="loan-months" type="number" min="1" step="1" value="84">
          </div>
        </div>

        <div class="summary-table" style="margin-top:16px;">
          <h3>Loan cover and payback</h3>
          <div class="summary-row">
            <div>Monthly payment</div>
            <div id="loan-monthly-out">n/a</div>
          </div>
          <div class="summary-row">
            <div>Annual debt service</div>
            <div id="loan-annual-out">n/a</div>
          </div>
          <div class="summary-row">
            <div>Debt service cover (EBITDA ÷ debt)</div>
            <div id="loan-dscr">n/a</div>
          </div>
          <div class="summary-row">
            <div>Simple payback on loan (EBITDA)</div>
            <div id="loan-payback">n/a</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Annual summary -->
    <div class="summary-table">
      <h3>Annual summary for Year <span id="summary-year">1</span></h3>
      <div class="summary-row">
        <div>Total annual revenue</div>
        <div id="sum-revenue">£0</div>
      </div>
      <div class="summary-row">
        <div>Total annual operating costs</div>
        <div id="sum-costs">£0</div>
      </div>
      <div class="summary-row">
        <div>Annual profit (EBITDA)</div>
        <div id="sum-ebitda" class="negative">£0</div>
      </div>
      <div class="summary-row">
        <div>Profit margin</div>
        <div id="sum-margin">0 percent</div>
      </div>
    </div>

    <div class="talking-points">
      <h3>Notes</h3>
      <p>
        All figures are driven by <code>queensgate_bouldering_model.csv</code> plus the revenue and loan inputs above.
        Year 1 and Year 2 switch the baseline values from the CSV. Manual changes let you explore different outcomes.
      </p>
    </div>

  </div><!-- /content -->
</div><!-- /container -->

<script>
  // ---------- helpers ----------
  function toNum(v){
    const n = parseFloat(v);
    return isFinite(n) ? n : 0;
  }
  function money(v){
    const x = Math.round(toNum(v));
    const sign = x < 0 ? "-£" : "£";
    return sign + Math.abs(x).toLocaleString("en-GB");
  }
  function pct(v){
    const x = isFinite(v) ? v : 0;
    return x.toFixed(1) + " percent";
  }

  const CSV_PATH = "./queensgate_bouldering_model.csv";
  let rows = [];
  let currentYear = 1;

  function yearColName(){
    return currentYear === 2 ? "Year 2" : "Year 1";
  }

  function valueFromRow(row){
    const col = yearColName();
    return toNum(row[col]);
  }

  function isCapexSection(sec){
    const s = (sec || "").toUpperCase();
    return s.includes("CAPEX") || s.includes("CAPITAL") || s.includes("FIT OUT");
  }

  function isRevenueRow(desc, sec){
    const s = (sec || "").toUpperCase();
    const d = (desc || "").toUpperCase();
    if (s.includes("REVENUE")) return true;
    if (d.includes("MEMBERS PER MONTH")) return true;
    if (d.includes("MEMBER PRICE")) return true;
    if (d.includes("DAY PASSES")) return true;
    if (d.includes("DAY PASS PRICE")) return true;
    if (d.includes("OTHER REVENUE")) return true;
    return false;
  }

  function capexTotal(){
    return rows.reduce((sum,row)=>{
      if (isCapexSection(row["SECTION TITLE"])) sum += valueFromRow(row);
      return sum;
    },0);
  }

  function operatingCosts(){
    return rows.reduce((sum,row)=>{
      const sec = row["SECTION TITLE"];
      const desc = row["DESCRIPTION"];
      if (isCapexSection(sec)) return sum;
      if (isRevenueRow(desc, sec)) return sum;
      sum += valueFromRow(row);
      return sum;
    },0);
  }

  function getRevenueDefaults(){
    const defs = {
      members:null,
      memberPrice:null,
      dayPasses:null,
      dayPrice:null,
      other:null
    };
    rows.forEach(row=>{
      const desc = (row["DESCRIPTION"] || "").toUpperCase();
      const val = valueFromRow(row);
      if (desc.includes("MEMBERS PER MONTH") && defs.members === null) defs.members = val;
      else if (desc.includes("MEMBER PRICE") && defs.memberPrice === null) defs.memberPrice = val;
      else if (desc.includes("DAY PASSES") && defs.dayPasses === null) defs.dayPasses = val;
      else if (desc.includes("DAY PASS PRICE") && defs.dayPrice === null) defs.dayPrice = val;
      else if (desc.includes("OTHER REVENUE") && defs.other === null) defs.other = val;
    });
    return defs;
  }

  function loadRevenueInputsFromCSV(){
    const d = getRevenueDefaults();
    if (d.members !== null) document.getElementById("rev-members").value = d.members;
    if (d.memberPrice !== null) document.getElementById("rev-member-price").value = d.memberPrice;
    if (d.dayPasses !== null) document.getElementById("rev-day-passes").value = d.dayPasses;
    if (d.dayPrice !== null) document.getElementById("rev-day-price").value = d.dayPrice;
    if (d.other !== null) document.getElementById("rev-other").value = d.other;
  }

  function revenueFromInputs(){
    const members = toNum(document.getElementById("rev-members").value);
    const memberPrice = toNum(document.getElementById("rev-member-price").value);
    const dayPasses = toNum(document.getElementById("rev-day-passes").value);
    const dayPrice = toNum(document.getElementById("rev-day-price").value);
    const other = toNum(document.getElementById("rev-other").value);
    const monthlyMembers = members * memberPrice;
    const monthlyDay = dayPasses * dayPrice;
    const monthlyOther = other;
    const monthlyTotal = monthlyMembers + monthlyDay + monthlyOther;
    return {
      annual: monthlyTotal * 12,
      monthly: monthlyTotal
    };
  }

  function loanMetrics(ebitda){
    const amount = toNum(document.getElementById("loan-amount").value);
    const ratePct = toNum(document.getElementById("loan-rate").value);
    const months = Math.max(1, toNum(document.getElementById("loan-months").value));
    if (amount <= 0 || ratePct < 0){
      return {monthly:null, annual:null, dscr:null, payback:null};
    }
    const r = ratePct / 100 / 12;
    let monthlyPay;
    if (r === 0){
      monthlyPay = amount / months;
    } else {
      monthlyPay = amount * r / (1 - Math.pow(1 + r, -months));
    }
    const annual = monthlyPay * 12;
    const dscr = annual > 0 ? ebitda / annual : null;
    const payback = ebitda > 0 ? amount / ebitda : null;
    return {monthly:monthlyPay, annual, dscr, payback};
  }

  function recalc(){
    const rev = revenueFromInputs();
    const costs = operatingCosts();
    const ebitda = rev.annual - costs;
    const margin = rev.annual > 0 ? (ebitda / rev.annual) * 100 : 0;
    const capex = capexTotal();

    // top metrics
    document.getElementById("km-revenue").textContent = money(rev.annual);
    const kmE = document.getElementById("km-ebitda");
    kmE.textContent = money(ebitda);
    kmE.classList.toggle("positive", ebitda > 0);
    kmE.classList.toggle("negative", ebitda <= 0);
    document.getElementById("km-capex").textContent = money(capex);

    // revenue section header
    document.getElementById("rev-total").textContent = money(rev.annual);

    // summary box
    document.getElementById("summary-year").textContent = currentYear;
    document.getElementById("sum-revenue").textContent = money(rev.annual);
    document.getElementById("sum-costs").textContent = money(costs);
    const sumE = document.getElementById("sum-ebitda");
    sumE.textContent = money(ebitda);
    sumE.classList.toggle("positive", ebitda > 0);
    sumE.classList.toggle("negative", ebitda <= 0);
    document.getElementById("sum-margin").textContent = pct(margin);

    // loan
    const loan = loanMetrics(ebitda);
    document.getElementById("loan-annual").textContent = loan.annual ? money(loan.annual) : "n/a";
    document.getElementById("loan-monthly-out").textContent = loan.monthly ? money(loan.monthly) : "n/a";
    document.getElementById("loan-annual-out").textContent = loan.annual ? money(loan.annual) : "n/a";
    document.getElementById("loan-dscr").textContent =
      loan.dscr && isFinite(loan.dscr) ? loan.dscr.toFixed(2) : "n/a";
    document.getElementById("loan-payback").textContent =
      loan.payback && isFinite(loan.payback) ? loan.payback.toFixed(1) + " years" : "n/a";
  }

  function setYear(year){
    currentYear = year === 2 ? 2 : 1;
    document.getElementById("currentYearLabel").textContent = currentYear;
    document.getElementById("summary-year").textContent = currentYear;

    document.querySelectorAll(".year-btn").forEach(btn=>{
      const isActive = Number(btn.dataset.year) === currentYear;
      btn.classList.toggle("active", isActive);
      btn.setAttribute("aria-pressed", isActive ? "true" : "false");
    });

    loadRevenueInputsFromCSV();
    recalc();
  }

  function attachEvents(){
    document.querySelectorAll(".year-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        setYear(Number(btn.dataset.year));
      }, {passive:true});
    });

    ["rev-members","rev-member-price","rev-day-passes","rev-day-price","rev-other",
     "loan-amount","loan-rate","loan-months"].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener("input", recalc);
    });
  }

  function loadCSV(){
    Papa.parse(CSV_PATH,{
      download:true,
      header:true,
      dynamicTyping:false,
      skipEmptyLines:true,
      complete:(res)=>{
        rows = res.data || [];
        attachEvents();
        setYear(1); // initial load
      },
      error:()=>{
        // If CSV cannot be loaded, still allow manual play
        rows = [];
        attachEvents();
        setYear(1);
      }
    });
  }

  window.addEventListener("load", loadCSV);
</script>
</body>
</html>
