<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Queensgate Bouldering • Investor Model</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f17; --panel:#121826; --soft:#1b2336; --text:#e8eefc; --muted:#9fb0d0;
    --accent:#6ee7ff; --ok:#8de67b; --warn:#ffd166; --danger:#ff6b6b; --border:#2a3754;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:linear-gradient(180deg,#0b0f17,#0b1220);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1180px;margin:32px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:24px;margin:0}
  .sub{color:var(--muted);font-size:14px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  button.toggle{background:var(--soft);color:var(--text);border:1px solid var(--border);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;letter-spacing:.2px}
  button.toggle.active{outline:2px solid var(--accent);background:#0e1525}
  .grid{display:grid;gap:16px}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .grid.cols-2{grid-template-columns:repeat(2,1fr)}
  @media(max-width:900px){.grid.cols-3,.grid.cols-2{grid-template-columns:1fr}}
  .card{background:radial-gradient(1300px 400px at 0% -10%, rgba(110,231,255,.06), transparent 40%),radial-gradient(800px 300px at 100% 0%, rgba(124,255,178,.06), transparent 40%),var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media(max-width:1000px){.kpis{grid-template-columns:repeat(2,1fr)}}
  .kpi{background:var(--soft);border:1px solid var(--border);border-radius:12px;padding:14px}
  .kpi .label{color:var(--muted);font-size:12px}
  .kpi .value{font-size:22px;font-weight:700;margin-top:6px}
  .kpi .note{font-size:12px;color:var(--muted)}
  .pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:var(--soft);display:inline-block;margin-right:8px;margin-top:8px}
  .table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--border)}
  .table th{background:var(--soft);text-align:left;color:var(--muted);font-weight:600;font-size:12px;letter-spacing:.3px}
  .table tr:last-child td{border-bottom:none}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}
  .badge{display:inline-block;font-size:11px;border:1px solid var(--border); background:var(--soft); padding:3px 8px;border-radius:999px;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin:0 0 8px 0}
  .section-title h2{margin:0;font-size:16px}
  .tip{font-size:12px;color:var(--muted)}
  canvas{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:6px}
  .alert{display:none;background:#2b1c1c;border:1px solid #7a3939;color:#ffdcdc;padding:12px;border-radius:10px;margin:0 0 14px 0}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Queensgate Bouldering • Financial Overview</h1>
        <div class="sub">Investor view with scenario toggles and transparent assumptions</div>
      </div>
      <div class="toolbar">
        <button class="toggle" data-scenario="conservative">Conservative</button>
        <button class="toggle active" data-scenario="realistic">Realistic</button>
        <button class="toggle" data-scenario="optimistic">Optimistic</button>
      </div>
    </header>

    <div id="alert" class="alert"></div>

    <div class="grid cols-3">
      <div class="card">
        <div class="section-title"><h2>Quick facts</h2><span class="badge">Based on selected scenario</span></div>
        <div class="kpis">
          <div class="kpi"><div class="label">Annual revenue</div><div id="kpi-rev" class="value">£—</div><div class="note" id="kpi-rev-note"></div></div>
          <div class="kpi"><div class="label">Annual opex</div><div id="kpi-opex" class="value">£—</div><div class="note" id="kpi-opex-note"></div></div>
          <div class="kpi"><div class="label">EBITDA</div><div id="kpi-ebitda" class="value">£—</div><div class="note" id="kpi-ebitda-note"></div></div>
          <div class="kpi"><div class="label">Year 1 DSCR</div><div id="kpi-dscr" class="value">—</div><div class="note" id="kpi-dscr-note"></div></div>
        </div>
        <div class="pill"><span class="mono">Revenue</span> = memberships + day passes + other</div>
        <div class="pill">Opex includes rent, rates, staff, utilities, insurance, marketing, maintenance</div>
      </div>

      <div class="card">
        <div class="section-title"><h2>Sources and uses</h2><span class="badge">Project setup</span></div>
        <table class="table" id="tbl-sources"><thead><tr><th>Sources</th><th class="num">£</th></tr></thead><tbody></tbody></table>
        <div style="height:10px"></div>
        <table class="table" id="tbl-uses"><thead><tr><th>Uses</th><th class="num">£</th></tr></thead><tbody></tbody></table>
        <div style="height:10px"></div>
        <div class="tip" id="sources-note"></div>
      </div>

      <div class="card">
        <div class="section-title"><h2>Loan highlights</h2><span class="badge">Debt service</span></div>
        <table class="table"><tbody id="tbl-loan"></tbody></table>
        <div style="height:10px"></div>
        <div class="tip" id="loan-note"></div>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="grid cols-2">
      <div class="card">
        <div class="section-title"><h2>P and L snapshot</h2><span class="badge">Year 1</span></div>
        <table class="table" id="tbl-pl"><thead><tr><th>Line</th><th class="num">£ / month</th><th class="num">£ / year</th></tr></thead><tbody></tbody></table>
        <div style="height:10px"></div>
        <div class="tip">EBITDA excludes depreciation and tax.</div>
      </div>

      <div class="card">
        <div class="section-title"><h2>Bank covenants view</h2><span class="badge">Liquidity and coverage</span></div>
        <table class="table" id="tbl-cov"><thead><tr><th>Metric</th><th class="num">Value</th><th>Status</th></tr></thead><tbody></tbody></table>
        <div style="height:10px"></div>
        <div class="tip" id="cov-note"></div>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="grid cols-2">
      <div class="card">
        <div class="section-title"><h2>Revenue vs opex</h2><span class="badge">Year 1 monthly</span></div>
        <canvas id="chart1" height="220"></canvas>
      </div>
      <div class="card">
        <div class="section-title"><h2>Debt service profile</h2><span class="badge">Monthly</span></div>
        <canvas id="chart2" height="220"></canvas>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="card">
      <div class="section-title"><h2>Assumptions and provenance</h2><span class="badge">Traceable sources</span></div>
      <table class="table" id="tbl-assump">
        <thead><tr><th>Variable</th><th class="num">Value</th><th>Source</th><th>Reference</th><th>Confidence</th><th>Notes</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="height:12px"></div>
      <div class="tip">Scenario rules are declared in the code inside <span class="mono">SCENARIOS</span>.</div>
    </div>

    <div style="height:40px"></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* Scenario multipliers */
const SCENARIOS = {
  conservative:{members_mult:.8,membership_price_mult:.95,day_passes_mult:.75,day_price_mult:.98,other_rev_mult:.85,opex_mult:1.10,loan_rate_delta_pp:2.0,arrangement_fee_mult:1.10},
  realistic:{members_mult:1, membership_price_mult:1, day_passes_mult:1, day_price_mult:1, other_rev_mult:1, opex_mult:1, loan_rate_delta_pp:0, arrangement_fee_mult:1},
  optimistic:{members_mult:1.2,membership_price_mult:1.05,day_passes_mult:1.25,day_price_mult:1.02,other_rev_mult:1.20,opex_mult:.95,loan_rate_delta_pp:-1,arrangement_fee_mult:.9}
};
let RAW = null;     // parsed CSV rows
let BASE = null;    // mapped key:value from RAW
let STATE = {scenario:"realistic"};

const £ = v => "£"+(Math.round(v).toLocaleString("en-GB"));
const fx = (v,d=2)=> (typeof v==="number" ? v.toFixed(d) : v);
function num(v){ if(v==null) return 0; if(typeof v==="number") return v; const n=parseFloat(String(v).replace(/[, ]/g,"")); return isNaN(n)?0:n; }
function mapData(arr){ const m={}; arr.forEach(r=>m[r["Variable"]] = r["Value"]); return m; }

function showError(msg){
  const el=document.getElementById("alert");
  el.textContent=msg;
  el.style.display="block";
}

async function loadCSV(){
  try{
    const res = await fetch("queensgate_bouldering_provenance.csv", {cache:"no-store"});
    if(!res.ok) throw new Error("CSV not found. Place queensgate_bouldering_provenance.csv next to index.html");
    const text = await res.text();
    const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
    if(parsed.errors && parsed.errors.length){
      console.warn(parsed.errors);
      showError("CSV parsed with warnings. Check console for details.");
    }
    RAW = parsed.data;
    BASE = mapData(RAW);
    // quick column sanity
    const required = ["MEMBERS_COUNT","MEMBERSHIP_PRICE","DAY_PASSES_MONTHLY","DAY_PASS_PRICE","OTHER_REV_MONTH","RENT","BUSINESS_RATES","SALARIES","UTILITIES","INSURANCE","MARKETING","MAINTENANCE","CAPEX_WORKING_CAPITAL","BANK_LOAN","EQUITY","ARRANGEMENT_FEE","INTEREST_ONLY_MONTHS","LOAN_RATE","LOAN_TERM","DSCR_THRESHOLD","LIQUIDITY_THRESHOLD"];
    const missing = required.filter(k => !(k in BASE));
    if(missing.length){
      showError("Missing required variables in CSV: "+missing.join(", "));
    }
    render();
  }catch(e){
    console.error(e);
    showError(e.message);
  }
}

function computeScenario(base, lever){
  const members = num(base.MEMBERS_COUNT)*lever.members_mult;
  const memberPrice = num(base.MEMBERSHIP_PRICE)*lever.membership_price_mult;
  const dayPasses = num(base.DAY_PASSES_MONTHLY)*lever.day_passes_mult;
  const dayPrice = num(base.DAY_PASS_PRICE)*lever.day_price_mult;
  const otherRev = num(base.OTHER_REV_MONTH)*lever.other_rev_mult;

  const revMonthly = members*memberPrice + dayPasses*dayPrice + otherRev;
  const revAnnual = revMonthly*12;

  const opexLines = ["RENT","BUSINESS_RATES","SALARIES","UTILITIES","INSURANCE","MARKETING","MAINTENANCE"];
  const opexAnnual = opexLines.reduce((s,k)=> s + num(base[k]), 0) * lever.opex_mult;

  const ebitda = revAnnual - opexAnnual;

  const capexKeys = Object.keys(base).filter(k=>k.startsWith("CAPEX_"));
  const capexTotal = capexKeys.reduce((s,k)=> s + num(base[k]), 0);
  const loan = num(base.BANK_LOAN);
  const equity = num(base.EQUITY);
  const arrangementFeePct = num(base.ARRANGEMENT_FEE)/100 * lever.arrangement_fee_mult;
  const arrangementFee = loan * arrangementFeePct;

  const rate = (num(base.LOAN_RATE) + lever.loan_rate_delta_pp)/100;
  const termYears = num(base.LOAN_TERM);
  const nMonths = Math.max(1,Math.round(termYears*12));
  const ioMonths = Math.min(nMonths, Math.max(0, Math.round(num(base.INTEREST_ONLY_MONTHS))));
  const monthlyRate = rate/12;
  const ioPay = loan * monthlyRate;
  const amortMonths = Math.max(0, nMonths - ioMonths);
  const amortPay = amortMonths>0 ? loan*monthlyRate/(1 - Math.pow(1+monthlyRate, -amortMonths)) : 0;

  const y1DebtService = Math.min(12,ioMonths)*ioPay + Math.max(0,12 - Math.min(12,ioMonths))*amortPay;
  const dscrY1 = y1DebtService>0 ? (ebitda / y1DebtService) : null;

  const fixedCostsMonthly = (opexAnnual/12);
  const liquidityMonths = fixedCostsMonthly>0 ? num(base.CAPEX_WORKING_CAPITAL)/fixedCostsMonthly : null;

  return {members,memberPrice,dayPasses,dayPrice,otherRev,revMonthly,revAnnual,opexAnnual,ebitda,
          capexTotal,loan,equity,arrangementFeePct,arrangementFee,rate,termYears,nMonths,ioMonths,
          monthlyRate,ioPay,amortMonths,amortPay,y1DebtService,dscrY1,liquidityMonths,opexLines,fixedCostsMonthly};
}

let CH1=null, CH2=null;

function render(){
  if(!BASE) return;
  const lever = SCENARIOS[STATE.scenario];
  const R = computeScenario(BASE, lever);

  // KPIs
  document.getElementById("kpi-rev").textContent = £(R.revAnnual);
  document.getElementById("kpi-opex").textContent = £(R.opexAnnual);
  document.getElementById("kpi-ebitda").textContent = £(R.ebitda);
  const dscrEl = document.getElementById("kpi-dscr");
  dscrEl.textContent = R.dscrY1?fx(R.dscrY1,2):"n/a";
  dscrEl.className = "value " + (R.dscrY1==null ? "" : R.dscrY1>=num(BASE.DSCR_THRESHOLD) ? "ok" : R.dscrY1>=1.0 ? "warn" : "danger");
  document.getElementById("kpi-rev-note").textContent = `Members ${Math.round(R.members)} × £${fx(R.memberPrice,2)} + day ${Math.round(R.dayPasses)} × £${fx(R.dayPrice,2)} + other £${Math.round(R.otherRev)}/m`;
  document.getElementById("kpi-opex-note").textContent = `${R.opexLines.join(", ").toLowerCase()}`;
  document.getElementById("kpi-ebitda-note").textContent = `Revenue minus opex`;
  document.getElementById("kpi-dscr-note").textContent = `Threshold ${BASE.DSCR_THRESHOLD}`;

  // Sources and uses
  const sourcesBody = document.querySelector("#tbl-sources tbody");
  sourcesBody.innerHTML = `<tr><td>Equity</td><td class="num">${£(R.equity)}</td></tr><tr><td>Bank loan</td><td class="num">${£(R.loan)}</td></tr>`;
  const usesBody = document.querySelector("#tbl-uses tbody");
  usesBody.innerHTML = `<tr><td>Capex total</td><td class="num">${£(R.capexTotal)}</td></tr><tr><td>Arrangement fee</td><td class="num">${£(R.arrangementFee)}</td></tr>`;
  const gap = (R.equity + R.loan) - (R.capexTotal + R.arrangementFee);
  document.getElementById("sources-note").textContent = gap>=0 ? `Headroom ${£(gap)}.` : `Shortfall ${£(-gap)}.`;

  // Loan table
  const loanRows = [
    ["Loan amount", £(R.loan)],
    ["Rate", (R.rate*100).toFixed(2) + "%"],
    ["Term", R.termYears + " years"],
    ["Interest only months", R.ioMonths],
    ["Monthly interest only", £(R.ioPay)],
    ["Monthly amortizing", R.amortMonths>0 ? £(R.amortPay) : "n/a"],
    ["Year 1 debt service", £(R.y1DebtService)],
    ["Arrangement fee", £(R.arrangementFee)]
  ];
  document.getElementById("tbl-loan").innerHTML = loanRows.map(([k,v])=>`<tr><td>${k}</td><td class="num">${v}</td></tr>`).join("");
  document.getElementById("loan-note").textContent = R.amortMonths>0 ? `Amortization over ${R.amortMonths} months after IO.` : `Interest only in Year 1 calc.`;

  // P&L
  const plBody = document.querySelector("#tbl-pl tbody");
  const lines = [
    ["Memberships", R.members*R.memberPrice, R.members*R.memberPrice*12],
    ["Day passes", R.dayPasses*R.dayPrice, R.dayPasses*R.dayPrice*12],
    ["Other revenue", R.otherRev, R.otherRev*12],
    ["Revenue total", R.revMonthly, R.revAnnual],
    ["Rent", num(BASE.RENT)/12*lever.opex_mult, num(BASE.RENT)*lever.opex_mult],
    ["Business rates", num(BASE.BUSINESS_RATES)/12*lever.opex_mult, num(BASE.BUSINESS_RATES)*lever.opex_mult],
    ["Salaries", num(BASE.SALARIES)/12*lever.opex_mult, num(BASE.SALARIES)*lever.opex_mult],
    ["Utilities", num(BASE.UTILITIES)/12*lever.opex_mult, num(BASE.UTILITIES)*lever.opex_mult],
    ["Insurance", num(BASE.INSURANCE)/12*lever.opex_mult, num(BASE.INSURANCE)*lever.opex_mult],
    ["Marketing", num(BASE.MARKETING)/12*lever.opex_mult, num(BASE.MARKETING)*lever.opex_mult],
    ["Maintenance", num(BASE.MAINTENANCE)/12*lever.opex_mult, num(BASE.MAINTENANCE)*lever.opex_mult],
    ["Opex total", R.opexAnnual/12, R.opexAnnual],
    ["EBITDA", (R.revAnnual-R.opexAnnual)/12, R.ebitda],
    ["Debt service (Y1)", R.y1DebtService/12, R.y1DebtService]
  ];
  plBody.innerHTML = lines.map(([k,m,y])=>{
    const cls = k==="EBITDA" ? "ok" : (k==="Debt service (Y1)" ? "warn" : "");
    return `<tr><td>${k}</td><td class="num ${cls}">${£(m)}</td><td class="num ${cls}">${£(y)}</td></tr>`;
  }).join("");

  // Covenants
  const covBody = document.querySelector("#tbl-cov tbody");
  const dscrClass = R.dscrY1==null ? "" : R.dscrY1>=num(BASE.DSCR_THRESHOLD) ? "ok" : R.dscrY1>=1 ? "warn" : "danger";
  const liqClass = R.liquidityMonths==null ? "" : R.liquidityMonths>=num(BASE.LIQUIDITY_THRESHOLD) ? "ok" : "warn";
  covBody.innerHTML = `
    <tr><td>DSCR Year 1</td><td class="num">${R.dscrY1?fx(R.dscrY1,2):"n/a"}</td><td class="${dscrClass}">${R.dscrY1==null?"n/a": R.dscrY1>=num(BASE.DSCR_THRESHOLD)?"Pass":"Tight"}</td></tr>
    <tr><td>Liquidity months</td><td class="num">${R.liquidityMonths?fx(R.liquidityMonths,2):"n/a"}</td><td class="${liqClass}">${R.liquidityMonths==null?"n/a": R.liquidityMonths>=num(BASE.LIQUIDITY_THRESHOLD)?"Pass":"Improve buffer"}</td></tr>
    <tr><td>Fixed costs monthly</td><td class="num">${£(R.fixedCostsMonthly)}</td><td></td></tr>
  `;
  document.getElementById("cov-note").textContent = `Thresholds: DSCR ${BASE.DSCR_THRESHOLD}, Liquidity ${BASE.LIQUIDITY_THRESHOLD} months.`;

  // Assumptions table
  const tbody = document.querySelector("#tbl-assump tbody");
  tbody.innerHTML = RAW.map(r=>{
    const varName = r["Variable"];
    let shown = r["Value"];
    if(["MEMBERS_COUNT","MEMBERSHIP_PRICE","DAY_PASSES_MONTHLY","DAY_PASS_PRICE","OTHER_REV_MONTH"].includes(varName)){
      if(varName==="MEMBERS_COUNT") shown = Math.round(R.members);
      if(varName==="MEMBERSHIP_PRICE") shown = R.memberPrice.toFixed(2);
      if(varName==="DAY_PASSES_MONTHLY") shown = Math.round(R.dayPasses);
      if(varName==="DAY_PASS_PRICE") shown = R.dayPrice.toFixed(2);
      if(varName==="OTHER_REV_MONTH") shown = Math.round(R.otherRev);
    }
    const asMoney = !isNaN(parseFloat(shown));
    return `<tr>
      <td><span class="mono">${varName}</span></td>
      <td class="num">${asMoney? £(parseFloat(shown)) : shown}</td>
      <td>${r["Source Type"]||""}</td>
      <td>${r["Reference"]||""}</td>
      <td>${r["Confidence"]||""}</td>
      <td>${r["Notes"]||""}</td>
    </tr>`;
  }).join("");

  // Charts
  const rev = R.revMonthly, opex = R.opexAnnual/12;
  const debtSeries = Array.from({length:12},(_,i)=> i< R.ioMonths ? Math.round(R.ioPay) : Math.round(R.amortPay));
  const lab = Array.from({length:12},(_,i)=>"M"+(i+1));

  if(CH1) CH1.destroy();
  CH1 = new Chart(document.getElementById("chart1"), {
    type:"bar",
    data:{labels:lab,datasets:[{label:"Revenue",data:lab.map(()=>Math.round(rev))},{label:"Opex",data:lab.map(()=>Math.round(opex))}]},
    options:{responsive:true,plugins:{legend:{labels:{color:"#cfe1ff"}}},scales:{x:{ticks:{color:"#cfe1ff"},grid:{color:"rgba(255,255,255,.05)"}},y:{ticks:{color:"#cfe1ff"},grid:{color:"rgba(255,255,255,.05)"}}}}
  });

  if(CH2) CH2.destroy();
  CH2 = new Chart(document.getElementById("chart2"), {
    type:"line",
    data:{labels:lab,datasets:[{label:"Debt service",data:debtSeries,tension:.2}]},
    options:{responsive:true,plugins:{legend:{labels:{color:"#cfe1ff"}}},scales:{x:{ticks:{color:"#cfe1ff"},grid:{color:"rgba(255,255,255,.05)"}},y:{ticks:{color:"#cfe1ff"},grid:{color:"rgba(255,255,255,.05)"}}}}
  });
}

// Toggle handlers
document.querySelectorAll("button.toggle").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll("button.toggle").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    STATE.scenario = btn.dataset.scenario;
    render();
  });
});

// Kick off
loadCSV();
</script>
</body>
</html>
