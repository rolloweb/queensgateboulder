<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Queensgate Bouldering • Financial Model</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    color-scheme: light dark;
    --gold:#fce38b;
    --salmon:#df7d6e;
    --blue:#6ba0cc;
    --ink:#0f172a;
    --paper:#f7fafc;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--paper);color:var(--ink)}
  @media (prefers-color-scheme:dark){
    :root{ --paper:#0b0b0c; --ink:#e6e6e6; }
  }

  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.85);backdrop-filter:saturate(1.1) blur(6px);border-bottom:1px solid rgba(0,0,0,.06)}
  @media (prefers-color-scheme:dark){header{background:rgba(16,16,16,.85);border-bottom:1px solid rgba(255,255,255,.12)}}
  h1{margin:.25rem 0 0;font-weight:900;font-size:clamp(22px,3vw,30px)}
  p.muted{margin:.25rem 0 0;color:rgba(0,0,0,.6)}
  @media (prefers-color-scheme:dark){p.muted{color:rgba(255,255,255,.6)}}

  .row{display:grid;gap:12px}
  @media(min-width:900px){.row.cols-4{grid-template-columns:repeat(4,1fr)}.row.cols-3{grid-template-columns:repeat(3,1fr)}}

  .card{background:rgba(255,255,255,.78);backdrop-filter:blur(6px) saturate(1.1);border:1px solid rgba(0,0,0,.06);border-radius:16px;padding:18px}
  @media (prefers-color-scheme:dark){.card{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)}}

  .kpi{font-weight:900;font-size:clamp(22px,3vw,32px);line-height:1}
  .kpi-sub{font-size:13px;color:rgba(0,0,0,.6)}
  @media (prefers-color-scheme:dark){.kpi-sub{color:rgba(255,255,255,.6)}}
  .mono{font-variant-numeric:tabular-nums}

  .btnbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:8px 14px;border-radius:12px;border:2px solid var(--ink);background:transparent;font-weight:800;cursor:pointer}
  .btn[aria-selected="true"]{background:var(--blue);border-color:var(--blue);color:#fff}

  .switch{display:inline-flex;align-items:center;gap:8px;font-weight:700}
  .switch input{appearance:none;width:44px;height:24px;border-radius:999px;background:#cbd5e1;position:relative;outline:0;cursor:pointer;border:2px solid rgba(0,0,0,.15)}
  .switch input:checked{background:var(--gold);border-color:var(--gold)}
  .switch input::after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:left .18s ease}
  .switch input:checked::after{left:22px}

  .chart-wrap{position:relative;height:280px;width:100%}
  .chart-wrap>canvas{display:block;width:100% !important;height:100% !important}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid2 .pair{display:flex;justify-content:space-between;align-items:baseline}
  .grid2 .val{font-weight:900;font-size:20px}

  .drivers{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .drivers .field label{display:block;font-size:12px;color:rgba(0,0,0,.6);margin-bottom:4px}
  @media (prefers-color-scheme:dark){.drivers .field label{color:rgba(255,255,255,.6)}}
  .drivers input{
    width:100%;box-sizing:border-box;border:2px solid var(--ink);border-radius:10px;
    padding:8px 10px;font-weight:800;font-variant-numeric:tabular-nums;
  }

  .table{width:100%;border-collapse:collapse}
  .table th{font-size:12px;text-transform:uppercase;letter-spacing:.06em;text-align:left;color:rgba(0,0,0,.6);padding:8px 0}
  .table td{padding:8px 0;border-top:1px solid rgba(0,0,0,.06);vertical-align:top}
  @media (prefers-color-scheme:dark){
    .table th{color:rgba(255,255,255,.6)}
    .table td{border-top-color:rgba(255,255,255,.12)}
  }

  .section-head{
    display:flex;justify-content:space-between;align-items:baseline;margin-top:18px;
    border-bottom:4px solid var(--gold);padding-bottom:6px
  }
  .total-badge{
    background:var(--salmon);color:#fff;padding:4px 12px;border-radius:999px;
    font-weight:900;font-size:13px
  }

  .pill{display:inline-block;background:#d1fae5;color:#065f46;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
  @media (prefers-color-scheme:dark){.pill{background:rgba(16,185,129,.15);color:#a7f3d0}}

  .tooltip{position:relative;cursor:help;display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:var(--blue);color:#fff;font-size:12px;font-weight:900}
  .tooltip .tip{position:absolute;left:0;bottom:125%;visibility:hidden;opacity:0;transition:opacity .15s ease;width:min(340px,75vw);background:#000;color:#fff;font-size:12px;padding:10px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.35)}
  .tooltip:hover .tip{visibility:visible;opacity:1}
</style>
</head>
<body>

<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
    <div>
      <h1>Queensgate Bouldering • Financial Model</h1>
      <p class="muted">Interactive view for banks and investors. Source: CSV in this folder.</p>
    </div>
    <div class="btnbar" id="scenarioBar" role="tablist" aria-label="Scenarios">
      <button class="btn" data-scenario="Conservative" role="tab" aria-selected="true">Conservative</button>
      <button class="btn" data-scenario="Realistic" role="tab" aria-selected="false">Realistic</button>
      <button class="btn" data-scenario="Optimistic" role="tab" aria-selected="false">Optimistic</button>
      <label class="switch" title="Show Year 1 column when available">
        <input type="checkbox" id="year1Toggle">
        <span>Year 1</span>
      </label>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:16px;padding-bottom:40px">

  <!-- KPIs -->
  <section class="row cols-4">
    <div class="card">
      <div class="kpi mono" id="kpiRevenue">£0</div>
      <div class="kpi-sub" id="kpiRevenueLabel">Annual revenue</div>
    </div>
    <div class="card">
      <div class="kpi mono" id="kpiCosts">£0</div>
      <div class="kpi-sub" id="kpiCostsLabel">Annual operating costs</div>
    </div>
    <div class="card">
      <div class="kpi mono" id="kpiEbitda">£0</div>
      <div class="kpi-sub"><span id="kpiMargin">0%</span> EBITDA margin</div>
    </div>
    <div class="card">
      <div class="kpi mono" id="kpiCapex">£0</div>
      <div class="kpi-sub">Startup capex</div>
    </div>
  </section>

  <!-- Drivers + Chart -->
  <section class="row cols-3" style="margin-top:12px">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:18px;font-weight:800">Monthly break even</h2>
        <span class="pill" id="scenarioTag">Conservative</span>
      </div>
      <p class="muted" style="margin:.5rem 0 0">Based on current drivers for the chosen scenario or Year 1 where provided.</p>
      <div class="grid2" style="margin-top:10px">
        <div class="pair"><span class="muted">Monthly cost to cover</span><span class="mono val" id="beCost">£0</span></div>
        <div class="pair"><span class="muted">Other monthly revenue</span><span class="mono val" id="beOtherRev">£0</span></div>
        <div class="pair" style="grid-column:1/-1"><span class="muted">Members required</span><span class="mono" style="font-size:24px;font-weight:900" id="membersReq">0</span></div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px;font-size:18px;font-weight:800">Revenue drivers</h2>
      <div class="drivers">
        <div class="field">
          <label>Members per month</label>
          <input id="inMembers" type="number" min="0" step="1" inputmode="numeric">
        </div>
        <div class="field">
          <label>Member price</label>
          <input id="inMemberPrice" type="number" min="0" step="1" inputmode="numeric">
        </div>
        <div class="field">
          <label>Day passes per month</label>
          <input id="inDayPasses" type="number" min="0" step="1" inputmode="numeric">
        </div>
        <div class="field">
          <label>Day pass price</label>
          <input id="inDayPassPrice" type="number" min="0" step="1" inputmode="numeric">
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>Other revenue per month</label>
          <input id="inOther" type="number" min="0" step="1" inputmode="numeric">
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="resetDrivers" class="btn" type="button" aria-label="Reset to CSV values">Reset</button>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px;font-size:18px;font-weight:800">Revenue vs costs</h2>
      <div class="chart-wrap">
        <canvas id="revCostChart" aria-label="Revenue vs Costs chart"></canvas>
      </div>
    </div>
  </section>

  <!-- Table -->
  <section class="card" style="margin-top:12px">
    <div class="section-head">
      <h2 style="margin:0;font-size:18px;font-weight:900">Detailed view</h2>
      <div class="total-badge" id="grandTotalBadge">Totals update live</div>
    </div>
    <div id="tableContainer" style="overflow-x:auto"></div>
  </section>

  <section class="card" style="margin-top:12px">
    <h2 style="margin:0 0 6px;font-size:18px;font-weight:900">Notes</h2>
    <p class="muted" style="margin:0">Hover the ⓘ markers to read line notes. Figures load from the CSV and reflect the selected scenario or Year 1 where available.</p>
  </section>

</main>

<script>
  // Path to your CSV next to this HTML
  const CSV_PATH = "./adjusted_queensgate_bouldering_model_v3.csv";

  // Helpers
  const money = n => !isFinite(n) ? "£0" : "£"+ Number(n).toLocaleString("en-GB", {maximumFractionDigits:0});
  const num = v => {
    if (v === null || v === undefined) return 0;
    if (typeof v === "number") return v;
    const clean = String(v).replace(/[£,\s]/g,"");
    const parsed = parseFloat(clean);
    return isNaN(parsed) ? 0 : parsed;
  };

  let rows = [];
  let bySection = {};
  let currentScenario = "Conservative";
  let useYear1 = false;
  let chartInstance = null;

  // Revenue driver overrides
  const driverOverrides = {
    membersPerMonth: null,
    memberPrice: null,
    dayPassesPerMonth: null,
    dayPassPrice: null,
    otherPerMonth: null
  };
  let driverDefaults = {membersPerMonth:0, memberPrice:0, dayPassesPerMonth:0, dayPassPrice:0, otherPerMonth:0};

  function groupRows() {
    bySection = {};
    rows.forEach(r=>{
      const s = (r["SECTION TITLE"] || r["Section"] || "Other") + "";
      if (!bySection[s]) bySection[s] = [];
      bySection[s].push(r);
    });
  }

  function getCellValue(row, scn){
    if (useYear1 && row.hasOwnProperty("Year 1") && row["Year 1"] !== null && row["Year 1"] !== "") {
      return num(row["Year 1"]);
    }
    return num(row[scn]);
  }

  // Revenue driver extraction from "REVENUE" section
  function readRevenueDriversFromCSV(scn){
    const revRows = (bySection["REVENUE"] || bySection["Revenue"] || []);
    const pick = (cands) => {
      const want = cands.map(x => x.toUpperCase());
      const row = revRows.find(r => want.includes(String(r["DESCRIPTION"]||"").toUpperCase()));
      if (!row) return 0;
      return useYear1 && row["Year 1"] ? num(row["Year 1"]) : num(row[scn]);
    };
    return {
      membersPerMonth: pick(["MEMBERS_ MONTHLY","MEMBERS_MONTHLY","MEMBERS PER MONTH","MEMBERS"]),
      memberPrice: pick(["MEMBERS_PRICE","MEMBER PRICE","MEMBERSHIP PRICE"]),
      dayPassesPerMonth: pick(["DAY_PASSES_MONTHLY","DAY PASSES MONTHLY","DAY PASSES"]),
      dayPassPrice: pick(["DAY_PASS_PRICE","DAY PASS PRICE"]),
      otherPerMonth: pick(["OTHER_REV_MONTH","OTHER REVENUE MONTH","OTHER"])
    };
  }

  function getRevenuePieces(scn){
    // defaults from CSV
    const csvVals = readRevenueDriversFromCSV(scn);
    driverDefaults = {...csvVals};

    // choose override or default
    const membersPerMonth = driverOverrides.membersPerMonth ?? csvVals.membersPerMonth;
    const memberPrice     = driverOverrides.memberPrice ?? csvVals.memberPrice;
    const dayPassesPerMonth = driverOverrides.dayPassesPerMonth ?? csvVals.dayPassesPerMonth;
    const dayPassPrice    = driverOverrides.dayPassPrice ?? csvVals.dayPassPrice;
    const otherPerMonth   = driverOverrides.otherPerMonth ?? csvVals.otherPerMonth;

    const monthlyFromMembers = membersPerMonth * memberPrice;
    const monthlyFromDay = dayPassesPerMonth * dayPassPrice;
    const monthlyTotal = monthlyFromMembers + monthlyFromDay + otherPerMonth;

    return {
      membersPerMonth, memberPrice, dayPassesPerMonth, dayPassPrice, otherPerMonth,
      monthlyTotal, annual: monthlyTotal * 12
    };
  }

  function sectionTotal(secName, scn){
    const arr = bySection[secName] || [];
    const isCapex = secName.toUpperCase().includes("CAPITAL EXPENDITURE");
    const isRevenue = secName.toUpperCase().includes("REVENUE");
    if (isRevenue) return getRevenuePieces(scn).annual;
    if (isCapex) return arr.reduce((a,r)=>a+num(r["Year 1"]),0);
    return arr.reduce((a,r)=>a+getCellValue(r, scn),0);
  }

  function totalOperating(scn){
    return Object.keys(bySection).reduce((acc,sec)=>{
      const u = sec.toUpperCase();
      if (u.includes("REVENUE")) return acc;
      if (u.includes("CAPITAL EXPENDITURE")) return acc;
      return acc + sectionTotal(sec, scn);
    },0);
  }

  function totalCapex(){
    return Object.keys(bySection).reduce((acc,sec)=>{
      if (sec.toUpperCase().includes("CAPITAL EXPENDITURE")){
        acc += (bySection[sec]||[]).reduce((a,r)=>a+num(r["Year 1"]),0);
      }
      return acc;
    },0);
  }

  function renderKPIs(){
    const rev = getRevenuePieces(currentScenario);
    const costs = totalOperating(currentScenario);
    const ebitda = rev.annual - costs;
    const margin = rev.annual ? (ebitda / rev.annual) * 100 : 0;

    document.getElementById("kpiRevenue").textContent = money(rev.annual);
    document.getElementById("kpiCosts").textContent = money(costs);
    document.getElementById("kpiEbitda").textContent = money(ebitda);
    document.getElementById("kpiMargin").textContent = margin.toFixed(1) + "%";
    document.getElementById("kpiCapex").textContent = money(totalCapex());

    document.getElementById("kpiRevenueLabel").textContent = useYear1 ? "Year 1 revenue" : "Annual revenue";
    document.getElementById("kpiCostsLabel").textContent = useYear1 ? "Year 1 operating costs" : "Annual operating costs";

    // Break even
    const monthlyCosts = totalOperating(currentScenario)/12;
    const monthlyOtherRevenue = (rev.dayPassesPerMonth*rev.dayPassPrice) + rev.otherPerMonth;
    const needed = Math.max(0, Math.ceil((monthlyCosts - monthlyOtherRevenue) / (rev.memberPrice || 1)));
    document.getElementById("beCost").textContent = money(monthlyCosts);
    document.getElementById("beOtherRev").textContent = money(monthlyOtherRevenue);
    document.getElementById("membersReq").textContent = isFinite(needed) ? needed.toLocaleString("en-GB") : "0";

    // Chart
    const ctx = document.getElementById("revCostChart");
    const data = { labels:["Revenue","Costs"], datasets:[{label:"Annual £", data:[rev.annual, costs], backgroundColor:[getCSS("--blue"), getCSS("--salmon")] }] };
    const opts = {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{display:false}, tooltip:{callbacks:{label:(p)=>money(p.raw)}} },
      scales:{ y:{ ticks:{ callback:v => "£" + Number(v).toLocaleString("en-GB") } } }
    };
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx,{type:"bar",data,options:opts});
    document.getElementById("scenarioTag").textContent = currentScenario;

    // Update driver inputs with current values if no manual editing is in focus
    setDriverInputs();
  }

  function getCSS(varName){
    return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  }

  function renderTable(){
    const container = document.getElementById("tableContainer");
    const secOrder = Object.keys(bySection);
    let grand = 0;

    let html = `
      <table class="table">
        <thead>
          <tr>
            <th style="width:50%">Item</th>
            <th style="width:20%">Unit</th>
            <th style="width:30%">Value</th>
          </tr>
        </thead>
        <tbody>
    `;

    secOrder.forEach(sec=>{
      const isCapex = sec.toUpperCase().includes("CAPITAL EXPENDITURE");
      const isRevenue = sec.toUpperCase().includes("REVENUE");
      const t = sectionTotal(sec, currentScenario);
      if (!isCapex) grand += t;

      html += `
        <tr>
          <td colspan="3">
            <div class="section-head">
              <h3 style="margin:0;font-size:16px;font-weight:900">${sec}</h3>
              <div class="total-badge">${isRevenue ? "Annualised" : isCapex ? "One time" : (useYear1 ? "Year 1" : "Annual")} total: <span class="mono" style="margin-left:6px">${money(t)}</span></div>
            </div>
          </td>
        </tr>
      `;

      (bySection[sec]||[]).forEach(r=>{
        const desc = String(r["DESCRIPTION"]||"");
        const notes = String(r["NOTES"]||"").trim();
        let unit = isRevenue ? "Monthly" : isCapex ? "One time" : (useYear1 ? "Year 1" : "Annual");
        let value = 0;

        if (isRevenue){
          const key = desc.toUpperCase();
          const keys = ["MEMBERS_ MONTHLY","MEMBERS_MONTHLY","MEMBERS PER MONTH","MEMBERS","DAY_PASSES_MONTHLY","DAY PASSES MONTHLY","DAY PASSES","OTHER_REV_MONTH","OTHER","DAY_PASS_PRICE","DAY PASS PRICE","MEMBERS_PRICE","MEMBER PRICE","MEMBERSHIP PRICE"];
          if (keys.includes(key)){
            // show current driver numbers, which may be overridden
            const rev = getRevenuePieces(currentScenario);
            if (/MEMBERS_? ?MONTHLY|MEMBERS PER MONTH|^MEMBERS$/.test(key)) value = rev.membersPerMonth;
            else if (/MEMBERS(_PRICE|HIP PRICE)|MEMBER PRICE/.test(key)) value = rev.memberPrice;
            else if (/DAY_?PASSES/.test(key)) value = rev.dayPassesPerMonth;
            else if (/DAY_?PASS_?PRICE|DAY PASS PRICE/.test(key)) value = rev.dayPassPrice;
            else if (/OTHER/.test(key)) value = rev.otherPerMonth;

            // formatting for drivers
            const isPriceLike = /PRICE/.test(key) || /REV/.test(key);
            const pretty = isPriceLike ? money(value) : Number(value).toLocaleString("en-GB");
            html += rowHTML(desc, unit, pretty, notes);
            return;
          }
          // ignore any other rows under REVENUE
          return;
        } else if (isCapex){
          value = num(r["Year 1"]);
        } else {
          value = getCellValue(r, currentScenario);
        }

        const pretty = money(value);
        html += rowHTML(desc, unit, pretty, notes);
      });
    });

    html += `
        </tbody>
      </table>
    `;

    container.innerHTML = html;
    document.getElementById("grandTotalBadge").textContent = `Operating total: ${money(grand)}`;
  }

  function rowHTML(desc, unit, pretty, notes){
    const safeNotes = notes ? notes.replaceAll("<","&lt;").replaceAll(">","&gt;") : "";
    const tip = notes ? `<span class="tooltip" title="Notes">ⓘ<span class="tip">${safeNotes}</span></span>` : "";
    return `
      <tr>
        <td>
          <div style="display:flex;gap:8px;align-items:flex-start">
            <span class="mono">${desc.replaceAll("_"," ")}</span>${tip}
          </div>
        </td>
        <td class="mono" style="color:rgba(0,0,0,.6)">${unit}</td>
        <td class="mono" style="font-weight:800">${pretty}</td>
      </tr>
    `;
  }

  function recalc(){ renderKPIs(); renderTable(); }

  // Scenario buttons
  document.getElementById("scenarioBar").addEventListener("click", e=>{
    const b = e.target.closest("button[data-scenario]");
    if (!b) return;
    currentScenario = b.dataset.scenario;
    [...document.querySelectorAll("#scenarioBar .btn")].forEach(x=>x.setAttribute("aria-selected", x===b ? "true":"false"));
    recalc();
  });

  // Year 1 toggle
  document.getElementById("year1Toggle").addEventListener("change", e=>{
    useYear1 = e.target.checked;
    recalc();
  });

  // Driver inputs
  ["inMembers","inMemberPrice","inDayPasses","inDayPassPrice","inOther"].forEach(id=>{
    document.getElementById(id).addEventListener("input", onDriverEdit);
  });
  document.getElementById("resetDrivers").addEventListener("click", ()=>{
    Object.keys(driverOverrides).forEach(k=> driverOverrides[k]=null);
    setDriverInputs(true);
    recalc();
  });

  function onDriverEdit(){
    driverOverrides.membersPerMonth = parseFloat(document.getElementById("inMembers").value) || 0;
    driverOverrides.memberPrice = parseFloat(document.getElementById("inMemberPrice").value) || 0;
    driverOverrides.dayPassesPerMonth = parseFloat(document.getElementById("inDayPasses").value) || 0;
    driverOverrides.dayPassPrice = parseFloat(document.getElementById("inDayPassPrice").value) || 0;
    driverOverrides.otherPerMonth = parseFloat(document.getElementById("inOther").value) || 0;
    recalc();
  }

  function setDriverInputs(reset=false){
    const rev = getRevenuePieces(currentScenario);
    const useVal = (k, elId) => {
      const el = document.getElementById(elId);
      if (reset || driverOverrides[k]===null) el.value = rev[k];
    };
    useVal("membersPerMonth","inMembers");
    useVal("memberPrice","inMemberPrice");
    useVal("dayPassesPerMonth","inDayPasses");
    useVal("dayPassPrice","inDayPassPrice");
    useVal("otherPerMonth","inOther");
  }

  // Load CSV
  function loadCSV(){
    Papa.parse(CSV_PATH,{
      download:true, header:true, dynamicTyping:false, skipEmptyLines:true,
      complete:(res)=>{
        rows = res.data.map(r=>{
          Object.keys(r).forEach(k=>{ if(r[k]==="") r[k]=null; });
          return r;
        });
        groupRows();
        // seed inputs once with defaults from CSV
        setDriverInputs(true);
        recalc();
      },
      error:(err)=>{
        document.querySelector("main").innerHTML = `
          <div class="card">
            <h2 style="margin:0 0 8px;font-size:18px;font-weight:900">Could not load CSV</h2>
            <p style="color:#dc2626;margin:0 0 8px">Error: ${err?.message || "Unknown error"}</p>
            <p class="muted" style="margin:0">CSV must be next to this HTML and named <b>adjusted_queensgate_bouldering_model_v3.csv</b>.</p>
          </div>`;
        console.error("CSV load error", err);
      }
    });
  }

  loadCSV();
</script>

</body>
</html>
